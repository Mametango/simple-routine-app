<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚·ãƒ³ãƒ—ãƒ«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ç®¡ç†</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
            min-height: calc(100vh - 40px);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .content {
            padding: 40px 30px;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, textarea, select {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 16px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 28px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-danger {
            background: #dc3545;
        }

        .routine-list {
            margin-top: 20px;
        }

        /* ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚¢ã‚¤ãƒ†ãƒ  */
        .routine-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .routine-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }

        .routine-item.completed {
            border-left: 4px solid #28a745;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.1);
        }

        .routine-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .edit-btn {
            background: #667eea;
            border: none;
            font-size: 0.9em;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
            color: white;
            font-weight: 500;
            min-width: 50px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .edit-btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }

        .routine-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #333;
            position: relative;
            z-index: 1;
        }

        .routine-description {
            color: #6c757d;
            margin-bottom: 15px;
            line-height: 1.5;
            position: relative;
            z-index: 1;
        }

        .routine-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #6c757d;
            position: relative;
            z-index: 1;
        }

        .frequency-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .user-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-align: center;
            border: 2px solid #e9ecef;
        }

        /* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */
        .stats {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        /* ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .routine-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .routine-section h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #333;
            font-size: 1.3em;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            padding: 16px 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            border-left: 4px solid #dc3545;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.1);
        }

        .success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            padding: 16px 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.1);
        }

        .hidden {
            display: none;
        }

        /* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¿½åŠ ãƒœã‚¿ãƒ³ */
        .floating-add-btn {
            position: fixed;
            bottom: 50%;
            right: 50%;
            transform: translate(50%, 50%);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 9999;
            display: none;
        }

        .floating-add-btn:hover {
            transform: translate(50%, 50%) scale(1.15);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 40px;
            border-radius: 24px;
            width: 90%;
            max-width: 500px;
            position: relative;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .close {
            position: absolute;
            right: 25px;
            top: 25px;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close:hover {
            color: #333;
            background: #f8f9fa;
        }

        /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤º */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* æ›œæ—¥é¸æŠã‚¹ã‚¿ã‚¤ãƒ« */
        .day-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .day-checkbox {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 600;
        }

        .day-checkbox:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .day-checkbox input[type="checkbox"] {
            margin-right: 6px;
            width: auto;
            padding: 0;
        }

        .day-checkbox input[type="checkbox"]:checked + span {
            color: #667eea;
        }

        .day-checkbox.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        /* æ¯å¹´é¸æŠã‚¹ã‚¿ã‚¤ãƒ« */
        .yearly-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* ã‚«ã‚¹ã‚¿ãƒ é »åº¦ã‚¹ã‚¿ã‚¤ãƒ« */
        .custom-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .custom-selector .form-group:last-child {
            grid-column: 1 / -1;
        }

        /* èªè¨¼ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .auth-container h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .auth-subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .auth-form {
            text-align: left;
        }

        .auth-form .form-group {
            margin-bottom: 20px;
        }

        .auth-form label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .auth-form input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .auth-form input:focus {
            outline: none;
            border-color: #007bff;
        }

        .auth-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 10px;
        }

        .auth-button:hover {
            transform: translateY(-2px);
        }

        .auth-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
        }

        .auth-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .auth-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .auth-help {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9em;
            color: #666;
        }

        .auth-help a {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }

        .auth-help a:hover {
            text-decoration: underline;
        }

        /* ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ³è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆãƒˆãƒƒãƒ—ï¼‰ */
        .top-add-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            border-radius: 50px;
            font-size: 1.3em;
            font-weight: bold;
            padding: 18px 40px;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.18);
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            margin: 0 auto;
        }
        .top-add-btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-2px) scale(1.05);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“… ã‚·ãƒ³ãƒ—ãƒ«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ç®¡ç†</h1>
            <p>æ¯æ—¥ã®ç¿’æ…£ã‚’ç°¡å˜ã«ç®¡ç†</p>
        </div>

        <div class="content">
            <!-- èªè¨¼ç”»é¢ -->
            <div id="authView" class="view active">
                <div class="auth-container">
                    <h1>ğŸ“‹ Simple Routine App</h1>
                    <p class="auth-subtitle">ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ç®¡ç†ã‚¢ãƒ—ãƒª</p>
                    
                    <form id="authForm" class="auth-form">
                        <div class="form-group">
                            <label for="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                            <input type="email" id="email" required placeholder="example@email.com">
                        </div>
                        
                        <div class="form-group">
                            <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                            <input type="password" id="password" required placeholder="6æ–‡å­—ä»¥ä¸Šã€è‹±æ•°å­—ã‚’å«ã‚€">
                        </div>
                        
                        <button type="submit" class="auth-button">æ–°è¦ç™»éŒ² / ãƒ­ã‚°ã‚¤ãƒ³</button>
                    </form>
                    
                    <div id="authMessage" class="auth-message"></div>
                    
                    <div class="auth-help">
                        <p>åˆå›åˆ©ç”¨ã®æ–¹ã¯æ–°è¦ç™»éŒ²ã¨ã—ã¦å‡¦ç†ã•ã‚Œã¾ã™</p>
                        <p>æ—¢å­˜ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã¯è‡ªå‹•çš„ã«ãƒ­ã‚°ã‚¤ãƒ³ã•ã‚Œã¾ã™</p>
                        <p>èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å ´åˆã¯ <a href="debug-firebase.html" target="_blank">ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</a> ã‚’ã”åˆ©ç”¨ãã ã•ã„</p>
                    </div>
                </div>
            </div>

            <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
            <div id="mainView" class="view">
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± -->
                <div class="user-info">
                    <strong id="userEmail"></strong> ã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­
                    <button onclick="logout()" class="btn btn-secondary" style="width: auto; margin-top: 10px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>

                <!-- çµ±è¨ˆæƒ…å ± -->
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="completedToday">0</div>
                        <div class="stat-label">ä»Šæ—¥å®Œäº†</div>
                    </div>
                </div>

                <!-- ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ³è¿½åŠ ãƒœã‚¿ãƒ³ -->
                <div style="display: flex; justify-content: center; margin-bottom: 30px;">
                  <button id="topAddBtn" class="top-add-btn" onclick="openAddModal()">ï¼‹ ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¿½åŠ </button>
                </div>

                <!-- ä»Šæ—¥ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ -->
                <div class="routine-section">
                    <h3>ğŸ“… ä»Šæ—¥ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³</h3>
                    <div id="todayRoutines" class="routine-list"></div>
                </div>

                <!-- ã™ã¹ã¦ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ -->
                <div class="routine-section">
                    <h3>ğŸ“‹ ã™ã¹ã¦ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³</h3>
                    <div id="allRoutines" class="routine-list"></div>
                </div>

                <!-- ç®¡ç†è€…ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒœã‚¿ãƒ³ï¼ˆyasnaries@gmail.comã®ã¿è¡¨ç¤ºï¼‰ -->
                <div id="adminPanel" style="display:none; text-align:center; margin-bottom:20px;">
                  <button class="btn btn-danger" onclick="openUserAdminModal()">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</button>
                </div>

                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
                <div id="userAdminModal" class="modal">
                  <div class="modal-content" style="max-width:600px;">
                    <span class="close" onclick="closeUserAdminModal()">&times;</span>
                    <h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h3>
                    <div id="userList"></div>
                  </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddModal()">&times;</span>
            <h3>æ–°ã—ã„ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’è¿½åŠ </h3>
            <form id="addRoutineForm">
                <div class="form-group">
                    <label for="routineTitle">ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" id="routineTitle" required>
                </div>
                <div class="form-group">
                    <label for="routineDescription">èª¬æ˜ï¼ˆä»»æ„ï¼‰</label>
                    <textarea id="routineDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="routineFrequency">é »åº¦</label>
                    <select id="routineFrequency" required onchange="toggleFrequencyOptions()">
                        <option value="daily">æ¯æ—¥</option>
                        <option value="weekly">æ¯é€±</option>
                        <option value="monthly">æ¯æœˆ</option>
                        <option value="yearly">æ¯å¹´</option>
                        <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
                    </select>
                </div>
                
                <!-- æ¯é€±ã®æ›œæ—¥é¸æŠ -->
                <div id="weeklyOptions" class="form-group" style="display: none;">
                    <label>æ›œæ—¥ã‚’é¸æŠ</label>
                    <div class="day-selector">
                        <label class="day-checkbox">
                            <input type="checkbox" value="0"> æ—¥
                        </label>
                        <label class="day-checkbox">
                            <input type="checkbox" value="1"> æœˆ
                        </label>
                        <label class="day-checkbox">
                            <input type="checkbox" value="2"> ç«
                        </label>
                        <label class="day-checkbox">
                            <input type="checkbox" value="3"> æ°´
                        </label>
                        <label class="day-checkbox">
                            <input type="checkbox" value="4"> æœ¨
                        </label>
                        <label class="day-checkbox">
                            <input type="checkbox" value="5"> é‡‘
                        </label>
                        <label class="day-checkbox">
                            <input type="checkbox" value="6"> åœŸ
                        </label>
                    </div>
                </div>
                
                <!-- æ¯æœˆã®æ—¥ã«ã¡é¸æŠ -->
                <div id="monthlyOptions" class="form-group" style="display: none;">
                    <label for="monthlyDay">æ—¥ã«ã¡ã‚’é¸æŠ</label>
                    <select id="monthlyDay">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="1">1æ—¥</option>
                        <option value="2">2æ—¥</option>
                        <option value="3">3æ—¥</option>
                        <option value="4">4æ—¥</option>
                        <option value="5">5æ—¥</option>
                        <option value="6">6æ—¥</option>
                        <option value="7">7æ—¥</option>
                        <option value="8">8æ—¥</option>
                        <option value="9">9æ—¥</option>
                        <option value="10">10æ—¥</option>
                        <option value="11">11æ—¥</option>
                        <option value="12">12æ—¥</option>
                        <option value="13">13æ—¥</option>
                        <option value="14">14æ—¥</option>
                        <option value="15">15æ—¥</option>
                        <option value="16">16æ—¥</option>
                        <option value="17">17æ—¥</option>
                        <option value="18">18æ—¥</option>
                        <option value="19">19æ—¥</option>
                        <option value="20">20æ—¥</option>
                        <option value="21">21æ—¥</option>
                        <option value="22">22æ—¥</option>
                        <option value="23">23æ—¥</option>
                        <option value="24">24æ—¥</option>
                        <option value="25">25æ—¥</option>
                        <option value="26">26æ—¥</option>
                        <option value="27">27æ—¥</option>
                        <option value="28">28æ—¥</option>
                        <option value="29">29æ—¥</option>
                        <option value="30">30æ—¥</option>
                        <option value="31">31æ—¥</option>
                    </select>
                </div>

                <!-- æ¯å¹´ã®æœˆæ—¥é¸æŠ -->
                <div id="yearlyOptions" class="form-group" style="display: none;">
                    <div class="yearly-selector">
                        <div class="form-group">
                            <label for="yearlyMonth">æœˆã‚’é¸æŠ</label>
                            <select id="yearlyMonth">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="1">1æœˆ</option>
                                <option value="2">2æœˆ</option>
                                <option value="3">3æœˆ</option>
                                <option value="4">4æœˆ</option>
                                <option value="5">5æœˆ</option>
                                <option value="6">6æœˆ</option>
                                <option value="7">7æœˆ</option>
                                <option value="8">8æœˆ</option>
                                <option value="9">9æœˆ</option>
                                <option value="10">10æœˆ</option>
                                <option value="11">11æœˆ</option>
                                <option value="12">12æœˆ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="yearlyDay">æ—¥ã«ã¡ã‚’é¸æŠ</label>
                            <select id="yearlyDay">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="1">1æ—¥</option>
                                <option value="2">2æ—¥</option>
                                <option value="3">3æ—¥</option>
                                <option value="4">4æ—¥</option>
                                <option value="5">5æ—¥</option>
                                <option value="6">6æ—¥</option>
                                <option value="7">7æ—¥</option>
                                <option value="8">8æ—¥</option>
                                <option value="9">9æ—¥</option>
                                <option value="10">10æ—¥</option>
                                <option value="11">11æ—¥</option>
                                <option value="12">12æ—¥</option>
                                <option value="13">13æ—¥</option>
                                <option value="14">14æ—¥</option>
                                <option value="15">15æ—¥</option>
                                <option value="16">16æ—¥</option>
                                <option value="17">17æ—¥</option>
                                <option value="18">18æ—¥</option>
                                <option value="19">19æ—¥</option>
                                <option value="20">20æ—¥</option>
                                <option value="21">21æ—¥</option>
                                <option value="22">22æ—¥</option>
                                <option value="23">23æ—¥</option>
                                <option value="24">24æ—¥</option>
                                <option value="25">25æ—¥</option>
                                <option value="26">26æ—¥</option>
                                <option value="27">27æ—¥</option>
                                <option value="28">28æ—¥</option>
                                <option value="29">29æ—¥</option>
                                <option value="30">30æ—¥</option>
                                <option value="31">31æ—¥</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ã‚«ã‚¹ã‚¿ãƒ é »åº¦è¨­å®š -->
                <div id="customOptions" class="form-group" style="display: none;">
                    <div class="custom-selector">
                        <div class="form-group">
                            <label for="customNumber">æ•°å€¤</label>
                            <input type="number" id="customNumber" min="1" max="365" placeholder="ä¾‹: 3">
                        </div>
                        <div class="form-group">
                            <label for="customInterval">é–“éš”</label>
                            <select id="customInterval">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="days">æ—¥</option>
                                <option value="weeks">é€±</option>
                                <option value="months">æœˆ</option>
                                <option value="years">å¹´</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="customStartDate">é–‹å§‹æ—¥</label>
                            <input type="date" id="customStartDate">
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-success">è¿½åŠ </button>
            </form>
        </div>
    </div>

    <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h3>ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’ç·¨é›†</h3>
            <form id="editRoutineForm">
                <input type="hidden" id="editRoutineId">
                <div class="form-group">
                    <label for="editRoutineTitle">ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" id="editRoutineTitle" required>
                </div>
                <div class="form-group">
                    <label for="editRoutineDescription">èª¬æ˜ï¼ˆä»»æ„ï¼‰</label>
                    <textarea id="editRoutineDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="editRoutineFrequency">é »åº¦</label>
                    <select id="editRoutineFrequency" required onchange="toggleEditFrequencyOptions()">
                        <option value="daily">æ¯æ—¥</option>
                        <option value="weekly">æ¯é€±</option>
                        <option value="monthly">æ¯æœˆ</option>
                        <option value="yearly">æ¯å¹´</option>
                        <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
                    </select>
                </div>
                
                <!-- æ¯é€±ã®æ›œæ—¥é¸æŠï¼ˆç·¨é›†ç”¨ï¼‰ -->
                <div id="editWeeklyOptions" class="form-group" style="display: none;">
                    <label>æ›œæ—¥ã‚’é¸æŠ</label>
                    <div class="day-selector">
                        <label class="day-checkbox">
                            <input type="checkbox" value="0"> æ—¥
                        </label>
                        <label class="day-checkbox">
                            <input type="checkbox" value="1"> æœˆ
                        </label>
                        <label class="day-checkbox">
                            <input type="checkbox" value="2"> ç«
                        </label>
                        <label class="day-checkbox">
                            <input type="checkbox" value="3"> æ°´
                        </label>
                        <label class="day-checkbox">
                            <input type="checkbox" value="4"> æœ¨
                        </label>
                        <label class="day-checkbox">
                            <input type="checkbox" value="5"> é‡‘
                        </label>
                        <label class="day-checkbox">
                            <input type="checkbox" value="6"> åœŸ
                        </label>
                    </div>
                </div>
                
                <!-- æ¯æœˆã®æ—¥ã«ã¡é¸æŠï¼ˆç·¨é›†ç”¨ï¼‰ -->
                <div id="editMonthlyOptions" class="form-group" style="display: none;">
                    <label for="editMonthlyDay">æ—¥ã«ã¡ã‚’é¸æŠ</label>
                    <select id="editMonthlyDay">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="1">1æ—¥</option>
                        <option value="2">2æ—¥</option>
                        <option value="3">3æ—¥</option>
                        <option value="4">4æ—¥</option>
                        <option value="5">5æ—¥</option>
                        <option value="6">6æ—¥</option>
                        <option value="7">7æ—¥</option>
                        <option value="8">8æ—¥</option>
                        <option value="9">9æ—¥</option>
                        <option value="10">10æ—¥</option>
                        <option value="11">11æ—¥</option>
                        <option value="12">12æ—¥</option>
                        <option value="13">13æ—¥</option>
                        <option value="14">14æ—¥</option>
                        <option value="15">15æ—¥</option>
                        <option value="16">16æ—¥</option>
                        <option value="17">17æ—¥</option>
                        <option value="18">18æ—¥</option>
                        <option value="19">19æ—¥</option>
                        <option value="20">20æ—¥</option>
                        <option value="21">21æ—¥</option>
                        <option value="22">22æ—¥</option>
                        <option value="23">23æ—¥</option>
                        <option value="24">24æ—¥</option>
                        <option value="25">25æ—¥</option>
                        <option value="26">26æ—¥</option>
                        <option value="27">27æ—¥</option>
                        <option value="28">28æ—¥</option>
                        <option value="29">29æ—¥</option>
                        <option value="30">30æ—¥</option>
                        <option value="31">31æ—¥</option>
                    </select>
                </div>

                <!-- æ¯å¹´ã®æœˆæ—¥é¸æŠï¼ˆç·¨é›†ç”¨ï¼‰ -->
                <div id="editYearlyOptions" class="form-group" style="display: none;">
                    <div class="yearly-selector">
                        <div class="form-group">
                            <label for="editYearlyMonth">æœˆã‚’é¸æŠ</label>
                            <select id="editYearlyMonth">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="1">1æœˆ</option>
                                <option value="2">2æœˆ</option>
                                <option value="3">3æœˆ</option>
                                <option value="4">4æœˆ</option>
                                <option value="5">5æœˆ</option>
                                <option value="6">6æœˆ</option>
                                <option value="7">7æœˆ</option>
                                <option value="8">8æœˆ</option>
                                <option value="9">9æœˆ</option>
                                <option value="10">10æœˆ</option>
                                <option value="11">11æœˆ</option>
                                <option value="12">12æœˆ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editYearlyDay">æ—¥ã«ã¡ã‚’é¸æŠ</label>
                            <select id="editYearlyDay">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="1">1æ—¥</option>
                                <option value="2">2æ—¥</option>
                                <option value="3">3æ—¥</option>
                                <option value="4">4æ—¥</option>
                                <option value="5">5æ—¥</option>
                                <option value="6">6æ—¥</option>
                                <option value="7">7æ—¥</option>
                                <option value="8">8æ—¥</option>
                                <option value="9">9æ—¥</option>
                                <option value="10">10æ—¥</option>
                                <option value="11">11æ—¥</option>
                                <option value="12">12æ—¥</option>
                                <option value="13">13æ—¥</option>
                                <option value="14">14æ—¥</option>
                                <option value="15">15æ—¥</option>
                                <option value="16">16æ—¥</option>
                                <option value="17">17æ—¥</option>
                                <option value="18">18æ—¥</option>
                                <option value="19">19æ—¥</option>
                                <option value="20">20æ—¥</option>
                                <option value="21">21æ—¥</option>
                                <option value="22">22æ—¥</option>
                                <option value="23">23æ—¥</option>
                                <option value="24">24æ—¥</option>
                                <option value="25">25æ—¥</option>
                                <option value="26">26æ—¥</option>
                                <option value="27">27æ—¥</option>
                                <option value="28">28æ—¥</option>
                                <option value="29">29æ—¥</option>
                                <option value="30">30æ—¥</option>
                                <option value="31">31æ—¥</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ã‚«ã‚¹ã‚¿ãƒ é »åº¦è¨­å®šï¼ˆç·¨é›†ç”¨ï¼‰ -->
                <div id="editCustomOptions" class="form-group" style="display: none;">
                    <div class="custom-selector">
                        <div class="form-group">
                            <label for="editCustomNumber">æ•°å€¤</label>
                            <input type="number" id="editCustomNumber" min="1" max="365" placeholder="ä¾‹: 3">
                        </div>
                        <div class="form-group">
                            <label for="editCustomInterval">é–“éš”</label>
                            <select id="editCustomInterval">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="days">æ—¥</option>
                                <option value="weeks">é€±</option>
                                <option value="months">æœˆ</option>
                                <option value="years">å¹´</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editCustomStartDate">é–‹å§‹æ—¥</label>
                            <input type="date" id="editCustomStartDate">
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-success">æ›´æ–°</button>
            </form>
        </div>
    </div>

    <script>
        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyBmkRs7f2a6ejf-qXJZ2F-jMWGnAGdvY0Q",
            authDomain: "simple-routine-app-33cfc.firebaseapp.com",
            projectId: "simple-routine-app-33cfc",
            storageBucket: "simple-routine-app-33cfc.firebasestorage.app",
            messagingSenderId: "124814607687",
            appId: "1:124814607687:web:d1b703506cad3ecbaa7862",
            measurementId: "G-57M4VBMXZM"
        };

        // FirebaseåˆæœŸåŒ–
        try {
            console.log('FirebaseåˆæœŸåŒ–é–‹å§‹...');
            console.log('è¨­å®šå€¤ç¢ºèª:', {
                apiKey: firebaseConfig.apiKey ? 'è¨­å®šæ¸ˆã¿' : 'æœªè¨­å®š',
                authDomain: firebaseConfig.authDomain,
                projectId: firebaseConfig.projectId,
                storageBucket: firebaseConfig.storageBucket,
                messagingSenderId: firebaseConfig.messagingSenderId,
                appId: firebaseConfig.appId,
                measurementId: firebaseConfig.measurementId
            });
            
            firebase.initializeApp(firebaseConfig);
            console.log('âœ… FirebaseåˆæœŸåŒ–æˆåŠŸ');
            console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID:', firebaseConfig.projectId);
            
            // åˆæœŸåŒ–å¾Œã®ç¢ºèª
            console.log('Firebase Apps:', firebase.apps.length);
            console.log('Firebase Auth:', firebase.auth ? 'åˆ©ç”¨å¯èƒ½' : 'åˆ©ç”¨ä¸å¯');
            console.log('Firebase Firestore:', firebase.firestore ? 'åˆ©ç”¨å¯èƒ½' : 'åˆ©ç”¨ä¸å¯');
            
        } catch (error) {
            console.error('âŒ FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
                message: error.message,
                code: error.code,
                stack: error.stack
            });
        }
        
        let auth = firebase.auth();
        let db = firebase.firestore();

        // Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆ
        auth.onAuthStateChanged(function(user) {
            console.log('Firebaseèªè¨¼çŠ¶æ…‹:', user ? 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­' : 'æœªãƒ­ã‚°ã‚¤ãƒ³');
        });

        // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ç”¨ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        const SecurityUtils = {
            // ç°¡å˜ãªãƒãƒƒã‚·ãƒ¥é–¢æ•°ï¼ˆå®Ÿéš›ã®ã‚¢ãƒ—ãƒªã§ã¯bcryptç­‰ã‚’ä½¿ç”¨ï¼‰
            hashPassword: function(password) {
                let hash = 0;
                if (password.length === 0) return hash.toString();
                for (let i = 0; i < password.length; i++) {
                    const char = password.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // 32bitæ•´æ•°ã«å¤‰æ›
                }
                return hash.toString();
            },

            // XSSå¯¾ç­–ï¼šHTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
            escapeHtml: function(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            // å…¥åŠ›æ¤œè¨¼
            validateEmail: function(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            },

            validatePassword: function(password) {
                // æœ€ä½6æ–‡å­—ã€è‹±æ•°å­—ã‚’å«ã‚€
                return password.length >= 6 && /[a-zA-Z]/.test(password) && /[0-9]/.test(password);
            },

            validateInput: function(input, maxLength = 100) {
                // ç‰¹æ®Šæ–‡å­—ã®é™¤å»ã¨é•·ã•åˆ¶é™
                return input.replace(/[<>]/g, '').substring(0, maxLength);
            },

            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
            generateSessionToken: function() {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            },

            // ãƒ‡ãƒ¼ã‚¿ã®æš—å·åŒ–ï¼ˆç°¡å˜ãªå®Ÿè£…ï¼‰
            encryptData: function(data) {
                try {
                    return btoa(JSON.stringify(data));
                } catch (e) {
                    console.error('æš—å·åŒ–ã‚¨ãƒ©ãƒ¼:', e);
                    return null;
                }
            },

            // ãƒ‡ãƒ¼ã‚¿ã®å¾©å·åŒ–
            decryptData: function(encryptedData) {
                try {
                    return JSON.parse(atob(encryptedData));
                } catch (e) {
                    console.error('å¾©å·åŒ–ã‚¨ãƒ©ãƒ¼:', e);
                    return null;
                }
            }
        };

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentUser = null;
        let routines = [];
        let completions = [];
        let sessionToken = null;

        // åˆæœŸåŒ–å‡¦ç†
        async function initializeApp() {
            try {
                console.log('ã‚¢ãƒ—ãƒªåˆæœŸåŒ–é–‹å§‹');
                
                // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç›£è¦–ã‚’è¨­å®š
                setupNetworkMonitoring();
                
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ï¼‰
                const appVersion = '1.0.1'; // åŒæœŸå•é¡Œä¿®æ­£ç‰ˆ
                console.log('ã‚¢ãƒ—ãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³:', appVersion);
                
                // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¿½åŠ ãƒœã‚¿ãƒ³ã®åˆæœŸè¡¨ç¤ºçŠ¶æ…‹ã‚’è¨­å®š
                const floatingAddBtn = document.getElementById('floatingAddBtn');
                if (floatingAddBtn) {
                    floatingAddBtn.style.display = 'none'; // åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º
                }
                
                // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
                auth.onAuthStateChanged(async function(user) {
                    console.log('èªè¨¼çŠ¶æ…‹å¤‰æ›´:', user ? 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­' : 'æœªãƒ­ã‚°ã‚¤ãƒ³');
                    if (user) {
                        console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±:', {
                            uid: user.uid,
                            email: user.email,
                            emailVerified: user.emailVerified
                        });
                        currentUser = user;
                        
                        // æ—¢å­˜ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢
                        if (window.currentRealtimeListener) {
                            window.currentRealtimeListener();
                            window.currentRealtimeListener = null;
                        }
                        
                        showSyncStatus('syncing');
                        
                        try {
                            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚’å®Ÿè¡Œ
                            await loadUserData();
                            showMainView();
                            showSyncStatus('synced');
                            console.log('âœ… èªè¨¼å¾Œã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†');
                        } catch (error) {
                            console.error('âŒ èªè¨¼å¾Œã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                            showSyncStatus('error');
                            showMessage('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                        }
                    } else {
                        console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼æœªèªè¨¼');
                        currentUser = null;
                        
                        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢
                        if (window.currentRealtimeListener) {
                            window.currentRealtimeListener();
                            window.currentRealtimeListener = null;
                        }
                        
                        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                        routines = [];
                        completions = [];
                        updateDisplay();
                        
                        showSyncStatus('error');
                        showAuthView();
                    }
                });
                
                console.log('âœ… ã‚¢ãƒ—ãƒªåˆæœŸåŒ–å®Œäº†');
                
            } catch (error) {
                console.error('ã‚¢ãƒ—ãƒªåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹:', currentUser.uid);
                
                // åˆå›èª­ã¿è¾¼ã¿ã‚’å®Ÿè¡Œ
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    console.log('åˆå›ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿:', userData);
                    
                    const newRoutines = userData.routines || [];
                    const newCompletions = userData.completions || [];
                    
                    // FieldValue.serverTimestamp()ã‚’é™¤å»ã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ãªãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
                    const cleanRoutines = newRoutines.map(routine => {
                        const cleanRoutine = { ...routine };
                        
                        // createdAtãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºå®Ÿã«ISOæ–‡å­—åˆ—ã«å¤‰æ›
                        if (cleanRoutine.createdAt) {
                            if (typeof cleanRoutine.createdAt === 'object' && cleanRoutine.createdAt.toDate) {
                                // Firestore Timestampã®å ´åˆ
                                cleanRoutine.createdAt = cleanRoutine.createdAt.toDate().toISOString();
                            } else if (typeof cleanRoutine.createdAt === 'string') {
                                // æ—¢ã«æ–‡å­—åˆ—ã®å ´åˆ
                                cleanRoutine.createdAt = cleanRoutine.createdAt;
                            } else {
                                // ãã®ä»–ã®å ´åˆ
                                cleanRoutine.createdAt = new Date().toISOString();
                            }
                        } else {
                            cleanRoutine.createdAt = new Date().toISOString();
                        }
                        
                        // FieldValue.serverTimestamp()ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯é™¤å»
                        if (cleanRoutine.createdAt && typeof cleanRoutine.createdAt === 'object' && cleanRoutine.createdAt._methodName === 'serverTimestamp') {
                            cleanRoutine.createdAt = new Date().toISOString();
                        }
                        
                        return cleanRoutine;
                    });
                    
                    const cleanCompletions = newCompletions.map(completion => {
                        const cleanCompletion = { ...completion };
                        
                        // completedAtãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºå®Ÿã«ISOæ–‡å­—åˆ—ã«å¤‰æ›
                        if (cleanCompletion.completedAt) {
                            if (typeof cleanCompletion.completedAt === 'object' && cleanCompletion.completedAt.toDate) {
                                // Firestore Timestampã®å ´åˆ
                                cleanCompletion.completedAt = cleanCompletion.completedAt.toDate().toISOString();
                            } else if (typeof cleanCompletion.completedAt === 'string') {
                                // æ—¢ã«æ–‡å­—åˆ—ã®å ´åˆ
                                cleanCompletion.completedAt = cleanCompletion.completedAt;
                            } else {
                                // ãã®ä»–ã®å ´åˆ
                                cleanCompletion.completedAt = new Date().toISOString();
                            }
                        } else {
                            cleanCompletion.completedAt = new Date().toISOString();
                        }
                        
                        // FieldValue.serverTimestamp()ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯é™¤å»
                        if (cleanCompletion.completedAt && typeof cleanCompletion.completedAt === 'object' && cleanCompletion.completedAt._methodName === 'serverTimestamp') {
                            cleanCompletion.completedAt = new Date().toISOString();
                        }
                        
                        return cleanCompletion;
                    });
                    
                    routines = cleanRoutines;
                    completions = cleanCompletions;
                    
                    updateDisplay();
                    showSyncStatus('synced');
                    console.log('åˆå›ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', {
                        routinesCount: routines.length,
                        completionsCount: completions.length
                    });
                    
                    // åˆå›èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                    setTimeout(() => {
                        if (currentUser) {
                            console.log('åˆå›èª­ã¿è¾¼ã¿å®Œäº†å¾Œã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š');
                            setupRealtimeListener();
                        }
                    }, 500);
                    
                } else {
                    console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„ãŸã‚åˆæœŸåŒ–ã—ã¾ã™');
                    await initializeUserData();
                    
                    // åˆæœŸåŒ–å®Œäº†å¾Œã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                    setTimeout(() => {
                        if (currentUser) {
                            console.log('åˆæœŸåŒ–å®Œäº†å¾Œã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š');
                            setupRealtimeListener();
                        }
                    }, 500);
                }
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showSyncStatus('error');
                showMessage('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯èª­ã¿è¾¼ã¿
                loadUserDataFallback();
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯èª­ã¿è¾¼ã¿ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ãŒå¤±æ•—ã—ãŸå ´åˆï¼‰
        async function loadUserDataFallback() {
            if (!currentUser) return;
            
            try {
                console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯èª­ã¿è¾¼ã¿é–‹å§‹');
                
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    const newRoutines = userData.routines || [];
                    const newCompletions = userData.completions || [];
                    
                    // FieldValue.serverTimestamp()ã‚’é™¤å»ã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ãªãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
                    const cleanRoutines = newRoutines.map(routine => {
                        const cleanRoutine = { ...routine };
                        
                        // createdAtãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºå®Ÿã«ISOæ–‡å­—åˆ—ã«å¤‰æ›
                        if (cleanRoutine.createdAt) {
                            if (typeof cleanRoutine.createdAt === 'object' && cleanRoutine.createdAt.toDate) {
                                // Firestore Timestampã®å ´åˆ
                                cleanRoutine.createdAt = cleanRoutine.createdAt.toDate().toISOString();
                            } else if (typeof cleanRoutine.createdAt === 'string') {
                                // æ—¢ã«æ–‡å­—åˆ—ã®å ´åˆ
                                cleanRoutine.createdAt = cleanRoutine.createdAt;
                            } else {
                                // ãã®ä»–ã®å ´åˆ
                                cleanRoutine.createdAt = new Date().toISOString();
                            }
                        } else {
                            cleanRoutine.createdAt = new Date().toISOString();
                        }
                        
                        // FieldValue.serverTimestamp()ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯é™¤å»
                        if (cleanRoutine.createdAt && typeof cleanRoutine.createdAt === 'object' && cleanRoutine.createdAt._methodName === 'serverTimestamp') {
                            cleanRoutine.createdAt = new Date().toISOString();
                        }
                        
                        return cleanRoutine;
                    });
                    
                    const cleanCompletions = newCompletions.map(completion => {
                        const cleanCompletion = { ...completion };
                        
                        // completedAtãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºå®Ÿã«ISOæ–‡å­—åˆ—ã«å¤‰æ›
                        if (cleanCompletion.completedAt) {
                            if (typeof cleanCompletion.completedAt === 'object' && cleanCompletion.completedAt.toDate) {
                                // Firestore Timestampã®å ´åˆ
                                cleanCompletion.completedAt = cleanCompletion.completedAt.toDate().toISOString();
                            } else if (typeof cleanCompletion.completedAt === 'string') {
                                // æ—¢ã«æ–‡å­—åˆ—ã®å ´åˆ
                                cleanCompletion.completedAt = cleanCompletion.completedAt;
                            } else {
                                // ãã®ä»–ã®å ´åˆ
                                cleanCompletion.completedAt = new Date().toISOString();
                            }
                        } else {
                            cleanCompletion.completedAt = new Date().toISOString();
                        }
                        
                        // FieldValue.serverTimestamp()ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯é™¤å»
                        if (cleanCompletion.completedAt && typeof cleanCompletion.completedAt === 'object' && cleanCompletion.completedAt._methodName === 'serverTimestamp') {
                            cleanCompletion.completedAt = new Date().toISOString();
                        }
                        
                        return cleanCompletion;
                    });
                    
                    routines = cleanRoutines;
                    completions = cleanCompletions;
                    
                    updateDisplay();
                    showMessage('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
                    console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯èª­ã¿è¾¼ã¿æˆåŠŸ:', {
                        routinesCount: routines.length,
                        completionsCount: completions.length
                    });
                } else {
                    console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„ãŸã‚åˆæœŸåŒ–ã—ã¾ã™');
                    initializeUserData();
                }
            } catch (error) {
                console.error('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ç›£è¦–
        function setupNetworkMonitoring() {
            window.addEventListener('online', () => {
                console.log('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šå¾©æ—§');
                showMessage('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãŒå¾©æ—§ã—ã¾ã—ãŸ', 'success');
                showSyncStatus('syncing');
                
                // æ¥ç¶šå¾©æ—§æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å†åŒæœŸ
                if (currentUser) {
                    setTimeout(async () => {
                        try {
                            console.log('æ¥ç¶šå¾©æ—§æ™‚ã®ãƒ‡ãƒ¼ã‚¿åŒæœŸé–‹å§‹');
                            await loadUserData();
                            showSyncStatus('synced');
                            showMessage('ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
                        } catch (error) {
                            console.error('æ¥ç¶šå¾©æ—§æ™‚ã®åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                            showSyncStatus('error');
                            showMessage('åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                        }
                    }, 2000); // 2ç§’å¾…ã£ã¦ã‹ã‚‰åŒæœŸ
                }
            });
            
            window.addEventListener('offline', () => {
                console.log('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šåˆ‡æ–­');
                showMessage('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã§ã™', 'warning');
                showSyncStatus('error');
            });
            
            // åˆæœŸçŠ¶æ…‹ã®ç¢ºèª
            if (!navigator.onLine) {
                console.log('åˆæœŸçŠ¶æ…‹: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³');
                showSyncStatus('error');
            } else {
                console.log('åˆæœŸçŠ¶æ…‹: ã‚ªãƒ³ãƒ©ã‚¤ãƒ³');
                showSyncStatus('synced');
            }
        }

        // èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        function checkAuth() {
            console.log('èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯é–‹å§‹...');
            console.log('Firebaseè¨­å®šç¢ºèª:', {
                authDomain: firebaseConfig.authDomain,
                projectId: firebaseConfig.projectId,
                apiKey: firebaseConfig.apiKey ? 'è¨­å®šæ¸ˆã¿' : 'æœªè¨­å®š'
            });
            
            auth.onAuthStateChanged(async function(user) {
                console.log('èªè¨¼çŠ¶æ…‹å¤‰æ›´:', user ? 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­' : 'æœªãƒ­ã‚°ã‚¤ãƒ³');
                if (user) {
                    console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±:', {
                        uid: user.uid,
                        email: user.email,
                        emailVerified: user.emailVerified
                    });
                    currentUser = user;
                    showSyncStatus('syncing');
                    await loadUserData();
                    showMainView();
                    showSyncStatus('synced');
                } else {
                    console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼æœªèªè¨¼');
                    currentUser = null;
                    routines = [];
                    completions = [];
                    showSyncStatus('error');
                    showAuthView();
                }
            });
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        function setupEventListeners() {
            // èªè¨¼ãƒ•ã‚©ãƒ¼ãƒ 
            document.getElementById('authForm').addEventListener('submit', handleAuth);
            
            // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ 
            document.getElementById('addRoutineForm').addEventListener('submit', handleAddRoutine);
            
            // æ›œæ—¥é¸æŠã®è¨­å®š
            setupDayCheckboxes();
        }

        // Firebaseèªè¨¼å‡¦ç†
        async function handleAuth(event) {
            event.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const messageDiv = document.getElementById('authMessage');

            console.log('èªè¨¼è©¦è¡Œ:', { email, passwordLength: password.length });

            // å…¥åŠ›æ¤œè¨¼
            if (!SecurityUtils.validateEmail(email)) {
                showMessage('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (!SecurityUtils.validatePassword(password)) {
                showMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§è‹±æ•°å­—ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™', 'error');
                return;
            }

            try {
                console.log('Firebase Authè¨­å®šç¢ºèª:', {
                    authDomain: firebaseConfig.authDomain,
                    projectId: firebaseConfig.projectId,
                    apiKey: firebaseConfig.apiKey ? 'è¨­å®šæ¸ˆã¿' : 'æœªè¨­å®š'
                });
                
                // ã¾ãšæ–°è¦ç™»éŒ²ã‚’è©¦è¡Œ
                console.log('æ–°è¦ç™»éŒ²è©¦è¡Œä¸­...');
                console.log('æ–°è¦ç™»éŒ²è¨­å®šç¢ºèª:', {
                    authDomain: firebaseConfig.authDomain,
                    projectId: firebaseConfig.projectId
                });
                
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                console.log('âœ… æ–°è¦ç™»éŒ²æˆåŠŸ:', currentUser.email);
                showMessage('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ', 'success');
                await initializeUserData();
                showMainView();
                
            } catch (error) {
                console.error('âŒ æ–°è¦ç™»éŒ²ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
                    code: error.code,
                    message: error.message,
                    email: email,
                    authDomain: firebaseConfig.authDomain,
                    projectId: firebaseConfig.projectId
                });
                
                if (error.code === 'auth/email-already-in-use') {
                    // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ã‚’è©¦è¡Œ
                    try {
                        console.log('æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œå‡ºã€ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œä¸­...');
                        const userCredential = await auth.signInWithEmailAndPassword(email, password);
                        currentUser = userCredential.user;
                        console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', currentUser.email);
                        showMessage('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ', 'success');
                        await loadUserData();
                        showMainView();
                    } catch (loginError) {
                        console.error('âŒ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
                            code: loginError.code,
                            message: loginError.message,
                            email: email
                        });
                        
                        if (loginError.code === 'auth/wrong-password') {
                            showMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™', 'error');
                        } else if (loginError.code === 'auth/invalid-credential') {
                            showMessage('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“', 'error');
                        } else {
                            showMessage('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + loginError.message, 'error');
                        }
                    }
                } else if (error.code === 'auth/configuration-not-found') {
                    showMessage('Firebaseè¨­å®šã‚¨ãƒ©ãƒ¼: Authenticationè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚è©³ç´°ã¯ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚', 'error');
                } else if (error.code === 'auth/weak-password') {
                    showMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¼±ã™ãã¾ã™ã€‚6æ–‡å­—ä»¥ä¸Šã§è‹±æ•°å­—ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™', 'error');
                } else if (error.code === 'auth/invalid-email') {
                    showMessage('ç„¡åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™', 'error');
                } else {
                    showMessage('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                }
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
        async function initializeUserData() {
            if (!currentUser) return;
            
            try {
                await db.collection('users').doc(currentUser.uid).set({
                    email: currentUser.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    routines: [],
                    completions: []
                });
                
                routines = [];
                completions = [];
                updateDisplay();
            } catch (error) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
        async function saveData() {
            if (!currentUser) {
                console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            try {
                console.log('=== ãƒ‡ãƒ¼ã‚¿ä¿å­˜é–‹å§‹ ===');
                console.log('ä¿å­˜ãƒ‡ãƒ¼ã‚¿:', {
                    routinesCount: routines.length,
                    completionsCount: completions.length,
                    userId: currentUser.uid,
                    timestamp: new Date().toISOString()
                });
                
                // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®ç¢ºèª
                if (!navigator.onLine) {
                    console.warn('âš ï¸ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®ãŸã‚ã€ä¿å­˜ã‚’å»¶æœŸã—ã¾ã™');
                    showMessage('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã§ã™ã€‚æ¥ç¶šå¾©æ—§å¾Œã«ä¿å­˜ã•ã‚Œã¾ã™', 'warning');
                    return;
                }
                
                // é…åˆ—å†…ã®FieldValue.serverTimestamp()ã‚’å®Œå…¨ã«é™¤å»ã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ãªãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
                const cleanRoutines = routines.map(routine => {
                    const cleanRoutine = { ...routine };
                    
                    // createdAtãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºå®Ÿã«ISOæ–‡å­—åˆ—ã«å¤‰æ›
                    if (cleanRoutine.createdAt) {
                        if (typeof cleanRoutine.createdAt === 'object' && cleanRoutine.createdAt.toDate) {
                            // Firestore Timestampã®å ´åˆ
                            cleanRoutine.createdAt = cleanRoutine.createdAt.toDate().toISOString();
                        } else if (typeof cleanRoutine.createdAt === 'string') {
                            // æ—¢ã«æ–‡å­—åˆ—ã®å ´åˆ
                            cleanRoutine.createdAt = cleanRoutine.createdAt;
                        } else {
                            // ãã®ä»–ã®å ´åˆ
                            cleanRoutine.createdAt = new Date().toISOString();
                        }
                    } else {
                        cleanRoutine.createdAt = new Date().toISOString();
                    }
                    
                    // FieldValue.serverTimestamp()ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯é™¤å»
                    if (cleanRoutine.createdAt && typeof cleanRoutine.createdAt === 'object' && cleanRoutine.createdAt._methodName === 'serverTimestamp') {
                        cleanRoutine.createdAt = new Date().toISOString();
                    }
                    
                    return cleanRoutine;
                });
                
                const cleanCompletions = completions.map(completion => {
                    const cleanCompletion = { ...completion };
                    
                    // completedAtãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºå®Ÿã«ISOæ–‡å­—åˆ—ã«å¤‰æ›
                    if (cleanCompletion.completedAt) {
                        if (typeof cleanCompletion.completedAt === 'object' && cleanCompletion.completedAt.toDate) {
                            // Firestore Timestampã®å ´åˆ
                            cleanCompletion.completedAt = cleanCompletion.completedAt.toDate().toISOString();
                        } else if (typeof cleanCompletion.completedAt === 'string') {
                            // æ—¢ã«æ–‡å­—åˆ—ã®å ´åˆ
                            cleanCompletion.completedAt = cleanCompletion.completedAt;
                        } else {
                            // ãã®ä»–ã®å ´åˆ
                            cleanCompletion.completedAt = new Date().toISOString();
                        }
                    } else {
                        cleanCompletion.completedAt = new Date().toISOString();
                    }
                    
                    // FieldValue.serverTimestamp()ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯é™¤å»
                    if (cleanCompletion.completedAt && typeof cleanCompletion.completedAt === 'object' && cleanCompletion.completedAt._methodName === 'serverTimestamp') {
                        cleanCompletion.completedAt = new Date().toISOString();
                    }
                    
                    return cleanCompletion;
                });
                
                console.log('ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¾Œã®ãƒ‡ãƒ¼ã‚¿:', {
                    routinesCount: cleanRoutines.length,
                    completionsCount: cleanCompletions.length,
                    sampleRoutine: cleanRoutines[0],
                    sampleCompletion: cleanCompletions[0]
                });
                
                console.log('Firestoreã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ä¸­...');
                
                // åŒæœŸçŠ¶æ…‹ã‚’è¡¨ç¤º
                showSyncStatus('syncing');
                
                // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’å«ã‚ã¦ä¿å­˜
                const saveData = {
                    routines: cleanRoutines,
                    completions: cleanCompletions,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastSyncDevice: navigator.userAgent,
                    lastSyncTimestamp: new Date().toISOString(),
                    deviceId: getDeviceId(),
                    syncVersion: '1.0.2' // åŒæœŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†
                };
                
                await db.collection('users').doc(currentUser.uid).set(saveData, { merge: true });
                
                console.log('âœ… ãƒ‡ãƒ¼ã‚¿ä¿å­˜æˆåŠŸ');
                showSyncStatus('synced');
                showMessage('ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ', 'success');
                
                // ä¿å­˜æˆåŠŸå¾Œã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š
                setTimeout(() => {
                    if (currentUser) {
                        console.log('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š');
                        setupRealtimeListener();
                    }
                }, 1000);
                
            } catch (error) {
                console.error('âŒ ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showSyncStatus('error');
                showMessage('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                
                // ä¿å­˜ã«å¤±æ•—ã—ãŸå ´åˆã¯å†è©¦è¡Œï¼ˆæœ€å¤§3å›ï¼‰
                if (!window.saveRetryCount) {
                    window.saveRetryCount = 0;
                }
                
                if (window.saveRetryCount < 3) {
                    window.saveRetryCount++;
                    console.log(`ğŸ”„ ãƒ‡ãƒ¼ã‚¿ä¿å­˜å†è©¦è¡Œä¸­... (${window.saveRetryCount}/3)`);
                    
                    setTimeout(() => {
                        saveData();
                    }, 2000 * window.saveRetryCount); // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•
                } else {
                    console.error('âŒ ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã®å†è©¦è¡Œå›æ•°ä¸Šé™ã«é”ã—ã¾ã—ãŸ');
                    window.saveRetryCount = 0;
                    showMessage('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å¾Œã§ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„', 'error');
                }
            }
        }

        // ãƒ‡ãƒã‚¤ã‚¹IDã‚’ç”Ÿæˆï¼ˆåŒæœŸã®ç«¶åˆè§£æ±ºç”¨ï¼‰
        function getDeviceId() {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        }

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        function setupRealtimeListener() {
            if (!currentUser || !db) return;
            
            try {
                console.log('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼è¨­å®šé–‹å§‹');
                
                // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢
                if (window.currentRealtimeListener) {
                    window.currentRealtimeListener();
                }
                
                const userDocRef = db.collection('users').doc(currentUser.uid);
                
                // åˆå›èª­ã¿è¾¼ã¿ãƒ•ãƒ©ã‚°
                let isInitialLoad = true;
                
                window.currentRealtimeListener = userDocRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        console.log('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚’å—ä¿¡:', {
                            routinesCount: userData.routines?.length || 0,
                            completionsCount: userData.completions?.length || 0,
                            lastSyncDevice: userData.lastSyncDevice,
                            lastSyncTimestamp: userData.lastSyncTimestamp,
                            deviceId: userData.deviceId,
                            isInitialLoad: isInitialLoad
                        });
                        
                        // åˆå›èª­ã¿è¾¼ã¿æ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆloadUserDataã§æ—¢ã«å‡¦ç†æ¸ˆã¿ï¼‰
                        if (isInitialLoad) {
                            console.log('åˆå›èª­ã¿è¾¼ã¿ã®ãŸã‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—');
                            isInitialLoad = false;
                            return;
                        }
                        
                        // è‡ªåˆ†ãŒä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                        if (userData.deviceId === getDeviceId()) {
                            console.log('è‡ªåˆ†ã®ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã®æ›´æ–°ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
                            return;
                        }
                        
                        // ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
                        const newRoutines = userData.routines || [];
                        const newCompletions = userData.completions || [];
                        
                        // FieldValue.serverTimestamp()ã‚’é™¤å»ã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ãªãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
                        const cleanRoutines = newRoutines.map(routine => {
                            const cleanRoutine = { ...routine };
                            
                            // createdAtãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºå®Ÿã«ISOæ–‡å­—åˆ—ã«å¤‰æ›
                            if (cleanRoutine.createdAt) {
                                if (typeof cleanRoutine.createdAt === 'object' && cleanRoutine.createdAt.toDate) {
                                    // Firestore Timestampã®å ´åˆ
                                    cleanRoutine.createdAt = cleanRoutine.createdAt.toDate().toISOString();
                                } else if (typeof cleanRoutine.createdAt === 'string') {
                                    // æ—¢ã«æ–‡å­—åˆ—ã®å ´åˆ
                                    cleanRoutine.createdAt = cleanRoutine.createdAt;
                                } else {
                                    // ãã®ä»–ã®å ´åˆ
                                    cleanRoutine.createdAt = new Date().toISOString();
                                }
                            } else {
                                cleanRoutine.createdAt = new Date().toISOString();
                            }
                            
                            // FieldValue.serverTimestamp()ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯é™¤å»
                            if (cleanRoutine.createdAt && typeof cleanRoutine.createdAt === 'object' && cleanRoutine.createdAt._methodName === 'serverTimestamp') {
                                cleanRoutine.createdAt = new Date().toISOString();
                            }
                            
                            return cleanRoutine;
                        });
                        
                        const cleanCompletions = newCompletions.map(completion => {
                            const cleanCompletion = { ...completion };
                            
                            // completedAtãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºå®Ÿã«ISOæ–‡å­—åˆ—ã«å¤‰æ›
                            if (cleanCompletion.completedAt) {
                                if (typeof cleanCompletion.completedAt === 'object' && cleanCompletion.completedAt.toDate) {
                                    // Firestore Timestampã®å ´åˆ
                                    cleanCompletion.completedAt = cleanCompletion.completedAt.toDate().toISOString();
                                } else if (typeof cleanCompletion.completedAt === 'string') {
                                    // æ—¢ã«æ–‡å­—åˆ—ã®å ´åˆ
                                    cleanCompletion.completedAt = cleanCompletion.completedAt;
                                } else {
                                    // ãã®ä»–ã®å ´åˆ
                                    cleanCompletion.completedAt = new Date().toISOString();
                                }
                            } else {
                                cleanCompletion.completedAt = new Date().toISOString();
                            }
                            
                            // FieldValue.serverTimestamp()ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯é™¤å»
                            if (cleanCompletion.completedAt && typeof cleanCompletion.completedAt === 'object' && cleanCompletion.completedAt._methodName === 'serverTimestamp') {
                                cleanCompletion.completedAt = new Date().toISOString();
                            }
                            
                            return cleanCompletion;
                        });
                        
                        // ãƒ‡ãƒ¼ã‚¿ãŒå®Ÿéš›ã«å¤‰æ›´ã•ã‚ŒãŸå ´åˆã®ã¿æ›´æ–°
                        const routinesChanged = JSON.stringify(routines) !== JSON.stringify(cleanRoutines);
                        const completionsChanged = JSON.stringify(completions) !== JSON.stringify(cleanCompletions);
                        
                        if (routinesChanged || completionsChanged) {
                            routines = cleanRoutines;
                            completions = cleanCompletions;
                            
                            updateDisplay();
                            showSyncStatus('synced');
                            showMessage('ãƒ‡ãƒ¼ã‚¿ãŒåŒæœŸã•ã‚Œã¾ã—ãŸ', 'success');
                            console.log('ãƒ‡ãƒ¼ã‚¿åŒæœŸå®Œäº†:', {
                                routinesCount: routines.length,
                                completionsCount: completions.length,
                                timestamp: new Date().toISOString()
                            });
                        }
                    } else {
                        console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„ãŸã‚åˆæœŸåŒ–ã—ã¾ã™');
                        initializeUserData();
                    }
                }, (error) => {
                    console.error('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
                    showSyncStatus('error');
                    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯é€šå¸¸ã®èª­ã¿è¾¼ã¿ã‚’è©¦è¡Œ
                    loadUserDataFallback();
                });
                
                console.log('âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');
                
            } catch (error) {
                console.error('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
                showSyncStatus('error');
            }
        }

        // åŒæœŸçŠ¶æ…‹ã®è¡¨ç¤º
        function showSyncStatus(status = 'synced') {
            const syncIndicator = document.getElementById('syncIndicator');
            if (!syncIndicator) {
                // åŒæœŸçŠ¶æ…‹è¡¨ç¤ºè¦ç´ ã‚’ä½œæˆ
                const indicator = document.createElement('div');
                indicator.id = 'syncIndicator';
                indicator.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    padding: 8px 12px;
                    border-radius: 20px;
                    font-size: 12px;
                    font-weight: bold;
                    z-index: 1000;
                    transition: all 0.3s ease;
                `;
                document.body.appendChild(indicator);
            }
            
            const indicator = document.getElementById('syncIndicator');
            
            switch (status) {
                case 'syncing':
                    indicator.textContent = 'ğŸ”„ åŒæœŸä¸­...';
                    indicator.style.backgroundColor = '#ffc107';
                    indicator.style.color = '#000';
                    break;
                case 'synced':
                    indicator.textContent = 'âœ… åŒæœŸæ¸ˆã¿';
                    indicator.style.backgroundColor = '#28a745';
                    indicator.style.color = '#fff';
                    break;
                case 'error':
                    indicator.textContent = 'âŒ åŒæœŸã‚¨ãƒ©ãƒ¼';
                    indicator.style.backgroundColor = '#dc3545';
                    indicator.style.color = '#fff';
                    break;
                default:
                    indicator.style.display = 'none';
            }
        }

        // é »åº¦é¸æŠã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleFrequencyOptions() {
            const frequency = document.getElementById('routineFrequency').value;
            const weeklyOptions = document.getElementById('weeklyOptions');
            const monthlyOptions = document.getElementById('monthlyOptions');
            const yearlyOptions = document.getElementById('yearlyOptions');
            const customOptions = document.getElementById('customOptions');
            const monthlyDaySelect = document.getElementById('monthlyDay');
            const yearlyMonthSelect = document.getElementById('yearlyMonth');
            const yearlyDaySelect = document.getElementById('yearlyDay');
            const customIntervalSelect = document.getElementById('customInterval');
            const customNumberInput = document.getElementById('customNumber');
            const customStartDateInput = document.getElementById('customStartDate');
            
            // ã™ã¹ã¦ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
            weeklyOptions.style.display = 'none';
            monthlyOptions.style.display = 'none';
            yearlyOptions.style.display = 'none';
            customOptions.style.display = 'none';
            
            // å¿…é ˆå±æ€§ã‚’ãƒªã‚»ãƒƒãƒˆ
            monthlyDaySelect.required = false;
            yearlyMonthSelect.required = false;
            yearlyDaySelect.required = false;
            customIntervalSelect.required = false;
            customNumberInput.required = false;
            customStartDateInput.required = false;
            
            // é¸æŠã•ã‚ŒãŸé »åº¦ã«å¿œã˜ã¦ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            if (frequency === 'weekly') {
                weeklyOptions.style.display = 'block';
            } else if (frequency === 'monthly') {
                monthlyOptions.style.display = 'block';
                monthlyDaySelect.required = true;
            } else if (frequency === 'yearly') {
                yearlyOptions.style.display = 'block';
                yearlyMonthSelect.required = true;
                yearlyDaySelect.required = true;
            } else if (frequency === 'custom') {
                customOptions.style.display = 'block';
                customIntervalSelect.required = true;
                customNumberInput.required = true;
                customStartDateInput.required = true;
            }
        }

        // æ›œæ—¥é¸æŠã®å‡¦ç†
        function setupDayCheckboxes() {
            const checkboxes = document.querySelectorAll('.day-checkbox input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const label = this.parentElement;
                    if (this.checked) {
                        label.classList.add('selected');
                    } else {
                        label.classList.remove('selected');
                    }
                });
            });
        }

        // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¿½åŠ 
        async function handleAddRoutine(event) {
            event.preventDefault();
            
            console.log('=== ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¿½åŠ å‡¦ç†é–‹å§‹ ===');
            
            const title = SecurityUtils.validateInput(document.getElementById('routineTitle').value, 50);
            const description = SecurityUtils.validateInput(document.getElementById('routineDescription').value, 200);
            const frequency = document.getElementById('routineFrequency').value;

            console.log('å…¥åŠ›å€¤ç¢ºèª:', {
                title: title,
                description: description,
                frequency: frequency,
                titleLength: title ? title.length : 0,
                descriptionLength: description ? description.length : 0
            });

            if (!title) {
                console.error('âŒ ã‚¿ã‚¤ãƒˆãƒ«ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                showMessage('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            console.log('âœ… ã‚¿ã‚¤ãƒˆãƒ«æ¤œè¨¼é€šé');

            // é »åº¦åˆ¥ã®è©³ç´°è¨­å®šã‚’å–å¾—
            let frequencyDetails = {};
            
            if (frequency === 'daily') {
                console.log('æ¯æ—¥ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã®å‡¦ç†');
                frequencyDetails = {};
            } else if (frequency === 'weekly') {
                console.log('æ¯é€±ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã®å‡¦ç†');
                const selectedDays = Array.from(document.querySelectorAll('.day-checkbox input[type="checkbox"]:checked'))
                    .map(cb => parseInt(cb.value));
                if (selectedDays.length === 0) {
                    console.error('âŒ æ›œæ—¥ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    showMessage('æ›œæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                    return;
                }
                frequencyDetails = { selectedDays: selectedDays };
                console.log('é¸æŠã•ã‚ŒãŸæ›œæ—¥:', selectedDays);
            } else if (frequency === 'monthly') {
                console.log('æ¯æœˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã®å‡¦ç†');
                const monthlyDay = document.getElementById('monthlyDay').value;
                if (!monthlyDay) {
                    console.error('âŒ æ—¥ã«ã¡ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    showMessage('æ—¥ã«ã¡ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                    return;
                }
                frequencyDetails = { selectedDay: parseInt(monthlyDay) };
                console.log('é¸æŠã•ã‚ŒãŸæ—¥ã«ã¡:', monthlyDay);
            } else if (frequency === 'yearly') {
                console.log('æ¯å¹´ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã®å‡¦ç†');
                const yearlyMonth = document.getElementById('yearlyMonth').value;
                const yearlyDay = document.getElementById('yearlyDay').value;
                if (!yearlyMonth || !yearlyDay) {
                    console.error('âŒ æœˆã¾ãŸã¯æ—¥ã«ã¡ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    showMessage('æœˆã¨æ—¥ã«ã¡ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                    return;
                }
                frequencyDetails = { selectedMonth: parseInt(yearlyMonth), selectedDay: parseInt(yearlyDay) };
                console.log('é¸æŠã•ã‚ŒãŸæœˆæ—¥:', { month: yearlyMonth, day: yearlyDay });
            } else if (frequency === 'custom') {
                console.log('ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã®å‡¦ç†');
                const customInterval = document.getElementById('customInterval').value;
                const customNumber = document.getElementById('customNumber').value;
                const customStartDate = document.getElementById('customStartDate').value;
                if (!customInterval || !customNumber || !customStartDate) {
                    console.error('âŒ ã‚«ã‚¹ã‚¿ãƒ è¨­å®šãŒä¸å®Œå…¨ã§ã™');
                    showMessage('ã™ã¹ã¦ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                    return;
                }
                frequencyDetails = {
                    interval: customInterval,
                    number: parseInt(customNumber),
                    startDate: customStartDate
                };
                console.log('ã‚«ã‚¹ã‚¿ãƒ è¨­å®š:', frequencyDetails);
            }

            console.log('âœ… é »åº¦è©³ç´°è¨­å®šå®Œäº†:', frequencyDetails);

            const newRoutine = {
                id: Date.now().toString(),
                title: title,
                description: description,
                frequency: frequency,
                frequencyDetails: frequencyDetails,
                createdAt: new Date().toISOString(), // FieldValue.serverTimestamp()ã®ä»£ã‚ã‚Šã«ISOæ–‡å­—åˆ—ã‚’ä½¿ç”¨
                userId: currentUser.uid
            };

            console.log('âœ… æ–°ã—ã„ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ:', newRoutine);

            try {
                showSyncStatus('syncing');
                console.log('ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³é…åˆ—ã«è¿½åŠ å‰ã®ä»¶æ•°:', routines.length);
                
                routines.push(newRoutine);
                console.log('ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³é…åˆ—ã«è¿½åŠ å¾Œã®ä»¶æ•°:', routines.length);
                
                console.log('ãƒ‡ãƒ¼ã‚¿ä¿å­˜é–‹å§‹');
                await saveData();
                console.log('âœ… ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†');
                
                console.log('è¡¨ç¤ºæ›´æ–°é–‹å§‹');
                updateDisplay();
                console.log('âœ… è¡¨ç¤ºæ›´æ–°å®Œäº†');
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                closeAddModal();
                showMessage('ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
                showSyncStatus('synced');
                
                console.log('=== ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¿½åŠ å‡¦ç†å®Œäº† ===');
                
            } catch (error) {
                console.error('âŒ ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¿½åŠ å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:', error);
                showMessage('ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                showSyncStatus('error');
            }
        }

        // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³å®Œäº†åˆ‡ã‚Šæ›¿ãˆ
        async function toggleRoutine(routineId) {
            const today = new Date().toDateString();
            const completionKey = `${routineId}_${today}`;
            
            const existingIndex = completions.findIndex(c => c.id === completionKey);
            
            showSyncStatus('syncing');
            
            if (existingIndex >= 0) {
                completions.splice(existingIndex, 1);
            } else {
                completions.push({
                    id: completionKey,
                    routineId: routineId,
                    completedAt: new Date().toISOString(), // FieldValue.serverTimestamp()ã®ä»£ã‚ã‚Šã«ISOæ–‡å­—åˆ—ã‚’ä½¿ç”¨
                    userId: currentUser.uid
                });
            }
            
            await saveData();
            updateDisplay();
            showSyncStatus('synced');
        }

        // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³å‰Šé™¤
        async function deleteRoutine(routineId) {
            if (confirm('ã“ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                showSyncStatus('syncing');
                routines = routines.filter(r => r.id !== routineId);
                completions = completions.filter(c => c.routineId !== routineId);
                await saveData();
                updateDisplay();
                showMessage('ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                showSyncStatus('synced');
            }
        }

        // è¡¨ç¤ºæ›´æ–°
        function updateDisplay() {
            if (!currentUser) {
                console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ã•ã‚Œã¦ã„ãªã„ãŸã‚è¡¨ç¤ºæ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—');
                return;
            }

            console.log('=== è¡¨ç¤ºæ›´æ–°é–‹å§‹ ===');
            console.log('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿:', {
                routinesCount: routines.length,
                completionsCount: completions.length,
                userId: currentUser.uid
            });

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
            document.getElementById('userEmail').textContent = SecurityUtils.escapeHtml(currentUser.email);

            // çµ±è¨ˆæƒ…å ±
            const today = new Date().toDateString();
            const todayCompletions = completions.filter(c => {
                const completionDate = new Date(c.completedAt?.toDate?.() || c.completedAt).toDateString();
                return completionDate === today;
            });
            document.getElementById('completedToday').textContent = todayCompletions.length;

            console.log('çµ±è¨ˆæƒ…å ±æ›´æ–°å®Œäº†:', {
                completedToday: todayCompletions.length
            });

            // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¡¨ç¤º
            console.log('ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¡¨ç¤ºé–‹å§‹');
            displayRoutines();
            console.log('âœ… ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¡¨ç¤ºå®Œäº†');
            
            // åŒæœŸçŠ¶æ…‹ã‚’è¡¨ç¤º
            showSyncStatus('synced');
            console.log('=== è¡¨ç¤ºæ›´æ–°å®Œäº† ===');
        }

        // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¡¨ç¤º
        function displayRoutines() {
            console.log('=== ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¡¨ç¤ºé–‹å§‹ ===');
            console.log('displayRoutinesé–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ');
            console.log('routinesé…åˆ—ã®é•·ã•:', routines.length);
            console.log('routinesé…åˆ—ã®å†…å®¹:', routines);
            
            const today = new Date().toDateString();
            const currentDayOfWeek = new Date().getDay();
            const currentDayOfMonth = new Date().getDate();
            const currentMonth = new Date().getMonth() + 1;
            const currentDate = new Date();
            
            console.log('ç¾åœ¨ã®æ—¥ä»˜æƒ…å ±:', {
                today: today,
                currentDayOfWeek: currentDayOfWeek,
                currentDayOfMonth: currentDayOfMonth,
                currentMonth: currentMonth
            });
            
            // ä»Šæ—¥ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³
            const todayRoutines = routines.filter(routine => {
                console.log(`ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã€Œ${routine.title}ã€ã®é »åº¦ãƒã‚§ãƒƒã‚¯:`, {
                    frequency: routine.frequency,
                    frequencyDetails: routine.frequencyDetails
                });
                
                if (routine.frequency === 'daily') {
                    console.log(`âœ… æ¯æ—¥ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã€Œ${routine.title}ã€ã‚’ä»Šæ—¥ã®ãƒªã‚¹ãƒˆã«è¿½åŠ `);
                    return true;
                }
                
                if (routine.frequency === 'weekly') {
                    if (routine.frequencyDetails && routine.frequencyDetails.selectedDays) {
                        const isToday = routine.frequencyDetails.selectedDays.includes(currentDayOfWeek);
                        console.log(`æ¯é€±ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã€Œ${routine.title}ã€: ${isToday ? 'ä»Šæ—¥å®Ÿè¡Œ' : 'ä»Šæ—¥ã¯å®Ÿè¡Œã—ãªã„'}`);
                        return isToday;
                    }
                    console.log(`âŒ æ¯é€±ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã€Œ${routine.title}ã€ã®è©³ç´°è¨­å®šãŒä¸æ­£`);
                    return false;
                }
                
                if (routine.frequency === 'monthly') {
                    if (routine.frequencyDetails && routine.frequencyDetails.selectedDay) {
                        const isToday = routine.frequencyDetails.selectedDay === currentDayOfMonth;
                        console.log(`æ¯æœˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã€Œ${routine.title}ã€: ${isToday ? 'ä»Šæ—¥å®Ÿè¡Œ' : 'ä»Šæ—¥ã¯å®Ÿè¡Œã—ãªã„'}`);
                        return isToday;
                    }
                    console.log(`âŒ æ¯æœˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã€Œ${routine.title}ã€ã®è©³ç´°è¨­å®šãŒä¸æ­£`);
                    return false;
                }

                if (routine.frequency === 'yearly') {
                    if (routine.frequencyDetails && routine.frequencyDetails.selectedMonth && routine.frequencyDetails.selectedDay) {
                        const isToday = routine.frequencyDetails.selectedMonth === currentMonth && 
                                       routine.frequencyDetails.selectedDay === currentDayOfMonth;
                        console.log(`æ¯å¹´ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã€Œ${routine.title}ã€: ${isToday ? 'ä»Šæ—¥å®Ÿè¡Œ' : 'ä»Šæ—¥ã¯å®Ÿè¡Œã—ãªã„'}`);
                        return isToday;
                    }
                    console.log(`âŒ æ¯å¹´ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã€Œ${routine.title}ã€ã®è©³ç´°è¨­å®šãŒä¸æ­£`);
                    return false;
                }

                if (routine.frequency === 'custom') {
                    if (routine.frequencyDetails && routine.frequencyDetails.startDate && 
                        routine.frequencyDetails.interval && routine.frequencyDetails.number) {
                        const isDue = isCustomRoutineDue(routine.frequencyDetails, currentDate);
                        console.log(`ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã€Œ${routine.title}ã€: ${isDue ? 'ä»Šæ—¥å®Ÿè¡Œ' : 'ä»Šæ—¥ã¯å®Ÿè¡Œã—ãªã„'}`);
                        return isDue;
                    }
                    console.log(`âŒ ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã€Œ${routine.title}ã€ã®è©³ç´°è¨­å®šãŒä¸æ­£`);
                    return false;
                }
                
                console.log(`âŒ ä¸æ˜ãªé »åº¦ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã€Œ${routine.title}ã€: ${routine.frequency}`);
                return false;
            });

            console.log('ä»Šæ—¥ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³æ•°:', todayRoutines.length);
            console.log('ä»Šæ—¥ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³:', todayRoutines.map(r => r.title));

            console.log('createRoutineHTMLã‚’å‘¼ã³å‡ºã™å‰');
            const todayHTML = createRoutineHTML(todayRoutines, today);
            const allHTML = createRoutineHTML(routines, today);
            console.log('createRoutineHTMLå‘¼ã³å‡ºã—å®Œäº†');
            
            console.log('todayRoutinesè¦ç´ ã®å­˜åœ¨ç¢ºèª:', !!document.getElementById('todayRoutines'));
            console.log('allRoutinesè¦ç´ ã®å­˜åœ¨ç¢ºèª:', !!document.getElementById('allRoutines'));
            
            document.getElementById('todayRoutines').innerHTML = todayHTML;
            document.getElementById('allRoutines').innerHTML = allHTML;
            
            console.log('=== ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¡¨ç¤ºå®Œäº† ===');
        }

        // ã‚«ã‚¹ã‚¿ãƒ é »åº¦ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãŒä»Šæ—¥å®Ÿè¡Œã™ã¹ãã‹ãƒã‚§ãƒƒã‚¯
        function isCustomRoutineDue(frequencyDetails, currentDate) {
            const startDate = new Date(frequencyDetails.startDate);
            const interval = frequencyDetails.interval;
            const number = frequencyDetails.number;
            
            // é–‹å§‹æ—¥ã‚ˆã‚Šå‰ã®å ´åˆã¯å®Ÿè¡Œã—ãªã„
            if (currentDate < startDate) return false;
            
            let diffTime, diffDays;
            
            switch (interval) {
                case 'days':
                    diffTime = currentDate - startDate;
                    diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    return diffDays % number === 0;
                    
                case 'weeks':
                    diffTime = currentDate - startDate;
                    diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    return diffDays % (number * 7) === 0;
                    
                case 'months':
                    const yearDiff = currentDate.getFullYear() - startDate.getFullYear();
                    const monthDiff = currentDate.getMonth() - startDate.getMonth();
                    const totalMonths = yearDiff * 12 + monthDiff;
                    return totalMonths % number === 0 && currentDate.getDate() === startDate.getDate();
                    
                case 'years':
                    const yearDiff2 = currentDate.getFullYear() - startDate.getFullYear();
                    return yearDiff2 % number === 0 && 
                           currentDate.getMonth() === startDate.getMonth() && 
                           currentDate.getDate() === startDate.getDate();
                    
                default:
                    return false;
            }
        }

        // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³HTMLç”Ÿæˆ
        function createRoutineHTML(routineList, today) {
            if (routineList.length === 0) {
                return '<p style="text-align: center; color: #6c757d; padding: 20px;">ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            }

            return routineList.map(routine => {
                const isCompleted = completions.some(c => {
                    const completionDate = new Date(c.completedAt?.toDate?.() || c.completedAt).toDateString();
                    return c.routineId === routine.id && completionDate === today;
                });

                let frequencyText = '';
                if (routine.frequency === 'daily') {
                    frequencyText = 'æ¯æ—¥';
                } else if (routine.frequency === 'weekly') {
                    if (routine.frequencyDetails && routine.frequencyDetails.selectedDays) {
                        const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
                        const selectedDayNames = routine.frequencyDetails.selectedDays.map(day => dayNames[day]);
                        frequencyText = `æ¯é€± ${selectedDayNames.join('ãƒ»')}`;
                    } else {
                        frequencyText = 'æ¯é€±';
                    }
                } else if (routine.frequency === 'monthly') {
                    if (routine.frequencyDetails && routine.frequencyDetails.selectedDay) {
                        frequencyText = `æ¯æœˆ${routine.frequencyDetails.selectedDay}æ—¥`;
                    } else {
                        frequencyText = 'æ¯æœˆ';
                    }
                } else if (routine.frequency === 'yearly') {
                    if (routine.frequencyDetails && routine.frequencyDetails.selectedMonth && routine.frequencyDetails.selectedDay) {
                        frequencyText = `æ¯å¹´${routine.frequencyDetails.selectedMonth}æœˆ${routine.frequencyDetails.selectedDay}æ—¥`;
                    } else {
                        frequencyText = 'æ¯å¹´';
                    }
                } else if (routine.frequency === 'custom') {
                    if (routine.frequencyDetails && routine.frequencyDetails.interval && routine.frequencyDetails.number) {
                        const intervalText = {
                            'days': 'æ—¥',
                            'weeks': 'é€±',
                            'months': 'æœˆ',
                            'years': 'å¹´'
                        }[routine.frequencyDetails.interval];
                        frequencyText = `${routine.frequencyDetails.number}${intervalText}ãŠã`;
                    } else {
                        frequencyText = 'ã‚«ã‚¹ã‚¿ãƒ ';
                    }
                }

                // XSSå¯¾ç­–ï¼šHTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
                const safeTitle = SecurityUtils.escapeHtml(routine.title);
                const safeDescription = routine.description ? SecurityUtils.escapeHtml(routine.description) : '';

                return `
                    <div class="routine-item ${isCompleted ? 'completed' : ''}">
                        <div class="routine-header">
                            <div class="routine-title">${safeTitle}</div>
                            <button onclick="editRoutine('${routine.id}')" class="edit-btn" title="ç·¨é›†">ç·¨é›†</button>
                        </div>
                        ${safeDescription ? `<div class="routine-description">${safeDescription}</div>` : ''}
                        <div class="routine-meta">
                            <span class="frequency-badge">${frequencyText}</span>
                            <div>
                                <button onclick="toggleRoutine('${routine.id}')" class="btn ${isCompleted ? 'btn-secondary' : 'btn-success'}" style="width: auto; margin-right: 10px;">
                                    ${isCompleted ? 'å®Œäº†å–ã‚Šæ¶ˆã—' : 'å®Œäº†'}
                                </button>
                                <button onclick="deleteRoutine('${routine.id}')" class="btn btn-danger" style="width: auto;">å‰Šé™¤</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
        function openAddModal() {
            document.getElementById('addModal').style.display = 'block';
            document.getElementById('addRoutineForm').reset();
            // é »åº¦ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã‚’å¿…ãšè¡Œã†
            toggleFrequencyOptions();
        }

        function closeAddModal() {
            document.getElementById('addModal').style.display = 'none';
            document.getElementById('floatingAddBtn').style.display = 'block';
            document.getElementById('addRoutineForm').reset();
            
            // é »åº¦ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('weeklyOptions').style.display = 'none';
            document.getElementById('monthlyOptions').style.display = 'none';
            document.getElementById('yearlyOptions').style.display = 'none';
            document.getElementById('customOptions').style.display = 'none';
            
            // å¿…é ˆå±æ€§ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('monthlyDay').required = false;
            document.getElementById('yearlyMonth').required = false;
            document.getElementById('yearlyDay').required = false;
            document.getElementById('customInterval').required = false;
            document.getElementById('customNumber').required = false;
            document.getElementById('customStartDate').required = false;
            
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.day-checkbox').forEach(label => {
                label.classList.remove('selected');
            });
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        window.onclick = function(event) {
            const addModal = document.getElementById('addModal');
            const editModal = document.getElementById('editModal');
            if (event.target === addModal) {
                closeAddModal();
            }
            if (event.target === editModal) {
                closeEditModal();
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        async function logout() {
            try {
                await auth.signOut();
                currentUser = null;
                routines = [];
                completions = [];
                showAuthView();
                showMessage('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'success');
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ¡ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        function showMainView() {
            document.getElementById('authView').classList.remove('active');
            document.getElementById('mainView').classList.add('active');
            
            // ç®¡ç†è€…ãƒ‘ãƒãƒ«è¡¨ç¤º
            const adminPanel = document.getElementById('adminPanel');
            if (currentUser && currentUser.email === 'yasnaries@gmail.com') {
                adminPanel.style.display = 'block';
            } else {
                adminPanel.style.display = 'none';
            }
            
            // åŒæœŸãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            addSyncButton();
            
            // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆé–‹ç™ºç”¨ï¼‰
            addResetButton();
        }

        // åŒæœŸãƒœã‚¿ãƒ³ã®è¿½åŠ 
        function addSyncButton() {
            const mainView = document.getElementById('mainView');
            if (mainView && !document.getElementById('manualSyncBtn')) {
                const syncBtn = document.createElement('button');
                syncBtn.id = 'manualSyncBtn';
                syncBtn.textContent = 'ğŸ”„ æ‰‹å‹•åŒæœŸ';
                syncBtn.className = 'btn btn-secondary';
                syncBtn.style.marginTop = '10px';
                syncBtn.style.marginRight = '10px';
                syncBtn.onclick = async () => {
                    if (!currentUser) {
                        showMessage('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™', 'error');
                        return;
                    }
                    
                    syncBtn.disabled = true;
                    syncBtn.textContent = 'ğŸ”„ åŒæœŸä¸­...';
                    
                    try {
                        console.log('æ‰‹å‹•åŒæœŸé–‹å§‹');
                        showSyncStatus('syncing');
                        
                        // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                        await saveData();
                        
                        // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                        await loadUserData();
                        
                        showSyncStatus('synced');
                        showMessage('æ‰‹å‹•åŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
                        console.log('æ‰‹å‹•åŒæœŸå®Œäº†');
                        
                    } catch (error) {
                        console.error('æ‰‹å‹•åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                        showSyncStatus('error');
                        showMessage('æ‰‹å‹•åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    } finally {
                        syncBtn.disabled = false;
                        syncBtn.textContent = 'ğŸ”„ æ‰‹å‹•åŒæœŸ';
                    }
                };
                mainView.appendChild(syncBtn);
            }
        }

        // èªè¨¼ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        function showAuthView() {
            document.getElementById('mainView').classList.remove('active');
            document.getElementById('authView').classList.add('active');
            document.getElementById('floatingAddBtn').style.display = 'none';
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showMessage(message, type) {
            let messageDiv = document.getElementById('authMessage');
            if (!messageDiv) {
                // ãƒ¡ã‚¤ãƒ³ç”»é¢ç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã‚’ä½œæˆ
                messageDiv = document.createElement('div');
                messageDiv.id = 'mainMessage';
                messageDiv.style.position = 'fixed';
                messageDiv.style.top = '20px';
                messageDiv.style.left = '50%';
                messageDiv.style.transform = 'translateX(-50%)';
                messageDiv.style.zIndex = '3000';
                document.body.appendChild(messageDiv);
            }
            
            messageDiv.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 3000);
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // å¼·åˆ¶çš„ã«requiredå±æ€§ã‚’å‰Šé™¤
            removeRequiredAttributes();
            
            initializeApp();
            setupEventListeners();
        });

        // requiredå±æ€§ã‚’å¼·åˆ¶çš„ã«å‰Šé™¤
        function removeRequiredAttributes() {
            const elementsToRemoveRequired = [
                'monthlyDay',
                'yearlyMonth', 
                'yearlyDay',
                'customNumber',
                'customInterval',
                'customStartDate'
            ];
            
            elementsToRemoveRequired.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.removeAttribute('required');
                    console.log(`âœ… ${id}ã®requiredå±æ€§ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
                }
            });
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ï¼ˆFieldValue.serverTimestamp()å•é¡Œã®è§£æ±ºç”¨ï¼‰
        async function resetUserData() {
            if (!currentUser) return;
            
            try {
                console.log('=== ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆé–‹å§‹ ===');
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                routines = [];
                completions = [];
                
                // Firestoreã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
                await db.collection('users').doc(currentUser.uid).set({
                    email: currentUser.email,
                    routines: [],
                    completions: [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastSyncDevice: navigator.userAgent,
                    lastSyncTimestamp: new Date().toISOString()
                });
                
                console.log('âœ… ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆå®Œäº†');
                showMessage('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'success');
                
                // è¡¨ç¤ºã‚’æ›´æ–°
                updateDisplay();
                
            } catch (error) {
                console.error('âŒ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®è¿½åŠ ï¼ˆé–‹ç™ºç”¨ï¼‰
        function addResetButton() {
            const mainView = document.getElementById('mainView');
            if (mainView && !document.getElementById('resetDataBtn')) {
                const resetBtn = document.createElement('button');
                resetBtn.id = 'resetDataBtn';
                resetBtn.textContent = 'ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ';
                resetBtn.className = 'btn btn-danger';
                resetBtn.style.marginTop = '10px';
                resetBtn.onclick = () => {
                    if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                        resetUserData();
                    }
                };
                mainView.appendChild(resetBtn);
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆæ™‚ã«ã‚‚å¿…ãšå‘¼ã¶
        document.getElementById('addRoutineForm').addEventListener('reset', function() {
            setTimeout(toggleFrequencyOptions, 0);
        });

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤º
        function openUserAdminModal() {
            document.getElementById('userAdminModal').style.display = 'block';
            loadUserList();
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‰ã˜ã‚‹
        function closeUserAdminModal() {
            document.getElementById('userAdminModal').style.display = 'none';
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿
        function loadUserList() {
            db.collection('users').get().then(querySnapshot => {
                const userList = document.getElementById('userList');
                userList.innerHTML = '';
                const ul = document.createElement('ul');
                ul.style.listStyle = 'none';
                ul.style.padding = '0';
                querySnapshot.forEach(doc => {
                    const userData = doc.data();
                    const li = document.createElement('li');
                    li.style.display = 'flex';
                    li.style.justifyContent = 'space-between';
                    li.style.alignItems = 'center';
                    li.style.padding = '8px 0';
                    li.style.borderBottom = '1px solid #eee';
                    li.innerHTML = `<span>${userData.email}</span>`;
                    if (userData.email !== 'yasnaries@gmail.com') {
                        const delBtn = document.createElement('button');
                        delBtn.textContent = 'å‰Šé™¤';
                        delBtn.className = 'btn btn-danger';
                        delBtn.onclick = function() {
                            if (confirm(`${userData.email} ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                                db.collection('users').doc(doc.id).delete().then(() => {
                                    li.remove();
                                });
                            }
                        };
                        li.appendChild(delBtn);
                    }
                    ul.appendChild(li);
                });
                userList.appendChild(ul);
            });
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤º
        function editRoutine(routineId) {
            const routine = routines.find(r => r.id === routineId);
            if (!routine) return;
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã«ç¾åœ¨ã®å€¤ã‚’è¨­å®š
            document.getElementById('editRoutineId').value = routine.id;
            document.getElementById('editRoutineTitle').value = routine.title;
            document.getElementById('editRoutineDescription').value = routine.description || '';
            document.getElementById('editRoutineFrequency').value = routine.frequency;
            
            // é »åº¦ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®è¡¨ç¤º
            toggleEditFrequencyOptions();
            
            // æ—¢å­˜ã®å€¤ã‚’è¨­å®š
            if (routine.frequency === 'weekly' && routine.frequencyDetails?.selectedDays) {
                routine.frequencyDetails.selectedDays.forEach(day => {
                    const checkbox = document.querySelector(`#editWeeklyOptions input[value="${day}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            } else if (routine.frequency === 'monthly' && routine.frequencyDetails?.selectedDay) {
                document.getElementById('editMonthlyDay').value = routine.frequencyDetails.selectedDay;
            } else if (routine.frequency === 'yearly' && routine.frequencyDetails) {
                document.getElementById('editYearlyMonth').value = routine.frequencyDetails.selectedMonth || '';
                document.getElementById('editYearlyDay').value = routine.frequencyDetails.selectedDay || '';
            } else if (routine.frequency === 'custom' && routine.frequencyDetails) {
                document.getElementById('editCustomNumber').value = routine.frequencyDetails.number || '';
                document.getElementById('editCustomInterval').value = routine.frequencyDetails.interval || '';
                document.getElementById('editCustomStartDate').value = routine.frequencyDetails.startDate || '';
            }
            
            document.getElementById('editModal').style.display = 'block';
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‰ã˜ã‚‹
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editRoutineForm').reset();
            
            // é »åº¦ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('editWeeklyOptions').style.display = 'none';
            document.getElementById('editMonthlyOptions').style.display = 'none';
            document.getElementById('editYearlyOptions').style.display = 'none';
            document.getElementById('editCustomOptions').style.display = 'none';
        }

        // ç·¨é›†ç”¨é »åº¦ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleEditFrequencyOptions() {
            const frequency = document.getElementById('editRoutineFrequency').value;
            
            // ã™ã¹ã¦ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
            document.getElementById('editWeeklyOptions').style.display = 'none';
            document.getElementById('editMonthlyOptions').style.display = 'none';
            document.getElementById('editYearlyOptions').style.display = 'none';
            document.getElementById('editCustomOptions').style.display = 'none';
            
            // é¸æŠã•ã‚ŒãŸé »åº¦ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            if (frequency === 'weekly') {
                document.getElementById('editWeeklyOptions').style.display = 'block';
            } else if (frequency === 'monthly') {
                document.getElementById('editMonthlyOptions').style.display = 'block';
            } else if (frequency === 'yearly') {
                document.getElementById('editYearlyOptions').style.display = 'block';
            } else if (frequency === 'custom') {
                document.getElementById('editCustomOptions').style.display = 'block';
            }
        }

        // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡å‡¦ç†
        document.getElementById('editRoutineForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const routineId = document.getElementById('editRoutineId').value;
            const routine = routines.find(r => r.id === routineId);
            if (!routine) return;
            
            const title = document.getElementById('editRoutineTitle').value.trim();
            const description = document.getElementById('editRoutineDescription').value.trim();
            const frequency = document.getElementById('editRoutineFrequency').value;
            
            // é »åº¦è©³ç´°ã®å–å¾—
            let frequencyDetails = null;
            if (frequency === 'weekly') {
                const selectedDays = Array.from(document.querySelectorAll('#editWeeklyOptions input:checked'))
                    .map(cb => parseInt(cb.value));
                if (selectedDays.length > 0) {
                    frequencyDetails = { selectedDays };
                }
            } else if (frequency === 'monthly') {
                const selectedDay = document.getElementById('editMonthlyDay').value;
                if (selectedDay) {
                    frequencyDetails = { selectedDay: parseInt(selectedDay) };
                }
            } else if (frequency === 'yearly') {
                const selectedMonth = document.getElementById('editYearlyMonth').value;
                const selectedDay = document.getElementById('editYearlyDay').value;
                if (selectedMonth && selectedDay) {
                    frequencyDetails = { 
                        selectedMonth: parseInt(selectedMonth), 
                        selectedDay: parseInt(selectedDay) 
                    };
                }
            } else if (frequency === 'custom') {
                const number = document.getElementById('editCustomNumber').value;
                const interval = document.getElementById('editCustomInterval').value;
                const startDate = document.getElementById('editCustomStartDate').value;
                if (number && interval && startDate) {
                    frequencyDetails = { 
                        number: parseInt(number), 
                        interval, 
                        startDate 
                    };
                }
            }
            
            // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’æ›´æ–°
            routine.title = title;
            routine.description = description;
            routine.frequency = frequency;
            routine.frequencyDetails = frequencyDetails;
            routine.updatedAt = new Date().toISOString();
            
            try {
                await saveData();
                closeEditModal();
                updateDisplay();
                showMessage('ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            } catch (error) {
                console.error('ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        });
    </script>
</body>
</html> 