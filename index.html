<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Routine - シンプル版</title>
    <style>
        body { font-family: sans-serif; background: #f6f8fa; margin: 0; }
        .center { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .card { background: #fff; padding: 32px 24px; border-radius: 12px; box-shadow: 0 4px 16px #0001; min-width: 320px; max-width: 400px; }
        h1, h2 { text-align: center; }
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; font-weight: bold; }
        input[type=email], input[type=password], input[type=text], input[type=number], textarea {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px;
        }
        button, .btn { padding: 10px 18px; border: none; border-radius: 6px; background: #667eea; color: #fff; font-size: 16px; cursor: pointer; margin-right: 8px; }
        button.secondary, .btn.secondary { background: #aaa; }
        .link-btn { background: none; color: #667eea; border: none; cursor: pointer; text-decoration: underline; font-size: 15px; margin: 0 8px; }
        .routine-list { margin: 0; padding: 0; list-style: none; }
        .routine-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .routine-item:last-child { border-bottom: none; }
        .routine-item.completed h3 { text-decoration: line-through; color: #aaa; }
        .frequency { font-size: 12px; color: #667eea; margin-left: 8px; }
        .tabs { display: flex; gap: 8px; margin-bottom: 12px; }
        .tab { padding: 6px 14px; border-radius: 6px; border: 1px solid #667eea; background: #fff; color: #667eea; cursor: pointer; }
        .tab.active { background: #667eea; color: #fff; }
        .mt-2 { margin-top: 16px; }
        .mb-2 { margin-bottom: 16px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
<div id="authView" class="center">
    <div class="card">
        <h1>My Routine</h1>
        <form id="loginForm">
            <div class="form-group">
                <label for="loginEmail">メールアドレス</label>
                <input type="email" id="loginEmail" required>
            </div>
            <div class="form-group">
                <label for="loginPassword">パスワード</label>
                <input type="password" id="loginPassword" required>
            </div>
            <button type="submit">ログイン</button>
        </form>
        <div class="mt-2" style="text-align:center;">
            <button class="link-btn" id="showRegister">新規登録</button>
            <button class="link-btn" id="demoLogin">デモログイン</button>
        </div>
    </div>
</div>
<div id="registerView" class="center hidden">
    <div class="card">
        <h2>新規登録</h2>
        <form id="registerForm">
            <div class="form-group">
                <label for="registerEmail">メールアドレス</label>
                <input type="email" id="registerEmail" required>
            </div>
            <div class="form-group">
                <label for="registerPassword">パスワード</label>
                <input type="password" id="registerPassword" required>
            </div>
            <button type="submit">登録</button>
            <button type="button" class="secondary" id="backToLogin">戻る</button>
        </form>
    </div>
</div>
<div id="mainView" class="center hidden">
    <div class="card" style="width:100%;max-width:500px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <h2 style="margin-bottom:0;">今日のルーティン</h2>
            <button id="logoutBtn" class="secondary">ログアウト</button>
        </div>
        <ul id="todayList" class="routine-list mb-2"></ul>
        <div class="tabs mb-2">
            <button class="tab active" data-freq="all">全て</button>
            <button class="tab" data-freq="daily">毎日</button>
            <button class="tab" data-freq="weekly">毎週</button>
            <button class="tab" data-freq="monthly">毎月</button>
        </div>
        <ul id="allList" class="routine-list mb-2"></ul>
        <button id="showAddRoutine" class="mt-2">ルーティン追加</button>
    </div>
</div>
<div id="addRoutineView" class="center hidden">
    <div class="card">
        <h2>ルーティン追加</h2>
        <form id="addRoutineForm">
            <div class="form-group">
                <label for="routineName">ルーティン名</label>
                <input type="text" id="routineName" required>
            </div>
            <div class="form-group">
                <label for="routineDesc">説明（任意）</label>
                <textarea id="routineDesc" rows="2"></textarea>
            </div>
            <div class="form-group">
                <label>頻度</label>
                <div class="tabs">
                    <button type="button" class="tab active" data-freq="daily">毎日</button>
                    <button type="button" class="tab" data-freq="weekly">毎週</button>
                    <button type="button" class="tab" data-freq="monthly">毎月</button>
                </div>
            </div>
            <div class="form-group hidden" id="weeklyDays">
                <label>曜日</label>
                <div>
                    <label><input type="checkbox" value="0">日</label>
                    <label><input type="checkbox" value="1">月</label>
                    <label><input type="checkbox" value="2">火</label>
                    <label><input type="checkbox" value="3">水</label>
                    <label><input type="checkbox" value="4">木</label>
                    <label><input type="checkbox" value="5">金</label>
                    <label><input type="checkbox" value="6">土</label>
                </div>
            </div>
            <div class="form-group hidden" id="monthlyDate">
                <label>日付</label>
                <input type="number" id="monthlyDateInput" min="1" max="31">
            </div>
            <button type="submit">保存</button>
            <button type="button" class="secondary" id="cancelAddRoutine">キャンセル</button>
        </form>
    </div>
</div>
<script>
// --- ユーティリティ ---
function $(id) { 
    const element = document.getElementById(id);
    if (!element) {
        console.error("要素が見つかりません:", id);
    }
    return element;
}
function show(view) {
    console.log("画面切り替え:", view);
    ["authView","registerView","mainView","addRoutineView"].forEach(v=>{
        const element = $(v);
        if (element) element.classList.add("hidden");
    });
    const targetElement = $(view);
    if (targetElement) targetElement.classList.remove("hidden");
}
function getUserList() {
    try {
        const users = JSON.parse(localStorage.getItem("users")||"[]");
        console.log("ユーザーリスト取得:", users.length, "件");
        return users;
    } catch (error) {
        console.error("ユーザーリスト取得エラー:", error);
        return [];
    }
}
function saveUserList(users) {
    try {
        localStorage.setItem("users",JSON.stringify(users));
        console.log("ユーザーリスト保存完了:", users.length, "件");
    } catch (error) {
        console.error("ユーザーリスト保存エラー:", error);
    }
}
function getCurrentUser() {
    try {
        const user = JSON.parse(localStorage.getItem("currentUser")||"null");
        console.log("現在のユーザー取得:", user);
        return user;
    } catch (error) {
        console.error("現在のユーザー取得エラー:", error);
        return null;
    }
}
function setCurrentUser(user) {
    try {
        localStorage.setItem("currentUser",JSON.stringify(user));
        console.log("現在のユーザー設定:", user);
    } catch (error) {
        console.error("現在のユーザー設定エラー:", error);
    }
}
function clearCurrentUser() {
    try {
        localStorage.removeItem("currentUser");
        console.log("現在のユーザー削除完了");
    } catch (error) {
        console.error("現在のユーザー削除エラー:", error);
    }
}
function getRoutines(uid) {
    try {
        const routines = JSON.parse(localStorage.getItem("routines_"+uid)||"[]");
        console.log("ルーティン取得:", uid, routines.length, "件");
        return routines;
    } catch (error) {
        console.error("ルーティン取得エラー:", error);
        return [];
    }
}
function saveRoutines(uid, routines) {
    try {
        localStorage.setItem("routines_"+uid,JSON.stringify(routines));
        console.log("ルーティン保存完了:", uid, routines.length, "件");
    } catch (error) {
        console.error("ルーティン保存エラー:", error);
    }
}
function getCompletions(uid) {
    try {
        const completions = JSON.parse(localStorage.getItem("completions_"+uid)||"[]");
        console.log("完了データ取得:", uid, completions.length, "件");
        return completions;
    } catch (error) {
        console.error("完了データ取得エラー:", error);
        return [];
    }
}
function saveCompletions(uid, completions) {
    try {
        localStorage.setItem("completions_"+uid,JSON.stringify(completions));
        console.log("完了データ保存完了:", uid, completions.length, "件");
    } catch (error) {
        console.error("完了データ保存エラー:", error);
    }
}
// --- 認証 ---
function tryLogin(email, password) {
    console.log("ログイン試行:", email);
    const users = getUserList();
    console.log("登録済みユーザー数:", users.length);
    const user = users.find(u=>u.email===email&&u.password===password);
    console.log("ログイン結果:", user ? "成功" : "失敗");
    return user || null;
}
function tryRegister(email, password) {
    console.log("登録試行:", email);
    let users = getUserList();
    if(users.find(u=>u.email===email)) {
        console.log("既に登録済み");
        return false;
    }
    const user = {id:Date.now().toString(),email,password};
    users.push(user); 
    saveUserList(users); 
    console.log("登録成功:", user);
    return user;
}
// --- 画面遷移 ---
$("showRegister").onclick = ()=>{ show("registerView"); };
$("backToLogin").onclick = ()=>{ show("authView"); };
$("demoLogin").onclick = ()=>{
    console.log("デモログイン実行");
    setCurrentUser({id:"demo",email:"demo@example.com"});
    showMain();
};
$("logoutBtn").onclick = ()=>{ 
    console.log("ログアウト実行");
    clearCurrentUser(); 
    show("authView"); 
};
$("showAddRoutine").onclick = ()=>{ 
    console.log("ルーティン追加画面表示");
    clearAddRoutineForm();
    show("addRoutineView"); 
};
$("cancelAddRoutine").onclick = ()=>{ 
    console.log("ルーティン追加キャンセル");
    clearAddRoutineForm();
    show("mainView"); 
};
// --- ログイン・登録 ---
$("loginForm").onsubmit = e=>{
    e.preventDefault();
    console.log("ログインフォーム送信");
    const email = $("loginEmail").value, pw = $("loginPassword").value;
    console.log("入力値:", {email, password: pw ? "入力済み" : "未入力"});
    
    if (!email || !pw) {
        alert("メールアドレスとパスワードを入力してください");
        return;
    }
    
    const user = tryLogin(email,pw);
    if(user) { 
        console.log("ログイン成功、メイン画面表示");
        setCurrentUser(user); 
        showMain(); 
    }
    else {
        console.log("ログイン失敗");
        alert("ログイン失敗: メールアドレスまたはパスワードが正しくありません");
    }
};
$("registerForm").onsubmit = e=>{
    e.preventDefault();
    console.log("登録フォーム送信");
    const email = $("registerEmail").value, pw = $("registerPassword").value;
    console.log("入力値:", {email, password: pw ? "入力済み" : "未入力"});
    
    if (!email || !pw) {
        alert("メールアドレスとパスワードを入力してください");
        return;
    }
    
    const user = tryRegister(email,pw);
    if(user) { 
        console.log("登録成功、メイン画面表示");
        setCurrentUser(user); 
        showMain(); 
    }
    else {
        console.log("登録失敗");
        alert("既に登録されています");
    }
};
// --- ルーティン追加 ---
let addFreq = "daily";

// フォームクリア関数
function clearAddRoutineForm() {
    console.log("ルーティン追加フォームクリア");
    try {
        // 入力フィールドをクリア
        $("routineName").value = "";
        $("routineDesc").value = "";
        $("monthlyDateInput").value = "";
        
        // チェックボックスをクリア
        [...$("weeklyDays").querySelectorAll("input[type=checkbox]")].forEach(cb => {
            cb.checked = false;
        });
        
        // 頻度をデフォルトに戻す
        addFreq = "daily";
        [...document.querySelectorAll("#addRoutineForm .tab")].forEach(b => b.classList.remove("active"));
        document.querySelector("#addRoutineForm .tab[data-freq='daily']").classList.add("active");
        
        // オプション項目を非表示
        $("weeklyDays").classList.add("hidden");
        $("monthlyDate").classList.add("hidden");
        
        console.log("フォームクリア完了");
    } catch (error) {
        console.error("フォームクリアエラー:", error);
    }
}

[...document.querySelectorAll("#addRoutineForm .tab")].forEach(btn=>{
    btn.onclick = function(){
        [...document.querySelectorAll("#addRoutineForm .tab")].forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        addFreq = btn.dataset.freq;
        $("weeklyDays").classList.toggle("hidden",addFreq!=="weekly");
        $("monthlyDate").classList.toggle("hidden",addFreq!=="monthly");
    };
});
$("addRoutineForm").onsubmit = e=>{
    e.preventDefault();
    console.log("ルーティン追加フォーム送信");
    const user = getCurrentUser();
    if(!user) {
        console.error("ユーザー情報がありません");
        return;
    }
    
    const name = $("routineName").value.trim();
    if(!name) {
        alert("ルーティン名必須");
        return;
    }
    
    const desc = $("routineDesc").value.trim();
    let weeklyDays = [], monthlyDate = null;
    
    if(addFreq==="weekly") {
        weeklyDays = [...$("weeklyDays").querySelectorAll("input:checked")].map(i=>parseInt(i.value));
    }
    if(addFreq==="monthly") {
        monthlyDate = parseInt($("monthlyDateInput").value)||null;
    }
    
    if(addFreq==="weekly" && weeklyDays.length===0) {
        alert("曜日を選択してください");
        return;
    }
    if(addFreq==="monthly" && (!monthlyDate||monthlyDate<1||monthlyDate>31)) {
        alert("日付1-31");
        return;
    }
    
    const routines = getRoutines(user.id);
    const newRoutine = {
        id: Date.now().toString(),
        name,
        desc,
        frequency: addFreq,
        weeklyDays,
        monthlyDate,
        userId: user.id
    };
    
    routines.push(newRoutine);
    saveRoutines(user.id, routines);
    console.log("ルーティン追加完了:", newRoutine);
    
    // フォームをクリアしてメイン画面に戻る
    clearAddRoutineForm();
    show("mainView");
    renderMain();
};
// --- タブ切替 ---
[...document.querySelectorAll("#mainView .tab")].forEach(btn=>{
    btn.onclick = function(){
        [...document.querySelectorAll("#mainView .tab")].forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        renderMain();
    };
});
// --- ルーティン完了 ---
function toggleComplete(rid){
    const user = getCurrentUser();
    if(!user) return;
    let completions = getCompletions(user.id);
    const today = new Date().toISOString().split("T")[0];
    const idx = completions.findIndex(c=>c.rid===rid&&c.date===today);
    if(idx!==-1) completions.splice(idx,1);
    else completions.push({rid,date:today});
    saveCompletions(user.id,completions);
    renderMain();
}
// --- メイン画面描画 ---
function showMain(){ 
    console.log("メイン画面表示開始");
    show("mainView"); 
    renderMain(); 
}
function renderMain(){
    console.log("メイン画面描画開始");
    const user = getCurrentUser();
    if(!user) {
        console.error("ユーザー情報がありません");
        show("authView");
        return;
    }
    
    try {
        $("todayList").innerHTML = "";
        $("allList").innerHTML = "";
        const routines = getRoutines(user.id);
        const completions = getCompletions(user.id);
        const today = new Date();
        console.log("描画データ:", {routines: routines.length, completions: completions.length});
        
        // 今日のルーティン
        const todayR = routines.filter(r=>{
            if(r.frequency==="daily") return true;
            if(r.frequency==="weekly") return r.weeklyDays&&r.weeklyDays.includes(today.getDay());
            if(r.frequency==="monthly") return r.monthlyDate===today.getDate();
            return false;
        });
        console.log("今日のルーティン:", todayR.length, "件");
        
        for(const r of todayR){
            const done = completions.some(c=>c.rid===r.id&&c.date===today.toISOString().split("T")[0]);
            const li = document.createElement("li");
            li.className = "routine-item"+(done?" completed":"");
            li.innerHTML = `<div><h3>${r.name}</h3>${r.desc?`<div>${r.desc}</div>`:""}<span class="frequency">${getFreqText(r.frequency)}</span></div><button onclick="toggleComplete('${r.id}')">${done?"✓":"○"}</button>`;
            $("todayList").appendChild(li);
        }
        
        // 全ルーティン
        const freq = document.querySelector("#mainView .tab.active").dataset.freq;
        const allR = freq==="all"?routines:routines.filter(r=>r.frequency===freq);
        console.log("表示ルーティン:", freq, allR.length, "件");
        
        for(const r of allR){
            const done = completions.some(c=>c.rid===r.id&&c.date===today.toISOString().split("T")[0]);
            const li = document.createElement("li");
            li.className = "routine-item"+(done?" completed":"");
            li.innerHTML = `<div><h3>${r.name}</h3>${r.desc?`<div>${r.desc}</div>`:""}<span class="frequency">${getFreqText(r.frequency)}</span></div><button onclick="toggleComplete('${r.id}')">${done?"✓":"○"}</button>`;
            $("allList").appendChild(li);
        }
        
        console.log("メイン画面描画完了");
    } catch (error) {
        console.error("メイン画面描画エラー:", error);
        alert("画面描画エラーが発生しました。ページを再読み込みしてください。");
    }
}
function getFreqText(f){ return f==="daily"?"毎日":f==="weekly"?"毎週":f==="monthly"?"毎月":f; }
// --- 初期表示 ---
window.onload = function(){
    console.log("ページ読み込み完了");
    try {
        const user = getCurrentUser();
        console.log("現在のユーザー:", user);
        if(user) {
            console.log("ログイン済み、メイン画面表示");
            showMain();
        }
        else {
            console.log("未ログイン、認証画面表示");
            show("authView");
        }
    } catch (error) {
        console.error("初期化エラー:", error);
        alert("初期化エラーが発生しました。ページを再読み込みしてください。");
        show("authView");
    }
};
</script>
</body>
</html>
