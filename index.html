<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Routine - ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        body { font-family: sans-serif; background: #f6f8fa; margin: 0; }
        .center { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .card { background: #fff; padding: 32px 24px; border-radius: 12px; box-shadow: 0 4px 16px #0001; min-width: 320px; max-width: 400px; }
        h1, h2 { text-align: center; }
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; font-weight: bold; }
        input[type=email], input[type=password], input[type=text], input[type=number], textarea {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px;
        }
        button, .btn { padding: 10px 18px; border: none; border-radius: 6px; background: #667eea; color: #fff; font-size: 16px; cursor: pointer; margin-right: 8px; }
        button.secondary, .btn.secondary { background: #aaa; }
        .link-btn { background: none; color: #667eea; border: none; cursor: pointer; text-decoration: underline; font-size: 15px; margin: 0 8px; }
        .routine-list { margin: 0; padding: 0; list-style: none; }
        .routine-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .routine-item:last-child { border-bottom: none; }
        .routine-item.completed h3 { text-decoration: line-through; color: #aaa; }
        .frequency { font-size: 12px; color: #667eea; margin-left: 8px; }
        .tabs { display: flex; gap: 8px; margin-bottom: 12px; }
        .tab { padding: 6px 14px; border-radius: 6px; border: 1px solid #667eea; background: #fff; color: #667eea; cursor: pointer; }
        .tab.active { background: #667eea; color: #fff; }
        .mt-2 { margin-top: 16px; }
        .mb-2 { margin-bottom: 16px; }
        .hidden { display: none !important; }
        .sync-status { 
            position: fixed; top: 10px; right: 10px; 
            padding: 8px 12px; border-radius: 6px; font-size: 12px; 
            background: #28a745; color: white; z-index: 1000;
        }
        .sync-status.error { background: #dc3545; }
        .sync-status.syncing { background: #ffc107; color: #000; }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
<div id="authView" class="center">
    <div class="card">
        <h1>My Routine</h1>
        <form id="loginForm">
            <div class="form-group">
                <label for="loginEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                <input type="email" id="loginEmail" required>
            </div>
            <div class="form-group">
                <label for="loginPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="loginPassword" required>
            </div>
            <button type="submit">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </form>
        <div class="mt-2" style="text-align:center;">
            <button class="link-btn" id="showRegister">æ–°è¦ç™»éŒ²</button>
            <button class="link-btn" id="demoLogin">ãƒ‡ãƒ¢ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
    </div>
</div>
<div id="registerView" class="center hidden">
    <div class="card">
        <h2>æ–°è¦ç™»éŒ²</h2>
        <form id="registerForm">
            <div class="form-group">
                <label for="registerEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                <input type="email" id="registerEmail" required>
            </div>
            <div class="form-group">
                <label for="registerPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="registerPassword" required>
            </div>
            <button type="submit">ç™»éŒ²</button>
            <button type="button" class="secondary" id="backToLogin">æˆ»ã‚‹</button>
        </form>
    </div>
</div>
<div id="mainView" class="center hidden">
    <div class="card" style="width:100%;max-width:500px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <h2 style="margin-bottom:0;">ä»Šæ—¥ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³</h2>
            <button id="logoutBtn" class="secondary">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
        <ul id="todayList" class="routine-list mb-2"></ul>
        <div class="tabs mb-2">
            <button class="tab active" data-freq="all">å…¨ã¦</button>
            <button class="tab" data-freq="daily">æ¯æ—¥</button>
            <button class="tab" data-freq="weekly">æ¯é€±</button>
            <button class="tab" data-freq="monthly">æ¯æœˆ</button>
        </div>
        <ul id="allList" class="routine-list mb-2"></ul>
        <button id="showAddRoutine" class="mt-2">ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¿½åŠ </button>
    </div>
</div>
<div id="addRoutineView" class="center hidden">
    <div class="card">
        <h2>ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¿½åŠ </h2>
        <form id="addRoutineForm">
            <div class="form-group">
                <label for="routineName">ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³å</label>
                <input type="text" id="routineName" required>
            </div>
            <div class="form-group">
                <label for="routineDesc">èª¬æ˜ï¼ˆä»»æ„ï¼‰</label>
                <textarea id="routineDesc" rows="2"></textarea>
            </div>
            <div class="form-group">
                <label>é »åº¦</label>
                <div class="tabs">
                    <button type="button" class="tab active" data-freq="daily">æ¯æ—¥</button>
                    <button type="button" class="tab" data-freq="weekly">æ¯é€±</button>
                    <button type="button" class="tab" data-freq="monthly">æ¯æœˆ</button>
                </div>
            </div>
            <div class="form-group hidden" id="weeklyDays">
                <label>æ›œæ—¥</label>
                <div>
                    <label><input type="checkbox" value="0">æ—¥</label>
                    <label><input type="checkbox" value="1">æœˆ</label>
                    <label><input type="checkbox" value="2">ç«</label>
                    <label><input type="checkbox" value="3">æ°´</label>
                    <label><input type="checkbox" value="4">æœ¨</label>
                    <label><input type="checkbox" value="5">é‡‘</label>
                    <label><input type="checkbox" value="6">åœŸ</label>
                </div>
            </div>
            <div class="form-group hidden" id="monthlyDate">
                <label>æ—¥ä»˜</label>
                <input type="number" id="monthlyDateInput" min="1" max="31">
            </div>
            <button type="submit">ä¿å­˜</button>
            <button type="button" class="secondary" id="cancelAddRoutine">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </form>
    </div>
</div>
<div id="syncStatus" class="sync-status"></div>
<script>
// --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
function $(id) { 
    const element = document.getElementById(id);
    if (!element) {
        console.error("è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", id);
    }
    return element;
}
function show(view) {
    console.log("ç”»é¢åˆ‡ã‚Šæ›¿ãˆ:", view);
    ["authView","registerView","mainView","addRoutineView"].forEach(v=>{
        const element = $(v);
        if (element) element.classList.add("hidden");
    });
    const targetElement = $(view);
    if (targetElement) targetElement.classList.remove("hidden");
}
function getUserList() {
    try {
        const users = JSON.parse(localStorage.getItem("users")||"[]");
        console.log("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆå–å¾—:", users.length, "ä»¶");
        return users;
    } catch (error) {
        console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:", error);
        return [];
    }
}
function saveUserList(users) {
    try {
        localStorage.setItem("users",JSON.stringify(users));
        console.log("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆä¿å­˜å®Œäº†:", users.length, "ä»¶");
    } catch (error) {
        console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
    }
}
function getCurrentUser() {
    try {
        const user = JSON.parse(localStorage.getItem("currentUser")||"null");
        console.log("ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—:", user);
        return user;
    } catch (error) {
        console.error("ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
        return null;
    }
}
function setCurrentUser(user) {
    try {
        localStorage.setItem("currentUser",JSON.stringify(user));
        console.log("ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š:", user);
    } catch (error) {
        console.error("ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼:", error);
    }
}
function clearCurrentUser() {
    try {
        localStorage.removeItem("currentUser");
        console.log("ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤å®Œäº†");
    } catch (error) {
        console.error("ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
    }
}
function getRoutines(uid) {
    try {
        const routines = JSON.parse(localStorage.getItem("routines_"+uid)||"[]");
        console.log("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³å–å¾—:", uid, routines.length, "ä»¶");
        return routines;
    } catch (error) {
        console.error("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
        return [];
    }
}
function saveRoutines(uid, routines) {
    try {
        localStorage.setItem("routines_"+uid,JSON.stringify(routines));
        console.log("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ä¿å­˜å®Œäº†:", uid, routines.length, "ä»¶");
    } catch (error) {
        console.error("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
    }
}
function getCompletions(uid) {
    try {
        const completions = JSON.parse(localStorage.getItem("completions_"+uid)||"[]");
        console.log("å®Œäº†ãƒ‡ãƒ¼ã‚¿å–å¾—:", uid, completions.length, "ä»¶");
        return completions;
    } catch (error) {
        console.error("å®Œäº†ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
        return [];
    }
}
function saveCompletions(uid, completions) {
    try {
        localStorage.setItem("completions_"+uid,JSON.stringify(completions));
        console.log("å®Œäº†ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†:", uid, completions.length, "ä»¶");
    } catch (error) {
        console.error("å®Œäº†ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
    }
}
// --- èªè¨¼ ---
function tryLogin(email, password) {
    console.log("ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ:", email);
    const users = getUserList();
    console.log("ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:", users.length);
    const user = users.find(u=>u.email===email&&u.password===password);
    console.log("ãƒ­ã‚°ã‚¤ãƒ³çµæœ:", user ? "æˆåŠŸ" : "å¤±æ•—");
    return user || null;
}
function tryRegister(email, password) {
    console.log("ç™»éŒ²è©¦è¡Œ:", email);
    let users = getUserList();
    if(users.find(u=>u.email===email)) {
        console.log("æ—¢ã«ç™»éŒ²æ¸ˆã¿");
        return false;
    }
    const user = {id:Date.now().toString(),email,password};
    users.push(user); 
    saveUserList(users); 
    console.log("ç™»éŒ²æˆåŠŸ:", user);
    return user;
}
// --- ç”»é¢é·ç§» ---
$("showRegister").onclick = ()=>{ show("registerView"); };
$("backToLogin").onclick = ()=>{ show("authView"); };
$("demoLogin").onclick = ()=>{
    console.log("ãƒ‡ãƒ¢ãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œ");
    setCurrentUser({id:"demo",email:"demo@example.com"});
    showMain();
};
$("logoutBtn").onclick = ()=>{ 
    console.log("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Ÿè¡Œ");
    clearCurrentUser(); 
    show("authView"); 
};
$("showAddRoutine").onclick = ()=>{ 
    console.log("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¿½åŠ ç”»é¢è¡¨ç¤º");
    clearAddRoutineForm();
    show("addRoutineView"); 
};
$("cancelAddRoutine").onclick = ()=>{ 
    console.log("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¿½åŠ ã‚­ãƒ£ãƒ³ã‚»ãƒ«");
    clearAddRoutineForm();
    show("mainView"); 
};
// --- ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ç™»éŒ² ---
$("loginForm").onsubmit = e=>{
    e.preventDefault();
    console.log("ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡");
    const email = $("loginEmail").value, pw = $("loginPassword").value;
    console.log("å…¥åŠ›å€¤:", {email, password: pw ? "å…¥åŠ›æ¸ˆã¿" : "æœªå…¥åŠ›"});
    
    if (!email || !pw) {
        alert("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
    }
    
    const user = tryLogin(email,pw);
    if(user) { 
        console.log("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸã€ãƒ¡ã‚¤ãƒ³ç”»é¢è¡¨ç¤º");
        setCurrentUser(user); 
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ç”¨
        currentStorage = 'local';
        localStorage.setItem('storageType', 'local');
        
        showMain(); 
    }
    else {
        console.log("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—");
        alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");
    }
};
$("registerForm").onsubmit = e=>{
    e.preventDefault();
    console.log("ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡");
    const email = $("registerEmail").value, pw = $("registerPassword").value;
    console.log("å…¥åŠ›å€¤:", {email, password: pw ? "å…¥åŠ›æ¸ˆã¿" : "æœªå…¥åŠ›"});
    
    if (!email || !pw) {
        alert("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
    }
    
    const user = tryRegister(email,pw);
    if(user) { 
        console.log("ç™»éŒ²æˆåŠŸã€ãƒ¡ã‚¤ãƒ³ç”»é¢è¡¨ç¤º");
        setCurrentUser(user); 
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ç”¨
        currentStorage = 'local';
        localStorage.setItem('storageType', 'local');
        
        showMain(); 
    }
    else {
        console.log("ç™»éŒ²å¤±æ•—");
        alert("æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™");
    }
};
// --- ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¿½åŠ  ---
let addFreq = "daily";

// ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢é–¢æ•°
function clearAddRoutineForm() {
    console.log("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢");
    try {
        // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
        $("routineName").value = "";
        $("routineDesc").value = "";
        $("monthlyDateInput").value = "";
        
        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
        [...$("weeklyDays").querySelectorAll("input[type=checkbox]")].forEach(cb => {
            cb.checked = false;
        });
        
        // é »åº¦ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
        addFreq = "daily";
        [...document.querySelectorAll("#addRoutineForm .tab")].forEach(b => b.classList.remove("active"));
        document.querySelector("#addRoutineForm .tab[data-freq='daily']").classList.add("active");
        
        // ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®ã‚’éè¡¨ç¤º
        $("weeklyDays").classList.add("hidden");
        $("monthlyDate").classList.add("hidden");
        
        console.log("ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢å®Œäº†");
    } catch (error) {
        console.error("ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:", error);
    }
}

[...document.querySelectorAll("#addRoutineForm .tab")].forEach(btn=>{
    btn.onclick = function(){
        [...document.querySelectorAll("#addRoutineForm .tab")].forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        addFreq = btn.dataset.freq;
        $("weeklyDays").classList.toggle("hidden",addFreq!=="weekly");
        $("monthlyDate").classList.toggle("hidden",addFreq!=="monthly");
    };
});
$("addRoutineForm").onsubmit = e=>{
    e.preventDefault();
    console.log("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡");
    const user = getCurrentUser();
    if(!user) {
        console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“");
        return;
    }
    
    const name = $("routineName").value.trim();
    if(!name) {
        alert("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³åå¿…é ˆ");
        return;
    }
    
    const desc = $("routineDesc").value.trim();
    let weeklyDays = [], monthlyDate = null;
    
    if(addFreq==="weekly") {
        weeklyDays = [...$("weeklyDays").querySelectorAll("input:checked")].map(i=>parseInt(i.value));
    }
    if(addFreq==="monthly") {
        monthlyDate = parseInt($("monthlyDateInput").value)||null;
    }
    
    if(addFreq==="weekly" && weeklyDays.length===0) {
        alert("æ›œæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„");
        return;
    }
    if(addFreq==="monthly" && (!monthlyDate||monthlyDate<1||monthlyDate>31)) {
        alert("æ—¥ä»˜1-31");
        return;
    }
    
    const routines = getRoutines(user.id);
    const newRoutine = {
        id: Date.now().toString(),
        name,
        desc,
        frequency: addFreq,
        weeklyDays,
        monthlyDate,
        userId: user.id
    };
    
    routines.push(newRoutine);
    saveRoutines(user.id, routines);
    console.log("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¿½åŠ å®Œäº†:", newRoutine);
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒ¡ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
    clearAddRoutineForm();
    show("mainView");
    renderMain();
};
// --- ã‚¿ãƒ–åˆ‡æ›¿ ---
[...document.querySelectorAll("#mainView .tab")].forEach(btn=>{
    btn.onclick = function(){
        [...document.querySelectorAll("#mainView .tab")].forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        renderMain();
    };
});
// --- ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³å®Œäº† ---
function toggleComplete(rid){
    const user = getCurrentUser();
    if(!user) return;
    let completions = getCompletions(user.id);
    const today = new Date().toISOString().split("T")[0];
    const idx = completions.findIndex(c=>c.rid===rid&&c.date===today);
    if(idx!==-1) completions.splice(idx,1);
    else completions.push({rid,date:today});
    saveCompletions(user.id,completions);
    renderMain();
}
// --- ãƒ¡ã‚¤ãƒ³ç”»é¢æç”» ---
function showMain(){ 
    console.log("ãƒ¡ã‚¤ãƒ³ç”»é¢è¡¨ç¤ºé–‹å§‹");
    show("mainView"); 
    addSyncButton(); // åŒæœŸãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    renderMain(); 
}
function renderMain(){
    console.log("ãƒ¡ã‚¤ãƒ³ç”»é¢æç”»é–‹å§‹");
    const user = getCurrentUser();
    if(!user) {
        console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“");
        show("authView");
        return;
    }
    
    try {
        $("todayList").innerHTML = "";
        $("allList").innerHTML = "";
        const routines = getRoutines(user.id);
        const completions = getCompletions(user.id);
        const today = new Date();
        console.log("æç”»ãƒ‡ãƒ¼ã‚¿:", {routines: routines.length, completions: completions.length});
        
        // ä»Šæ—¥ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³
        const todayR = routines.filter(r=>{
            console.log('ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°:', {
                name: r.name,
                frequency: r.frequency,
                weeklyDays: r.weeklyDays,
                monthlyDate: r.monthlyDate,
                today: today.getDay(),
                todayDate: today.getDate()
            });
            
            if(r.frequency==="daily") {
                console.log('æ¯æ—¥ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³:', r.name);
                return true;
            }
            if(r.frequency==="weekly") {
                const isToday = r.weeklyDays&&r.weeklyDays.includes(today.getDay());
                console.log('é€±æ¬¡ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³:', r.name, 'ä»Šæ—¥ã‹ã©ã†ã‹:', isToday, 'è¨­å®šæ›œæ—¥:', r.weeklyDays, 'ä»Šæ—¥ã®æ›œæ—¥:', today.getDay());
                return isToday;
            }
            if(r.frequency==="monthly") {
                const isToday = r.monthlyDate===today.getDate();
                console.log('æœˆæ¬¡ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³:', r.name, 'ä»Šæ—¥ã‹ã©ã†ã‹:', isToday, 'è¨­å®šæ—¥:', r.monthlyDate, 'ä»Šæ—¥ã®æ—¥:', today.getDate());
                return isToday;
            }
            console.log('ä¸æ˜ãªé »åº¦:', r.name, r.frequency);
            return false;
        });
        console.log("ä»Šæ—¥ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³:", todayR.length, "ä»¶");
        
        for(const r of todayR){
            const done = completions.some(c=>c.rid===r.id&&c.date===today.toISOString().split("T")[0]);
            const li = document.createElement("li");
            li.className = "routine-item"+(done?" completed":"");
            li.innerHTML = `<div><h3>${r.name}</h3>${r.desc?`<div>${r.desc}</div>`:""}<span class="frequency">${getFreqText(r.frequency)}</span></div><button onclick="toggleComplete('${r.id}')">${done?"âœ“":"â—‹"}</button>`;
            $("todayList").appendChild(li);
        }
        
        // å…¨ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³
        const freq = document.querySelector("#mainView .tab.active").dataset.freq;
        const allR = freq==="all"?routines:routines.filter(r=>r.frequency===freq);
        console.log("è¡¨ç¤ºãƒ«ãƒ¼ãƒ†ã‚£ãƒ³:", freq, allR.length, "ä»¶");
        
        for(const r of allR){
            const done = completions.some(c=>c.rid===r.id&&c.date===today.toISOString().split("T")[0]);
            const li = document.createElement("li");
            li.className = "routine-item"+(done?" completed":"");
            li.innerHTML = `<div><h3>${r.name}</h3>${r.desc?`<div>${r.desc}</div>`:""}<span class="frequency">${getFreqText(r.frequency)}</span></div><button onclick="toggleComplete('${r.id}')">${done?"âœ“":"â—‹"}</button>`;
            $("allList").appendChild(li);
        }
        
        console.log("ãƒ¡ã‚¤ãƒ³ç”»é¢æç”»å®Œäº†");
    } catch (error) {
        console.error("ãƒ¡ã‚¤ãƒ³ç”»é¢æç”»ã‚¨ãƒ©ãƒ¼:", error);
        alert("ç”»é¢æç”»ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
    }
}
function getFreqText(f){ return f==="daily"?"æ¯æ—¥":f==="weekly"?"æ¯é€±":f==="monthly"?"æ¯æœˆ":f; }
// --- åˆæœŸè¡¨ç¤º ---
window.onload = async function(){
    console.log("ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†");
    try {
        // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ã‚’ç¢ºèª
        const storageType = localStorage.getItem('storageType') || 'local';
        currentStorage = storageType;
        console.log("ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—:", currentStorage);
        
        const user = getCurrentUser();
        console.log("ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼:", user);
        
        if(user) {
            console.log("ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã€ãƒ¡ã‚¤ãƒ³ç”»é¢è¡¨ç¤º");
            
            // FirebaseåŒæœŸãŒæœ‰åŠ¹ãªå ´åˆã€åˆæœŸåŒæœŸã‚’å®Ÿè¡Œ
            if (currentStorage === 'firebase' && typeof firebase !== 'undefined') {
                console.log("FirebaseåˆæœŸåŒæœŸé–‹å§‹");
                await syncFromFirebase();
            }
            
            showMain();
        }
        else {
            console.log("æœªãƒ­ã‚°ã‚¤ãƒ³ã€èªè¨¼ç”»é¢è¡¨ç¤º");
            show("authView");
        }
    } catch (error) {
        console.error("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
        alert("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
        show("authView");
    }
};

// --- åŒæœŸæ©Ÿèƒ½ ---
let currentStorage = 'local'; // 'local' ã¾ãŸã¯ 'firebase'
let syncStatus = 'idle'; // 'idle', 'syncing', 'success', 'error'

// åŒæœŸçŠ¶æ…‹è¡¨ç¤º
function updateSyncStatus(status, message = '') {
    const statusElement = $('syncStatus');
    if (!statusElement) return;
    
    syncStatus = status;
    statusElement.className = `sync-status ${status}`;
    
    switch (status) {
        case 'syncing':
            statusElement.textContent = 'ğŸ”„ åŒæœŸä¸­...';
            statusElement.style.animation = 'pulse 1s infinite';
            break;
        case 'success':
            statusElement.textContent = 'âœ… åŒæœŸå®Œäº†';
            statusElement.style.animation = '';
            setTimeout(() => {
                statusElement.textContent = '';
                statusElement.style.animation = '';
            }, 3000);
            break;
        case 'error':
            statusElement.textContent = `âŒ åŒæœŸã‚¨ãƒ©ãƒ¼: ${message}`;
            statusElement.style.animation = '';
            setTimeout(() => {
                statusElement.textContent = '';
                statusElement.style.animation = '';
            }, 5000);
            break;
        default:
            statusElement.textContent = '';
            statusElement.style.animation = '';
    }
    
    console.log('åŒæœŸçŠ¶æ…‹æ›´æ–°:', status, message);
}

// FirebaseåŒæœŸæ©Ÿèƒ½
async function syncToFirebase() {
    if (typeof firebase === 'undefined') {
        console.error('Firebase SDKãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
        return false;
    }
    
    const user = getCurrentUser();
    if (!user) {
        console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“');
        return false;
    }
    
    try {
        updateSyncStatus('syncing');
        console.log('FirebaseåŒæœŸé–‹å§‹ - ãƒ¦ãƒ¼ã‚¶ãƒ¼:', user.email);
        
        const db = firebase.firestore();
        const routines = getRoutines(user.id);
        const completions = getCompletions(user.id);
        
        console.log('åŒæœŸã™ã‚‹ãƒ‡ãƒ¼ã‚¿:', {
            routines: routines.length,
            completions: completions.length,
            routinesData: routines
        });
        
        // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’Firebaseã«ä¿å­˜
        await db.collection('users').doc(user.id).set({
            email: user.email,
            lastSync: new Date().toISOString()
        });
        
        // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        await db.collection('users').doc(user.id).collection('routines').doc('data').set({
            routines: routines,
            lastUpdated: new Date().toISOString()
        });
        
        // å®Œäº†ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        await db.collection('users').doc(user.id).collection('completions').doc('data').set({
            completions: completions,
            lastUpdated: new Date().toISOString()
        });
        
        console.log('FirebaseåŒæœŸå®Œäº† - ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿:', {
            routines: routines.length,
            completions: completions.length
        });
        updateSyncStatus('success');
        return true;
        
    } catch (error) {
        console.error('FirebaseåŒæœŸã‚¨ãƒ©ãƒ¼:', error);
        updateSyncStatus('error', error.message);
        return false;
    }
}

async function syncFromFirebase() {
    if (typeof firebase === 'undefined') {
        console.error('Firebase SDKãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
        return false;
    }
    
    const user = getCurrentUser();
    if (!user) {
        console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“');
        return false;
    }
    
    try {
        updateSyncStatus('syncing');
        console.log('Firebaseã‹ã‚‰åŒæœŸé–‹å§‹ - ãƒ¦ãƒ¼ã‚¶ãƒ¼:', user.email);
        
        const db = firebase.firestore();
        
        // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const routinesDoc = await db.collection('users').doc(user.id).collection('routines').doc('data').get();
        console.log('Firebaseã‹ã‚‰å–å¾—ã—ãŸãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:', routinesDoc.exists);
        
        if (routinesDoc.exists) {
            const data = routinesDoc.data();
            console.log('Firebaseã‹ã‚‰å–å¾—ã—ãŸãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãƒ‡ãƒ¼ã‚¿:', data);
            
            if (data.routines && Array.isArray(data.routines)) {
                console.log('Firebaseã‹ã‚‰ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’åŒæœŸ:', data.routines.length, 'ä»¶');
                console.log('ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è©³ç´°:', data.routines);
                
                // æ—¢å­˜ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã¨ãƒãƒ¼ã‚¸
                const existingRoutines = getRoutines(user.id);
                console.log('æ—¢å­˜ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³:', existingRoutines.length, 'ä»¶');
                
                // æ–°ã—ã„ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã®ã¿ã‚’è¿½åŠ ï¼ˆé‡è¤‡ã‚’é¿ã‘ã‚‹ï¼‰
                const newRoutines = data.routines.filter(fbRoutine => 
                    !existingRoutines.some(localRoutine => localRoutine.id === fbRoutine.id)
                );
                
                if (newRoutines.length > 0) {
                    const mergedRoutines = [...existingRoutines, ...newRoutines];
                    saveRoutines(user.id, mergedRoutines);
                    console.log('ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãƒãƒ¼ã‚¸å®Œäº†:', mergedRoutines.length, 'ä»¶');
                } else {
                    console.log('æ–°ã—ã„ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãªã—ã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ç¶­æŒ');
                }
            }
        } else {
            console.log('Firebaseã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
        }
        
        // å®Œäº†ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const completionsDoc = await db.collection('users').doc(user.id).collection('completions').doc('data').get();
        console.log('Firebaseã‹ã‚‰å–å¾—ã—ãŸå®Œäº†ãƒ‡ãƒ¼ã‚¿ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:', completionsDoc.exists);
        
        if (completionsDoc.exists) {
            const data = completionsDoc.data();
            console.log('Firebaseã‹ã‚‰å–å¾—ã—ãŸå®Œäº†ãƒ‡ãƒ¼ã‚¿:', data);
            
            if (data.completions && Array.isArray(data.completions)) {
                console.log('Firebaseã‹ã‚‰å®Œäº†ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸ:', data.completions.length, 'ä»¶');
                
                // æ—¢å­˜ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã¨ãƒãƒ¼ã‚¸
                const existingCompletions = getCompletions(user.id);
                console.log('æ—¢å­˜ã®ãƒ­ãƒ¼ã‚«ãƒ«å®Œäº†ãƒ‡ãƒ¼ã‚¿:', existingCompletions.length, 'ä»¶');
                
                // æ–°ã—ã„å®Œäº†ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’è¿½åŠ ï¼ˆé‡è¤‡ã‚’é¿ã‘ã‚‹ï¼‰
                const newCompletions = data.completions.filter(fbCompletion => 
                    !existingCompletions.some(localCompletion => 
                        localCompletion.rid === fbCompletion.rid && localCompletion.date === fbCompletion.date
                    )
                );
                
                if (newCompletions.length > 0) {
                    const mergedCompletions = [...existingCompletions, ...newCompletions];
                    saveCompletions(user.id, mergedCompletions);
                    console.log('å®Œäº†ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸å®Œäº†:', mergedCompletions.length, 'ä»¶');
                } else {
                    console.log('æ–°ã—ã„å®Œäº†ãƒ‡ãƒ¼ã‚¿ãªã—ã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ç¶­æŒ');
                }
            }
        } else {
            console.log('Firebaseã«å®Œäº†ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
        }
        
        console.log('Firebaseã‹ã‚‰åŒæœŸå®Œäº†');
        updateSyncStatus('success');
        return true;
        
    } catch (error) {
        console.error('Firebaseã‹ã‚‰åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
        updateSyncStatus('error', error.message);
        return false;
    }
}

// æ‰‹å‹•åŒæœŸãƒœã‚¿ãƒ³
function addSyncButton() {
    const mainView = $('mainView');
    if (!mainView) return;
    
    // æ—¢å­˜ã®åŒæœŸãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
    const existingSyncBtn = document.querySelector('#syncButton');
    if (existingSyncBtn) {
        existingSyncBtn.remove();
    }
    
    const syncButton = document.createElement('button');
    syncButton.id = 'syncButton';
    syncButton.textContent = 'åŒæœŸ';
    syncButton.className = 'secondary';
    syncButton.style.marginLeft = '8px';
    syncButton.onclick = async () => {
        console.log('æ‰‹å‹•åŒæœŸé–‹å§‹');
        
        // åŒæœŸãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        syncButton.disabled = true;
        syncButton.textContent = 'åŒæœŸä¸­...';
        
        try {
            // ã¾ãšFirebaseã‹ã‚‰åŒæœŸ
            await syncFromFirebase();
            
            // æ¬¡ã«Firebaseã«åŒæœŸ
            await syncToFirebase();
            
            // ç”»é¢ã‚’å†æç”»
            renderMain();
            
            console.log('æ‰‹å‹•åŒæœŸå®Œäº†');
        } catch (error) {
            console.error('æ‰‹å‹•åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
        } finally {
            // åŒæœŸãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
            syncButton.disabled = false;
            syncButton.textContent = 'åŒæœŸ';
        }
    };
    
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã®æ¨ªã«åŒæœŸãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    const logoutBtn = $('logoutBtn');
    if (logoutBtn && logoutBtn.parentNode) {
        logoutBtn.parentNode.appendChild(syncButton);
    }
}

// è‡ªå‹•åŒæœŸï¼ˆãƒ‡ãƒ¼ã‚¿å¤‰æ›´æ™‚ï¼‰
function autoSync() {
    if (currentStorage === 'firebase') {
        syncToFirebase();
    }
}

// ä¿å­˜é–¢æ•°ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¦è‡ªå‹•åŒæœŸã‚’è¿½åŠ 
const originalSaveRoutines = saveRoutines;
const originalSaveCompletions = saveCompletions;

function saveRoutines(uid, routines) {
    try {
        localStorage.setItem("routines_"+uid,JSON.stringify(routines));
        console.log("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ä¿å­˜å®Œäº†:", uid, routines.length, "ä»¶");
        autoSync(); // è‡ªå‹•åŒæœŸ
    } catch (error) {
        console.error("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
    }
}

function saveCompletions(uid, completions) {
    try {
        localStorage.setItem("completions_"+uid,JSON.stringify(completions));
        console.log("å®Œäº†ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†:", uid, completions.length, "ä»¶");
        autoSync(); // è‡ªå‹•åŒæœŸ
    } catch (error) {
        console.error("å®Œäº†ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
    }
}
</script>
</body>
</html>
