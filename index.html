<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Routine - シンプル版</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        body { font-family: sans-serif; background: #f6f8fa; margin: 0; }
        .center { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .card { background: #fff; padding: 32px 24px; border-radius: 12px; box-shadow: 0 4px 16px #0001; min-width: 320px; max-width: 400px; }
        h1, h2 { text-align: center; }
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; font-weight: bold; }
        input[type=email], input[type=password], input[type=text], input[type=number], textarea {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px;
        }
        button, .btn { padding: 10px 18px; border: none; border-radius: 6px; background: #667eea; color: #fff; font-size: 16px; cursor: pointer; margin-right: 8px; }
        button.secondary, .btn.secondary { background: #aaa; }
        .link-btn { background: none; color: #667eea; border: none; cursor: pointer; text-decoration: underline; font-size: 15px; margin: 0 8px; }
        .routine-list { margin: 0; padding: 0; list-style: none; }
        .routine-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .routine-item:last-child { border-bottom: none; }
        .routine-item.completed h3 { text-decoration: line-through; color: #aaa; }
        .frequency { font-size: 12px; color: #667eea; margin-left: 8px; }
        .tabs { display: flex; gap: 8px; margin-bottom: 12px; }
        .tab { padding: 6px 14px; border-radius: 6px; border: 1px solid #667eea; background: #fff; color: #667eea; cursor: pointer; }
        .tab.active { background: #667eea; color: #fff; }
        .mt-2 { margin-top: 16px; }
        .mb-2 { margin-bottom: 16px; }
        .hidden { display: none !important; }
        .sync-status { 
            position: fixed; top: 10px; right: 10px; 
            padding: 8px 12px; border-radius: 6px; font-size: 12px; 
            background: #28a745; color: white; z-index: 1000;
        }
        .sync-status.error { background: #dc3545; }
        .sync-status.syncing { background: #ffc107; color: #000; }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
<div id="authView" class="center">
    <div class="card">
        <h1>My Routine</h1>
        <form id="loginForm">
            <div class="form-group">
                <label for="loginEmail">メールアドレス</label>
                <input type="email" id="loginEmail" required>
            </div>
            <div class="form-group">
                <label for="loginPassword">パスワード</label>
                <input type="password" id="loginPassword" required>
            </div>
            <button type="submit">ログイン</button>
        </form>
        <div class="mt-2" style="text-align:center;">
            <button class="link-btn" id="showRegister">新規登録</button>
            <button class="link-btn" id="demoLogin">デモログイン</button>
        </div>
    </div>
</div>
<div id="registerView" class="center hidden">
    <div class="card">
        <h2>新規登録</h2>
        <form id="registerForm">
            <div class="form-group">
                <label for="registerEmail">メールアドレス</label>
                <input type="email" id="registerEmail" required>
            </div>
            <div class="form-group">
                <label for="registerPassword">パスワード</label>
                <input type="password" id="registerPassword" required>
            </div>
            <button type="submit">登録</button>
            <button type="button" class="secondary" id="backToLogin">戻る</button>
        </form>
    </div>
</div>
<div id="mainView" class="center hidden">
    <div class="card" style="width:100%;max-width:500px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <h2 style="margin-bottom:0;">今日のルーティン</h2>
            <button id="logoutBtn" class="secondary">ログアウト</button>
        </div>
        <ul id="todayList" class="routine-list mb-2"></ul>
        <div class="tabs mb-2">
            <button class="tab active" data-freq="all">全て</button>
            <button class="tab" data-freq="daily">毎日</button>
            <button class="tab" data-freq="weekly">毎週</button>
            <button class="tab" data-freq="monthly">毎月</button>
        </div>
        <ul id="allList" class="routine-list mb-2"></ul>
        <button id="showAddRoutine" class="mt-2">ルーティン追加</button>
    </div>
</div>
<div id="addRoutineView" class="center hidden">
    <div class="card">
        <h2>ルーティン追加</h2>
        <form id="addRoutineForm">
            <div class="form-group">
                <label for="routineName">ルーティン名</label>
                <input type="text" id="routineName" required>
            </div>
            <div class="form-group">
                <label for="routineDesc">説明（任意）</label>
                <textarea id="routineDesc" rows="2"></textarea>
            </div>
            <div class="form-group">
                <label>頻度</label>
                <div class="tabs">
                    <button type="button" class="tab active" data-freq="daily">毎日</button>
                    <button type="button" class="tab" data-freq="weekly">毎週</button>
                    <button type="button" class="tab" data-freq="monthly">毎月</button>
                </div>
            </div>
            <div class="form-group hidden" id="weeklyDays">
                <label>曜日</label>
                <div>
                    <label><input type="checkbox" value="0">日</label>
                    <label><input type="checkbox" value="1">月</label>
                    <label><input type="checkbox" value="2">火</label>
                    <label><input type="checkbox" value="3">水</label>
                    <label><input type="checkbox" value="4">木</label>
                    <label><input type="checkbox" value="5">金</label>
                    <label><input type="checkbox" value="6">土</label>
                </div>
            </div>
            <div class="form-group hidden" id="monthlyDate">
                <label>日付</label>
                <input type="number" id="monthlyDateInput" min="1" max="31">
            </div>
            <button type="submit">保存</button>
            <button type="button" class="secondary" id="cancelAddRoutine">キャンセル</button>
        </form>
    </div>
</div>
<div id="syncStatus" class="sync-status"></div>
<script>
// --- ユーティリティ ---
function $(id) { 
    const element = document.getElementById(id);
    if (!element) {
        console.error("要素が見つかりません:", id);
    }
    return element;
}
function show(view) {
    console.log("画面切り替え:", view);
    ["authView","registerView","mainView","addRoutineView"].forEach(v=>{
        const element = $(v);
        if (element) element.classList.add("hidden");
    });
    const targetElement = $(view);
    if (targetElement) targetElement.classList.remove("hidden");
}
function getUserList() {
    try {
        const users = JSON.parse(localStorage.getItem("users")||"[]");
        console.log("ユーザーリスト取得:", users.length, "件");
        return users;
    } catch (error) {
        console.error("ユーザーリスト取得エラー:", error);
        return [];
    }
}
function saveUserList(users) {
    try {
        localStorage.setItem("users",JSON.stringify(users));
        console.log("ユーザーリスト保存完了:", users.length, "件");
    } catch (error) {
        console.error("ユーザーリスト保存エラー:", error);
    }
}
function getCurrentUser() {
    try {
        const user = JSON.parse(localStorage.getItem("currentUser")||"null");
        console.log("現在のユーザー取得:", user);
        return user;
    } catch (error) {
        console.error("現在のユーザー取得エラー:", error);
        return null;
    }
}
function setCurrentUser(user) {
    try {
        localStorage.setItem("currentUser",JSON.stringify(user));
        console.log("現在のユーザー設定:", user);
    } catch (error) {
        console.error("現在のユーザー設定エラー:", error);
    }
}
function clearCurrentUser() {
    try {
        localStorage.removeItem("currentUser");
        console.log("現在のユーザー削除完了");
    } catch (error) {
        console.error("現在のユーザー削除エラー:", error);
    }
}
function getRoutines(uid) {
    try {
        const routines = JSON.parse(localStorage.getItem("routines_"+uid)||"[]");
        console.log("ルーティン取得:", uid, routines.length, "件");
        return routines;
    } catch (error) {
        console.error("ルーティン取得エラー:", error);
        return [];
    }
}
function saveRoutines(uid, routines) {
    try {
        localStorage.setItem("routines_"+uid,JSON.stringify(routines));
        console.log("ルーティン保存完了:", uid, routines.length, "件");
    } catch (error) {
        console.error("ルーティン保存エラー:", error);
    }
}
function getCompletions(uid) {
    try {
        const completions = JSON.parse(localStorage.getItem("completions_"+uid)||"[]");
        console.log("完了データ取得:", uid, completions.length, "件");
        return completions;
    } catch (error) {
        console.error("完了データ取得エラー:", error);
        return [];
    }
}
function saveCompletions(uid, completions) {
    try {
        localStorage.setItem("completions_"+uid,JSON.stringify(completions));
        console.log("完了データ保存完了:", uid, completions.length, "件");
    } catch (error) {
        console.error("完了データ保存エラー:", error);
    }
}
// --- 認証 ---
function tryLogin(email, password) {
    console.log("ログイン試行:", email);
    const users = getUserList();
    console.log("登録済みユーザー数:", users.length);
    const user = users.find(u=>u.email===email&&u.password===password);
    console.log("ログイン結果:", user ? "成功" : "失敗");
    return user || null;
}
function tryRegister(email, password) {
    console.log("登録試行:", email);
    let users = getUserList();
    if(users.find(u=>u.email===email)) {
        console.log("既に登録済み");
        return false;
    }
    const user = {id:Date.now().toString(),email,password};
    users.push(user); 
    saveUserList(users); 
    console.log("登録成功:", user);
    return user;
}
// --- 画面遷移 ---
$("showRegister").onclick = ()=>{ show("registerView"); };
$("backToLogin").onclick = ()=>{ show("authView"); };
$("demoLogin").onclick = ()=>{
    console.log("デモログイン実行");
    setCurrentUser({id:"demo",email:"demo@example.com"});
    showMain();
};
$("logoutBtn").onclick = ()=>{ 
    console.log("ログアウト実行");
    clearCurrentUser(); 
    show("authView"); 
};
$("showAddRoutine").onclick = ()=>{ 
    console.log("ルーティン追加画面表示");
    clearAddRoutineForm();
    show("addRoutineView"); 
};
$("cancelAddRoutine").onclick = ()=>{ 
    console.log("ルーティン追加キャンセル");
    clearAddRoutineForm();
    show("mainView"); 
};
// --- ログイン・登録 ---
$("loginForm").onsubmit = e=>{
    e.preventDefault();
    console.log("ログインフォーム送信");
    const email = $("loginEmail").value, pw = $("loginPassword").value;
    console.log("入力値:", {email, password: pw ? "入力済み" : "未入力"});
    
    if (!email || !pw) {
        alert("メールアドレスとパスワードを入力してください");
        return;
    }
    
    const user = tryLogin(email,pw);
    if(user) { 
        console.log("ログイン成功、メイン画面表示");
        setCurrentUser(user); 
        
        // ローカルストレージを使用
        currentStorage = 'local';
        localStorage.setItem('storageType', 'local');
        
        // 既存ルーティンの移行を実行
        runMigrationIfNeeded();
        
        showMain(); 
    }
    else {
        console.log("ログイン失敗");
        alert("ログイン失敗: メールアドレスまたはパスワードが正しくありません");
    }
};
$("registerForm").onsubmit = e=>{
    e.preventDefault();
    console.log("登録フォーム送信");
    const email = $("registerEmail").value, pw = $("registerPassword").value;
    console.log("入力値:", {email, password: pw ? "入力済み" : "未入力"});
    
    if (!email || !pw) {
        alert("メールアドレスとパスワードを入力してください");
        return;
    }
    
    const user = tryRegister(email,pw);
    if(user) { 
        console.log("登録成功、メイン画面表示");
        setCurrentUser(user); 
        
        // ローカルストレージを使用
        currentStorage = 'local';
        localStorage.setItem('storageType', 'local');
        
        // 既存ルーティンの移行を実行
        runMigrationIfNeeded();
        
        showMain(); 
    }
    else {
        console.log("登録失敗");
        alert("既に登録されています");
    }
};
// --- ルーティン追加 ---
let addFreq = "daily";

// フォームクリア関数
function clearAddRoutineForm() {
    console.log("ルーティン追加フォームクリア");
    try {
        // 入力フィールドをクリア
        $("routineName").value = "";
        $("routineDesc").value = "";
        $("monthlyDateInput").value = "";
        
        // チェックボックスをクリア
        [...$("weeklyDays").querySelectorAll("input[type=checkbox]")].forEach(cb => {
            cb.checked = false;
        });
        
        // 頻度をデフォルトに戻す
        addFreq = "daily";
        [...document.querySelectorAll("#addRoutineForm .tab")].forEach(b => b.classList.remove("active"));
        document.querySelector("#addRoutineForm .tab[data-freq='daily']").classList.add("active");
        
        // オプション項目を非表示
        $("weeklyDays").classList.add("hidden");
        $("monthlyDate").classList.add("hidden");
        
        console.log("フォームクリア完了");
    } catch (error) {
        console.error("フォームクリアエラー:", error);
    }
}

[...document.querySelectorAll("#addRoutineForm .tab")].forEach(btn=>{
    btn.onclick = function(){
        [...document.querySelectorAll("#addRoutineForm .tab")].forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        addFreq = btn.dataset.freq;
        $("weeklyDays").classList.toggle("hidden",addFreq!=="weekly");
        $("monthlyDate").classList.toggle("hidden",addFreq!=="monthly");
    };
});
$("addRoutineForm").onsubmit = e=>{
    e.preventDefault();
    console.log("ルーティン追加フォーム送信");
    const user = getCurrentUser();
    if(!user) {
        console.error("ユーザー情報がありません");
        return;
    }
    
    const name = $("routineName").value.trim();
    if(!name) {
        alert("ルーティン名必須");
        return;
    }
    
    const desc = $("routineDesc").value.trim();
    let weeklyDays = [], monthlyDate = null;
    
    if(addFreq==="weekly") {
        weeklyDays = [...$("weeklyDays").querySelectorAll("input:checked")].map(i=>parseInt(i.value));
    }
    if(addFreq==="monthly") {
        monthlyDate = parseInt($("monthlyDateInput").value)||null;
    }
    
    if(addFreq==="weekly" && weeklyDays.length===0) {
        alert("曜日を選択してください");
        return;
    }
    if(addFreq==="monthly" && (!monthlyDate||monthlyDate<1||monthlyDate>31)) {
        alert("日付1-31");
        return;
    }
    
    const routines = getRoutines(user.id);
    
    // ユニークIDを生成（タイムスタンプ + ランダム文字列）
    const timestamp = Date.now();
    const randomStr = Math.random().toString(36).substring(2, 8);
    const uniqueId = `${timestamp}_${randomStr}`;
    
    const newRoutine = {
        id: uniqueId, // ユニークID
        displayId: Date.now().toString(), // 表示用ID（従来のID）
        name,
        desc,
        frequency: addFreq,
        weeklyDays,
        monthlyDate,
        userId: user.id,
        createdAt: new Date().toISOString(),
        lastModified: new Date().toISOString()
    };
    
    routines.push(newRoutine);
    saveRoutines(user.id, routines);
    console.log("ルーティン追加完了:", {
        uniqueId: newRoutine.id,
        displayId: newRoutine.displayId,
        name: newRoutine.name,
        frequency: newRoutine.frequency
    });
    
    // フォームをクリアしてメイン画面に戻る
    clearAddRoutineForm();
    show("mainView");
    renderMain();
};
// --- タブ切替 ---
[...document.querySelectorAll("#mainView .tab")].forEach(btn=>{
    btn.onclick = function(){
        [...document.querySelectorAll("#mainView .tab")].forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        renderMain();
    };
});
// --- ルーティン完了 ---
function toggleComplete(rid){
    console.log("ルーティン完了切り替え:", rid);
    const user = getCurrentUser();
    if(!user) return;
    
    let completions = getCompletions(user.id);
    const today = new Date().toISOString().split("T")[0];
    
    // ユニークIDまたは表示IDでルーティンを検索
    const routines = getRoutines(user.id);
    const routine = routines.find(r => r.id === rid || r.displayId === rid);
    
    if (!routine) {
        console.error("ルーティンが見つかりません:", rid);
        return;
    }
    
    console.log("対象ルーティン:", {
        uniqueId: routine.id,
        displayId: routine.displayId,
        name: routine.name
    });
    
    // ユニークIDで完了データを管理
    const idx = completions.findIndex(c=>c.rid===routine.id&&c.date===today);
    if(idx!==-1) {
        completions.splice(idx,1);
        console.log("完了を解除:", routine.name);
    } else {
        completions.push({
            rid: routine.id, // ユニークIDを使用
            displayRid: routine.displayId, // 表示IDも保存
            date: today,
            completedAt: new Date().toISOString()
        });
        console.log("完了を設定:", routine.name);
    }
    
    saveCompletions(user.id,completions);
    renderMain();
}
// --- メイン画面描画 ---
function showMain(){ 
    console.log("メイン画面表示開始");
    show("mainView"); 
    addSyncButton(); // 同期ボタンを追加
    addTestButton(); // テストボタンを追加
    addManagementButtons(); // 管理ボタンを追加
    renderMain(); 
}
function renderMain(){
    console.log("メイン画面描画開始");
    const user = getCurrentUser();
    if(!user) {
        console.error("ユーザー情報がありません");
        show("authView");
        return;
    }
    
    try {
        $("todayList").innerHTML = "";
        $("allList").innerHTML = "";
        const routines = getRoutines(user.id);
        const completions = getCompletions(user.id);
        const today = new Date();
        console.log("描画データ:", {routines: routines.length, completions: completions.length});
        
        // 今日のルーティン
        const todayR = routines.filter(r=>{
            const todayDay = today.getDay(); // 0=日曜日, 1=月曜日, ..., 6=土曜日
            const todayDate = today.getDate(); // 1-31
            
            console.log('ルーティンフィルタリング:', {
                name: r.name,
                frequency: r.frequency,
                weeklyDays: r.weeklyDays,
                monthlyDate: r.monthlyDate,
                today: todayDay,
                todayDate: todayDate,
                todayString: today.toLocaleDateString('ja-JP', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                })
            });
            
            if(r.frequency==="daily") {
                console.log('毎日ルーティン:', r.name);
                return true;
            }
            if(r.frequency==="weekly") {
                const isToday = r.weeklyDays && r.weeklyDays.includes(todayDay);
                console.log('週次ルーティン:', r.name, '今日かどうか:', isToday, '設定曜日:', r.weeklyDays, '今日の曜日:', todayDay);
                return isToday;
            }
            if(r.frequency==="monthly") {
                const isToday = r.monthlyDate === todayDate;
                console.log('月次ルーティン:', r.name, '今日かどうか:', isToday, '設定日:', r.monthlyDate, '今日の日:', todayDate);
                return isToday;
            }
            console.log('不明な頻度:', r.name, r.frequency);
            return false;
        });
        console.log("今日のルーティン:", todayR.length, "件");
        
        for(const r of todayR){
            const done = completions.some(c=>c.rid===r.id&&c.date===today.toISOString().split("T")[0]);
            const li = document.createElement("li");
            li.className = "routine-item"+(done?" completed":"");
            li.innerHTML = `
                <div>
                    <h3>${r.name}</h3>
                    ${r.desc?`<div>${r.desc}</div>`:""}
                    <span class="frequency">${getFreqText(r.frequency)}</span>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <button onclick="toggleComplete('${r.id}')" data-routine-id="${r.id}" data-display-id="${r.displayId}">${done?"✓":"○"}</button>
                    <button onclick="deleteRoutineFromUI('${r.id}')" class="delete-btn" style="background:#dc3545;padding:6px 10px;font-size:12px;">削除</button>
                </div>
            `;
            $("todayList").appendChild(li);
        }
        
        // 全ルーティン
        const freq = document.querySelector("#mainView .tab.active").dataset.freq;
        const allR = freq==="all"?routines:routines.filter(r=>r.frequency===freq);
        console.log("表示ルーティン:", freq, allR.length, "件");
        
        for(const r of allR){
            const done = completions.some(c=>c.rid===r.id&&c.date===today.toISOString().split("T")[0]);
            const li = document.createElement("li");
            li.className = "routine-item"+(done?" completed":"");
            li.innerHTML = `
                <div>
                    <h3>${r.name}</h3>
                    ${r.desc?`<div>${r.desc}</div>`:""}
                    <span class="frequency">${getFreqText(r.frequency)}</span>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <button onclick="toggleComplete('${r.id}')" data-routine-id="${r.id}" data-display-id="${r.displayId}">${done?"✓":"○"}</button>
                    <button onclick="deleteRoutineFromUI('${r.id}')" class="delete-btn" style="background:#dc3545;padding:6px 10px;font-size:12px;">削除</button>
                </div>
            `;
            $("allList").appendChild(li);
        }
        
        console.log("メイン画面描画完了");
    } catch (error) {
        console.error("メイン画面描画エラー:", error);
        alert("画面描画エラーが発生しました。ページを再読み込みしてください。");
    }
}
function getFreqText(f){ return f==="daily"?"毎日":f==="weekly"?"毎週":f==="monthly"?"毎月":f; }
// --- 初期表示 ---
window.onload = async function(){
    console.log("ページ読み込み完了");
    try {
        // ストレージタイプを確認
        const storageType = localStorage.getItem('storageType') || 'local';
        currentStorage = storageType;
        console.log("ストレージタイプ:", currentStorage);
        
        const user = getCurrentUser();
        console.log("現在のユーザー:", user);
        
        if(user) {
            console.log("ログイン済み、メイン画面表示");
            
            // 既存ルーティンの移行を実行
            runMigrationIfNeeded();
            
            // Firebase同期が有効な場合、初期同期を実行
            if (currentStorage === 'firebase' && typeof firebase !== 'undefined') {
                console.log("Firebase初期同期開始");
                try {
                    await syncFromFirebase();
                    console.log("Firebase初期同期完了");
                } catch (error) {
                    console.error("Firebase初期同期エラー:", error);
                }
            } else {
                console.log("Firebase同期が無効またはFirebase SDKが読み込まれていません");
                console.log("ストレージタイプ:", currentStorage);
                console.log("Firebase SDK:", typeof firebase !== 'undefined' ? '読み込み済み' : '未読み込み');
            }
            
            showMain();
        }
        else {
            console.log("未ログイン、認証画面表示");
            show("authView");
        }
    } catch (error) {
        console.error("初期化エラー:", error);
        alert("初期化エラーが発生しました。ページを再読み込みしてください。");
        show("authView");
    }
};

// --- 同期機能 ---
let currentStorage = 'local'; // 'local' または 'firebase'
let syncStatus = 'idle'; // 'idle', 'syncing', 'success', 'error'

// 同期状態表示
function updateSyncStatus(status, message = '') {
    const statusElement = $('syncStatus');
    if (!statusElement) return;
    
    syncStatus = status;
    statusElement.className = `sync-status ${status}`;
    
    switch (status) {
        case 'syncing':
            statusElement.textContent = '🔄 同期中...';
            statusElement.style.animation = 'pulse 1s infinite';
            break;
        case 'success':
            statusElement.textContent = '✅ 同期完了';
            statusElement.style.animation = '';
            setTimeout(() => {
                statusElement.textContent = '';
                statusElement.style.animation = '';
            }, 3000);
            break;
        case 'error':
            statusElement.textContent = `❌ 同期エラー: ${message}`;
            statusElement.style.animation = '';
            setTimeout(() => {
                statusElement.textContent = '';
                statusElement.style.animation = '';
            }, 5000);
            break;
        default:
            statusElement.textContent = '';
            statusElement.style.animation = '';
    }
    
    console.log('同期状態更新:', status, message);
}

// Firebase同期機能（改善版）
async function syncToFirebase() {
    if (typeof firebase === 'undefined') {
        console.error('Firebase SDKが読み込まれていません');
        return false;
    }
    
    const user = getCurrentUser();
    if (!user) {
        console.error('ユーザー情報がありません');
        return false;
    }
    
    try {
        updateSyncStatus('syncing');
        console.log('Firebase同期開始 - ユーザー:', user.email);
        
        const db = firebase.firestore();
        const routines = getRoutines(user.id);
        const completions = getCompletions(user.id);
        
        console.log('同期するデータ:', {
            routines: routines.length,
            completions: completions.length,
            routinesData: routines.map(r => ({
                id: r.id,
                displayId: r.displayId,
                name: r.name,
                frequency: r.frequency
            }))
        });
        
        // バッチ処理で一括保存
        const batch = db.batch();
        
        // ユーザー情報を更新
        const userRef = db.collection('users').doc(user.id);
        batch.set(userRef, {
            email: user.email,
            lastSync: new Date().toISOString(),
            lastSyncDirection: 'upload'
        });
        
        // ルーティンデータを保存
        const routinesRef = db.collection('users').doc(user.id).collection('routines').doc('data');
        batch.set(routinesRef, {
            routines: routines,
            lastUpdated: new Date().toISOString(),
            count: routines.length
        });
        
        // 完了データを保存
        const completionsRef = db.collection('users').doc(user.id).collection('completions').doc('data');
        batch.set(completionsRef, {
            completions: completions,
            lastUpdated: new Date().toISOString(),
            count: completions.length
        });
        
        // バッチ処理を実行
        await batch.commit();
        
        console.log('Firebase同期完了 - 保存されたデータ:', {
            routines: routines.length,
            completions: completions.length
        });
        updateSyncStatus('success');
        return true;
        
    } catch (error) {
        console.error('Firebase同期エラー:', error);
        updateSyncStatus('error', error.message);
        
        // リトライ処理
        if (error.code === 'unavailable' || error.code === 'deadline-exceeded') {
            console.log('ネットワークエラーのため、3秒後にリトライします');
            setTimeout(async () => {
                console.log('リトライ開始');
                await syncToFirebase();
            }, 3000);
        }
        
        return false;
    }
}

async function syncFromFirebase() {
    if (typeof firebase === 'undefined') {
        console.error('Firebase SDKが読み込まれていません');
        return false;
    }
    
    const user = getCurrentUser();
    if (!user) {
        console.error('ユーザー情報がありません');
        return false;
    }
    
    try {
        updateSyncStatus('syncing');
        console.log('Firebaseから同期開始 - ユーザー:', user.email);
        
        const db = firebase.firestore();
        
        // ルーティンデータを取得
        const routinesDoc = await db.collection('users').doc(user.id).collection('routines').doc('data').get();
        console.log('Firebaseから取得したルーティンドキュメント:', routinesDoc.exists);
        
        if (routinesDoc.exists) {
            const data = routinesDoc.data();
            console.log('Firebaseから取得したルーティンデータ:', {
                count: data.routines ? data.routines.length : 0,
                lastUpdated: data.lastUpdated
            });
            
            if (data.routines && Array.isArray(data.routines)) {
                console.log('Firebaseからルーティンを同期:', data.routines.length, '件');
                
                // 既存のローカルデータとマージ
                const existingRoutines = getRoutines(user.id);
                console.log('既存のローカルルーティン:', existingRoutines.length, '件');
                
                // 新しいルーティンのみを追加（重複を避ける）
                const newRoutines = data.routines.filter(fbRoutine => 
                    !existingRoutines.some(localRoutine => localRoutine.id === fbRoutine.id)
                );
                
                if (newRoutines.length > 0) {
                    const mergedRoutines = [...existingRoutines, ...newRoutines];
                    saveRoutines(user.id, mergedRoutines);
                    console.log('ルーティンマージ完了:', mergedRoutines.length, '件');
                } else {
                    console.log('新しいルーティンなし、既存データを維持');
                }
            }
        } else {
            console.log('Firebaseにルーティンデータが存在しません');
        }
        
        // 完了データを取得
        const completionsDoc = await db.collection('users').doc(user.id).collection('completions').doc('data').get();
        console.log('Firebaseから取得した完了データドキュメント:', completionsDoc.exists);
        
        if (completionsDoc.exists) {
            const data = completionsDoc.data();
            console.log('Firebaseから取得した完了データ:', {
                count: data.completions ? data.completions.length : 0,
                lastUpdated: data.lastUpdated
            });
            
            if (data.completions && Array.isArray(data.completions)) {
                console.log('Firebaseから完了データを同期:', data.completions.length, '件');
                
                // 既存のローカルデータとマージ
                const existingCompletions = getCompletions(user.id);
                console.log('既存のローカル完了データ:', existingCompletions.length, '件');
                
                // 新しい完了データのみを追加（重複を避ける）
                const newCompletions = data.completions.filter(fbCompletion => 
                    !existingCompletions.some(localCompletion => 
                        localCompletion.rid === fbCompletion.rid && localCompletion.date === fbCompletion.date
                    )
                );
                
                if (newCompletions.length > 0) {
                    const mergedCompletions = [...existingCompletions, ...newCompletions];
                    saveCompletions(user.id, mergedCompletions);
                    console.log('完了データマージ完了:', mergedCompletions.length, '件');
                } else {
                    console.log('新しい完了データなし、既存データを維持');
                }
            }
        } else {
            console.log('Firebaseに完了データが存在しません');
        }
        
        console.log('Firebaseから同期完了');
        updateSyncStatus('success');
        return true;
        
    } catch (error) {
        console.error('Firebaseから同期エラー:', error);
        updateSyncStatus('error', error.message);
        
        // リトライ処理
        if (error.code === 'unavailable' || error.code === 'deadline-exceeded') {
            console.log('ネットワークエラーのため、3秒後にリトライします');
            setTimeout(async () => {
                console.log('リトライ開始');
                await syncFromFirebase();
            }, 3000);
        }
        
        return false;
    }
}

// 同期状態の詳細確認
function checkSyncStatus() {
    const user = getCurrentUser();
    if (!user) {
        console.error("ユーザー情報がありません");
        return;
    }
    
    console.log("=== 同期状態確認 ===");
    console.log("ユーザー:", user.email);
    console.log("ユーザーID:", user.id);
    console.log("ストレージタイプ:", currentStorage);
    
    // ローカルデータ確認
    const localRoutines = getRoutines(user.id);
    const localCompletions = getCompletions(user.id);
    
    console.log("ローカルデータ:", {
        routines: localRoutines.length,
        completions: localCompletions.length,
        routinesData: localRoutines.map(r => ({
            id: r.id,
            displayId: r.displayId,
            name: r.name,
            frequency: r.frequency
        }))
    });
    
    // Firebaseデータ確認
    if (typeof firebase !== 'undefined') {
        checkFirebaseData(user.id);
    } else {
        console.log("Firebase SDKが読み込まれていません");
    }
}

// Firebaseデータの確認
async function checkFirebaseData(userId) {
    try {
        console.log("Firebaseデータ確認開始");
        const db = firebase.firestore();
        
        // ユーザードキュメント確認
        const userDoc = await db.collection('users').doc(userId).get();
        console.log("Firebaseユーザードキュメント:", userDoc.exists);
        
        if (userDoc.exists) {
            console.log("ユーザー情報:", userDoc.data());
        }
        
        // ルーティンデータ確認
        const routinesDoc = await db.collection('users').doc(userId).collection('routines').doc('data').get();
        console.log("Firebaseルーティンドキュメント:", routinesDoc.exists);
        
        if (routinesDoc.exists) {
            const data = routinesDoc.data();
            console.log("Firebaseルーティンデータ:", {
                count: data.routines ? data.routines.length : 0,
                lastUpdated: data.lastUpdated,
                routines: data.routines ? data.routines.map(r => ({
                    id: r.id,
                    displayId: r.displayId,
                    name: r.name,
                    frequency: r.frequency
                })) : []
            });
        }
        
        // 完了データ確認
        const completionsDoc = await db.collection('users').doc(userId).collection('completions').doc('data').get();
        console.log("Firebase完了データドキュメント:", completionsDoc.exists);
        
        if (completionsDoc.exists) {
            const data = completionsDoc.data();
            console.log("Firebase完了データ:", {
                count: data.completions ? data.completions.length : 0,
                lastUpdated: data.lastUpdated
            });
        }
        
    } catch (error) {
        console.error("Firebaseデータ確認エラー:", error);
    }
}

// 強制同期機能
async function forceSync() {
    console.log("=== 強制同期開始 ===");
    
    const user = getCurrentUser();
    if (!user) {
        console.error("ユーザー情報がありません");
        return;
    }
    
    try {
        // 1. ローカルデータをFirebaseに強制アップロード
        console.log("1. ローカルデータをFirebaseにアップロード");
        await syncToFirebase();
        
        // 2. Firebaseからデータを強制ダウンロード
        console.log("2. Firebaseからデータをダウンロード");
        await syncFromFirebase();
        
        // 3. 画面を再描画
        console.log("3. 画面を再描画");
        renderMain();
        
        console.log("=== 強制同期完了 ===");
        
    } catch (error) {
        console.error("強制同期エラー:", error);
    }
}

// 同期ボタンに強制同期機能を追加
function addSyncButton() {
    const mainView = $('mainView');
    if (!mainView) return;
    
    // 既存の同期ボタンを削除
    const existingSyncBtn = document.querySelector('#syncButton');
    if (existingSyncBtn) {
        existingSyncBtn.remove();
    }
    
    const syncButton = document.createElement('button');
    syncButton.id = 'syncButton';
    syncButton.textContent = '同期';
    syncButton.className = 'secondary';
    syncButton.style.marginLeft = '8px';
    syncButton.onclick = async () => {
        console.log('手動同期開始');
        
        // 同期ボタンを無効化
        syncButton.disabled = true;
        syncButton.textContent = '同期中...';
        
        try {
            // まずFirebaseから同期
            await syncFromFirebase();
            
            // 次にFirebaseに同期
            await syncToFirebase();
            
            // 画面を再描画
            renderMain();
            
            console.log('手動同期完了');
        } catch (error) {
            console.error('手動同期エラー:', error);
        } finally {
            // 同期ボタンを再有効化
            syncButton.disabled = false;
            syncButton.textContent = '同期';
        }
    };
    
    // 強制同期ボタンを追加
    const forceSyncButton = document.createElement('button');
    forceSyncButton.id = 'forceSyncButton';
    forceSyncButton.textContent = '強制同期';
    forceSyncButton.className = 'secondary';
    forceSyncButton.style.marginLeft = '8px';
    forceSyncButton.onclick = async () => {
        console.log('強制同期開始');
        
        // ボタンを無効化
        forceSyncButton.disabled = true;
        forceSyncButton.textContent = '強制同期中...';
        
        try {
            await forceSync();
        } catch (error) {
            console.error('強制同期エラー:', error);
        } finally {
            // ボタンを再有効化
            forceSyncButton.disabled = false;
            forceSyncButton.textContent = '強制同期';
        }
    };
    
    // デバッグボタンを追加
    const debugButton = document.createElement('button');
    debugButton.id = 'debugButton';
    debugButton.textContent = 'デバッグ';
    debugButton.className = 'secondary';
    debugButton.style.marginLeft = '8px';
    debugButton.onclick = () => {
        checkSyncStatus();
    };
    
    // テストボタンを追加
    const testButton = document.createElement('button');
    testButton.id = 'testButton';
    testButton.textContent = 'テスト追加';
    testButton.className = 'secondary';
    testButton.style.marginLeft = '8px';
    testButton.onclick = () => {
        addTodayTestRoutine();
    };
    
    // ログアウトボタンの横にボタンを追加
    const logoutBtn = $('logoutBtn');
    if (logoutBtn && logoutBtn.parentNode) {
        logoutBtn.parentNode.appendChild(syncButton);
        logoutBtn.parentNode.appendChild(forceSyncButton);
        logoutBtn.parentNode.appendChild(debugButton);
        logoutBtn.parentNode.appendChild(testButton);
    }
}

// 自動同期（データ変更時）
function autoSync() {
    if (currentStorage === 'firebase') {
        syncToFirebase();
    }
}

// 保存関数をオーバーライドして自動同期を追加
const originalSaveRoutines = saveRoutines;
const originalSaveCompletions = saveCompletions;

function saveRoutines(uid, routines) {
    try {
        localStorage.setItem("routines_"+uid,JSON.stringify(routines));
        console.log("ルーティン保存完了:", uid, routines.length, "件");
        autoSync(); // 自動同期
    } catch (error) {
        console.error("ルーティン保存エラー:", error);
    }
}

function saveCompletions(uid, completions) {
    try {
        localStorage.setItem("completions_"+uid,JSON.stringify(completions));
        console.log("完了データ保存完了:", uid, completions.length, "件");
        autoSync(); // 自動同期
    } catch (error) {
        console.error("完了データ保存エラー:", error);
    }
}

// --- ルーティン管理機能 ---
function findRoutineById(uniqueId) {
    const user = getCurrentUser();
    if (!user) return null;
    
    const routines = getRoutines(user.id);
    return routines.find(r => r.id === uniqueId);
}

function findRoutineByDisplayId(displayId) {
    const user = getCurrentUser();
    if (!user) return null;
    
    const routines = getRoutines(user.id);
    return routines.find(r => r.displayId === displayId);
}

function updateRoutine(uniqueId, updates) {
    const user = getCurrentUser();
    if (!user) return false;
    
    const routines = getRoutines(user.id);
    const index = routines.findIndex(r => r.id === uniqueId);
    
    if (index === -1) {
        console.error("ルーティンが見つかりません:", uniqueId);
        return false;
    }
    
    // 更新情報をマージ
    routines[index] = {
        ...routines[index],
        ...updates,
        lastModified: new Date().toISOString()
    };
    
    saveRoutines(user.id, routines);
    console.log("ルーティン更新完了:", {
        uniqueId: routines[index].id,
        name: routines[index].name,
        updates: updates
    });
    
    return true;
}

function deleteRoutine(uniqueId) {
    const user = getCurrentUser();
    if (!user) return false;
    
    const routines = getRoutines(user.id);
    const index = routines.findIndex(r => r.id === uniqueId);
    
    if (index === -1) {
        console.error("ルーティンが見つかりません:", uniqueId);
        return false;
    }
    
    const deletedRoutine = routines[index];
    routines.splice(index, 1);
    
    // 関連する完了データも削除
    let completions = getCompletions(user.id);
    completions = completions.filter(c => c.rid !== uniqueId);
    
    saveRoutines(user.id, routines);
    saveCompletions(user.id, completions);
    
    console.log("ルーティン削除完了:", {
        uniqueId: deletedRoutine.id,
        name: deletedRoutine.name
    });
    
    return true;
}

// ルーティン情報表示機能（デバッグ用）
function showRoutineInfo(uniqueId) {
    const routine = findRoutineById(uniqueId);
    if (!routine) {
        console.error("ルーティンが見つかりません:", uniqueId);
        return;
    }
    
    console.log("ルーティン情報:", {
        uniqueId: routine.id,
        displayId: routine.displayId,
        name: routine.name,
        desc: routine.desc,
        frequency: routine.frequency,
        weeklyDays: routine.weeklyDays,
        monthlyDate: routine.monthlyDate,
        userId: routine.userId,
        createdAt: routine.createdAt,
        lastModified: routine.lastModified
    });
    
    // 完了データも表示
    const user = getCurrentUser();
    if (user) {
        const completions = getCompletions(user.id);
        const routineCompletions = completions.filter(c => c.rid === uniqueId);
        console.log("完了データ:", routineCompletions);
    }
}

// 全ルーティンの一覧表示（デバッグ用）
function listAllRoutines() {
    const user = getCurrentUser();
    if (!user) {
        console.error("ユーザー情報がありません");
        return;
    }
    
    const routines = getRoutines(user.id);
    console.log("全ルーティン一覧:", routines.map(r => ({
        uniqueId: r.id,
        displayId: r.displayId,
        name: r.name,
        frequency: r.frequency,
        createdAt: r.createdAt
    })));
}

// 既存ルーティンの移行機能
function migrateExistingRoutines() {
    const user = getCurrentUser();
    if (!user) {
        console.error("ユーザー情報がありません");
        return;
    }
    
    const routines = getRoutines(user.id);
    let hasChanges = false;
    
    console.log("既存ルーティンの移行開始:", routines.length, "件");
    
    for (let i = 0; i < routines.length; i++) {
        const routine = routines[i];
        
        // ユニークIDがない場合、追加
        if (!routine.id || routine.id === routine.displayId) {
            const timestamp = Date.now() + i; // 順序を保つため少しずつずらす
            const randomStr = Math.random().toString(36).substring(2, 8);
            const uniqueId = `${timestamp}_${randomStr}`;
            
            routines[i] = {
                ...routine,
                id: uniqueId,
                displayId: routine.id || routine.displayId || Date.now().toString(),
                createdAt: routine.createdAt || new Date().toISOString(),
                lastModified: new Date().toISOString()
            };
            
            hasChanges = true;
            console.log("ルーティン移行完了:", {
                name: routine.name,
                oldId: routine.id,
                newUniqueId: uniqueId,
                displayId: routines[i].displayId
            });
        }
    }
    
    if (hasChanges) {
        saveRoutines(user.id, routines);
        console.log("移行完了 - 保存されたルーティン:", routines.length, "件");
        
        // 完了データも移行
        migrateExistingCompletions();
    } else {
        console.log("移行不要 - すべてのルーティンにユニークIDが設定済み");
    }
}

// 既存完了データの移行機能
function migrateExistingCompletions() {
    const user = getCurrentUser();
    if (!user) return;
    
    const completions = getCompletions(user.id);
    const routines = getRoutines(user.id);
    let hasChanges = false;
    
    console.log("既存完了データの移行開始:", completions.length, "件");
    
    for (let i = 0; i < completions.length; i++) {
        const completion = completions[i];
        
        // ユニークIDがない場合、対応するルーティンを検索して設定
        if (!completion.rid || completion.rid === completion.displayRid) {
            const routine = routines.find(r => 
                r.displayId === completion.rid || 
                r.id === completion.rid ||
                r.displayId === completion.displayRid
            );
            
            if (routine) {
                completions[i] = {
                    ...completion,
                    rid: routine.id,
                    displayRid: routine.displayId,
                    completedAt: completion.completedAt || new Date().toISOString()
                };
                
                hasChanges = true;
                console.log("完了データ移行完了:", {
                    date: completion.date,
                    routineName: routine.name,
                    newRid: routine.id
                });
            }
        }
    }
    
    if (hasChanges) {
        saveCompletions(user.id, completions);
        console.log("完了データ移行完了 - 保存された完了データ:", completions.length, "件");
    } else {
        console.log("完了データ移行不要 - すべての完了データにユニークIDが設定済み");
    }
}

// 初期化時に移行を実行
function runMigrationIfNeeded() {
    const user = getCurrentUser();
    if (!user) return;
    
    const routines = getRoutines(user.id);
    const needsMigration = routines.some(r => !r.id || r.id === r.displayId);
    
    if (needsMigration) {
        console.log("移行が必要なルーティンを検出");
        migrateExistingRoutines();
    } else {
        console.log("移行不要 - すべてのルーティンが最新形式");
    }
}

// 今日のルーティンをテストするための機能
function addTodayTestRoutine() {
    const user = getCurrentUser();
    if (!user) {
        console.error("ユーザー情報がありません");
        return;
    }
    
    const today = new Date();
    const todayDay = today.getDay();
    const todayDate = today.getDate();
    
    console.log("今日のテストルーティンを追加:", {
        today: todayDay,
        todayDate: todayDate,
        todayString: today.toLocaleDateString('ja-JP', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        })
    });
    
    const routines = getRoutines(user.id);
    
    // 今日の曜日に合わせた週次ルーティンを追加
    const weeklyRoutine = {
        id: `${Date.now()}_weekly_test`,
        displayId: Date.now().toString(),
        name: `今日の週次テスト (${todayDay}曜日)`,
        desc: "今日の曜日に設定されたテストルーティン",
        frequency: "weekly",
        weeklyDays: [todayDay],
        monthlyDate: null,
        userId: user.id,
        createdAt: new Date().toISOString(),
        lastModified: new Date().toISOString()
    };
    
    // 今日の日付に合わせた月次ルーティンを追加
    const monthlyRoutine = {
        id: `${Date.now()}_monthly_test`,
        displayId: (Date.now() + 1).toString(),
        name: `今日の月次テスト (${todayDate}日)`,
        desc: "今日の日付に設定されたテストルーティン",
        frequency: "monthly",
        weeklyDays: [],
        monthlyDate: todayDate,
        userId: user.id,
        createdAt: new Date().toISOString(),
        lastModified: new Date().toISOString()
    };
    
    // 毎日のルーティンを追加
    const dailyRoutine = {
        id: `${Date.now()}_daily_test`,
        displayId: (Date.now() + 2).toString(),
        name: "今日の毎日テスト",
        desc: "毎日実行されるテストルーティン",
        frequency: "daily",
        weeklyDays: [],
        monthlyDate: null,
        userId: user.id,
        createdAt: new Date().toISOString(),
        lastModified: new Date().toISOString()
    };
    
    routines.push(weeklyRoutine, monthlyRoutine, dailyRoutine);
    saveRoutines(user.id, routines);
    
    console.log("テストルーティン追加完了:", {
        weekly: weeklyRoutine.name,
        monthly: monthlyRoutine.name,
        daily: dailyRoutine.name
    });
    
    // 画面を再描画
    renderMain();
}

// テスト用ボタンを追加
function addTestButton() {
    const mainView = $('mainView');
    if (!mainView) return;
    
    // 既存のテストボタンを削除
    const existingTestBtn = document.querySelector('#testButton');
    if (existingTestBtn) {
        existingTestBtn.remove();
    }
    
    const testButton = document.createElement('button');
    testButton.id = 'testButton';
    testButton.textContent = 'テスト追加';
    testButton.className = 'secondary';
    testButton.style.marginLeft = '8px';
    testButton.onclick = () => {
        addTodayTestRoutine();
    };
    
    // ログアウトボタンの横にテストボタンを追加
    const logoutBtn = $('logoutBtn');
    if (logoutBtn && logoutBtn.parentNode) {
        logoutBtn.parentNode.appendChild(testButton);
    }
}

// ルーティン削除のUI処理
function deleteRoutineFromUI(uniqueId) {
    const routine = findRoutineById(uniqueId);
    if (!routine) {
        console.error("削除対象のルーティンが見つかりません:", uniqueId);
        alert("ルーティンが見つかりません");
        return;
    }
    
    console.log("ルーティン削除確認:", {
        uniqueId: routine.id,
        name: routine.name,
        frequency: routine.frequency
    });
    
    // 削除確認ダイアログ
    const confirmMessage = `ルーティン「${routine.name}」を削除しますか？\n\nこの操作は取り消せません。`;
    if (!confirm(confirmMessage)) {
        console.log("削除をキャンセルしました");
        return;
    }
    
    // 削除実行
    const success = deleteRoutine(uniqueId);
    if (success) {
        console.log("ルーティン削除完了:", routine.name);
        alert(`ルーティン「${routine.name}」を削除しました`);
        
        // 画面を再描画
        renderMain();
        
        // 自動同期
        if (currentStorage === 'firebase') {
            syncToFirebase();
        }
    } else {
        console.error("ルーティン削除に失敗しました");
        alert("ルーティンの削除に失敗しました");
    }
}

// 複数ルーティンの一括削除機能
function deleteMultipleRoutines(routineIds) {
    if (!Array.isArray(routineIds) || routineIds.length === 0) {
        console.error("削除対象のルーティンIDが指定されていません");
        return;
    }
    
    console.log("複数ルーティン削除開始:", routineIds.length, "件");
    
    const routines = routineIds.map(id => findRoutineById(id)).filter(r => r !== null);
    if (routines.length === 0) {
        alert("削除対象のルーティンが見つかりません");
        return;
    }
    
    // 削除確認ダイアログ
    const routineNames = routines.map(r => r.name).join("\n• ");
    const confirmMessage = `以下のルーティンを削除しますか？\n\n• ${routineNames}\n\nこの操作は取り消せません。`;
    if (!confirm(confirmMessage)) {
        console.log("一括削除をキャンセルしました");
        return;
    }
    
    // 削除実行
    let successCount = 0;
    for (const routine of routines) {
        const success = deleteRoutine(routine.id);
        if (success) {
            successCount++;
        }
    }
    
    console.log("一括削除完了:", successCount, "/", routines.length, "件");
    alert(`${successCount}件のルーティンを削除しました`);
    
    // 画面を再描画
    renderMain();
    
    // 自動同期
    if (currentStorage === 'firebase') {
        syncToFirebase();
    }
}

// 完了データの一括削除機能
function deleteAllCompletions() {
    const user = getCurrentUser();
    if (!user) {
        console.error("ユーザー情報がありません");
        return;
    }
    
    const completions = getCompletions(user.id);
    if (completions.length === 0) {
        alert("削除する完了データがありません");
        return;
    }
    
    const confirmMessage = `すべての完了データ（${completions.length}件）を削除しますか？\n\nこの操作は取り消せません。`;
    if (!confirm(confirmMessage)) {
        console.log("完了データ削除をキャンセルしました");
        return;
    }
    
    // 完了データをクリア
    saveCompletions(user.id, []);
    console.log("完了データ削除完了:", completions.length, "件");
    alert(`${completions.length}件の完了データを削除しました`);
    
    // 画面を再描画
    renderMain();
    
    // 自動同期
    if (currentStorage === 'firebase') {
        syncToFirebase();
    }
}

// 管理機能用ボタンを追加
function addManagementButtons() {
    const mainView = $('mainView');
    if (!mainView) return;
    
    // 既存の管理ボタンを削除
    const existingManageBtn = document.querySelector('#manageButton');
    if (existingManageBtn) {
        existingManageBtn.remove();
    }
    
    const manageButton = document.createElement('button');
    manageButton.id = 'manageButton';
    manageButton.textContent = '管理';
    manageButton.className = 'secondary';
    manageButton.style.marginLeft = '8px';
    manageButton.onclick = () => {
        showManagementMenu();
    };
    
    // ログアウトボタンの横に管理ボタンを追加
    const logoutBtn = $('logoutBtn');
    if (logoutBtn && logoutBtn.parentNode) {
        logoutBtn.parentNode.appendChild(manageButton);
    }
}

// 管理メニューの表示
function showManagementMenu() {
    const user = getCurrentUser();
    if (!user) return;
    
    const routines = getRoutines(user.id);
    const completions = getCompletions(user.id);
    
    const menuItems = [
        `ルーティン管理 (${routines.length}件)`,
        `完了データ削除 (${completions.length}件)`,
        'テストルーティン削除',
        '全データリセット',
        'キャンセル'
    ];
    
    const selected = prompt(
        '管理メニュー\n\n' + 
        menuItems.map((item, index) => `${index + 1}. ${item}`).join('\n') +
        '\n\n番号を入力してください:'
    );
    
    if (!selected) return;
    
    const choice = parseInt(selected);
    switch (choice) {
        case 1:
            showRoutineManagement();
            break;
        case 2:
            deleteAllCompletions();
            break;
        case 3:
            deleteTestRoutines();
            break;
        case 4:
            resetAllData();
            break;
        case 5:
            console.log('管理メニューをキャンセルしました');
            break;
        default:
            alert('無効な選択です');
    }
}

// ルーティン管理画面
function showRoutineManagement() {
    const user = getCurrentUser();
    if (!user) return;
    
    const routines = getRoutines(user.id);
    if (routines.length === 0) {
        alert('管理するルーティンがありません');
        return;
    }
    
    const routineList = routines.map((r, index) => 
        `${index + 1}. ${r.name} (${getFreqText(r.frequency)})`
    ).join('\n');
    
    const selected = prompt(
        'ルーティン管理\n\n' + 
        routineList +
        '\n\n削除するルーティンの番号を入力してください（複数の場合はカンマ区切り）:\n' +
        '例: 1,3,5'
    );
    
    if (!selected) return;
    
    const indices = selected.split(',').map(s => parseInt(s.trim()) - 1).filter(i => !isNaN(i) && i >= 0 && i < routines.length);
    
    if (indices.length === 0) {
        alert('有効な番号が選択されていません');
        return;
    }
    
    const selectedRoutines = indices.map(i => routines[i]);
    const routineIds = selectedRoutines.map(r => r.id);
    
    deleteMultipleRoutines(routineIds);
}

// テストルーティンの削除
function deleteTestRoutines() {
    const user = getCurrentUser();
    if (!user) return;
    
    const routines = getRoutines(user.id);
    const testRoutines = routines.filter(r => 
        r.name.includes('テスト') || 
        r.name.includes('test') ||
        r.id.includes('_test')
    );
    
    if (testRoutines.length === 0) {
        alert('削除するテストルーティンがありません');
        return;
    }
    
    const routineIds = testRoutines.map(r => r.id);
    deleteMultipleRoutines(routineIds);
}

// 全データリセット
function resetAllData() {
    const user = getCurrentUser();
    if (!user) return;
    
    const confirmMessage = `すべてのデータをリセットしますか？\n\nこの操作は取り消せません。\n\n• ルーティン: ${getRoutines(user.id).length}件\n• 完了データ: ${getCompletions(user.id).length}件`;
    if (!confirm(confirmMessage)) {
        console.log('データリセットをキャンセルしました');
        return;
    }
    
    // データをクリア
    saveRoutines(user.id, []);
    saveCompletions(user.id, []);
    
    console.log('全データリセット完了');
    alert('すべてのデータをリセットしました');
    
    // 画面を再描画
    renderMain();
    
    // 自動同期
    if (currentStorage === 'firebase') {
        syncToFirebase();
    }
}
</script>
</body>
</html>
