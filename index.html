<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Routine - ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        body { font-family: sans-serif; background: #f6f8fa; margin: 0; }
        .center { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .card { background: #fff; padding: 32px 24px; border-radius: 12px; box-shadow: 0 4px 16px #0001; min-width: 320px; max-width: 400px; }
        h1, h2 { text-align: center; }
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; font-weight: bold; }
        input[type=email], input[type=password], input[type=text], input[type=number], textarea {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px;
        }
        button, .btn { padding: 10px 18px; border: none; border-radius: 6px; background: #667eea; color: #fff; font-size: 16px; cursor: pointer; margin-right: 8px; }
        button.secondary, .btn.secondary { background: #aaa; }
        .link-btn { background: none; color: #667eea; border: none; cursor: pointer; text-decoration: underline; font-size: 15px; margin: 0 8px; }
        .routine-list { margin: 0; padding: 0; list-style: none; }
        .routine-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .routine-item:last-child { border-bottom: none; }
        .routine-item.completed h3 { text-decoration: line-through; color: #aaa; }
        .frequency { font-size: 12px; color: #667eea; margin-left: 8px; }
        .tabs { display: flex; gap: 8px; margin-bottom: 12px; }
        .tab { padding: 6px 14px; border-radius: 6px; border: 1px solid #667eea; background: #fff; color: #667eea; cursor: pointer; }
        .tab.active { background: #667eea; color: #fff; }
        .mt-2 { margin-top: 16px; }
        .mb-2 { margin-bottom: 16px; }
        .hidden { display: none !important; }
        .sync-status { 
            position: fixed; top: 10px; right: 10px; 
            padding: 8px 12px; border-radius: 6px; font-size: 12px; 
            background: #28a745; color: white; z-index: 1000;
        }
        .sync-status.error { background: #dc3545; }
        .sync-status.syncing { background: #ffc107; color: #000; }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
<div id="authView" class="center">
    <div class="card">
        <h1>My Routine</h1>
        <form id="loginForm">
            <div class="form-group">
                <label for="loginEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                <input type="email" id="loginEmail" required>
            </div>
            <div class="form-group">
                <label for="loginPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="loginPassword" required>
            </div>
            <button type="submit">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </form>
        <div class="mt-2" style="text-align:center;">
            <button class="link-btn" id="showRegister">æ–°è¦ç™»éŒ²</button>
            <button class="link-btn" id="demoLogin">ãƒ‡ãƒ¢ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
    </div>
</div>
<div id="registerView" class="center hidden">
    <div class="card">
        <h2>æ–°è¦ç™»éŒ²</h2>
        <form id="registerForm">
            <div class="form-group">
                <label for="registerEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                <input type="email" id="registerEmail" required>
            </div>
            <div class="form-group">
                <label for="registerPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="registerPassword" required>
            </div>
            <button type="submit">ç™»éŒ²</button>
            <button type="button" class="secondary" id="backToLogin">æˆ»ã‚‹</button>
        </form>
    </div>
</div>
<div id="mainView" class="center hidden">
    <div class="card" style="width:100%;max-width:500px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <h2 style="margin-bottom:0;">ä»Šæ—¥ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³</h2>
            <button id="logoutBtn" class="secondary">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
        <ul id="todayList" class="routine-list mb-2"></ul>
        <div class="tabs mb-2">
            <button class="tab active" data-freq="all">å…¨ã¦</button>
            <button class="tab" data-freq="daily">æ¯æ—¥</button>
            <button class="tab" data-freq="weekly">æ¯é€±</button>
            <button class="tab" data-freq="monthly">æ¯æœˆ</button>
        </div>
        <ul id="allList" class="routine-list mb-2"></ul>
        <button id="showAddRoutine" class="mt-2">ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¿½åŠ </button>
    </div>
</div>
<div id="addRoutineView" class="center hidden">
    <div class="card">
        <h2>ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¿½åŠ </h2>
        <form id="addRoutineForm">
            <div class="form-group">
                <label for="routineName">ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³å</label>
                <input type="text" id="routineName" required>
            </div>
            <div class="form-group">
                <label for="routineDesc">èª¬æ˜ï¼ˆä»»æ„ï¼‰</label>
                <textarea id="routineDesc" rows="2"></textarea>
            </div>
            <div class="form-group">
                <label>é »åº¦</label>
                <div class="tabs">
                    <button type="button" class="tab active" data-freq="daily">æ¯æ—¥</button>
                    <button type="button" class="tab" data-freq="weekly">æ¯é€±</button>
                    <button type="button" class="tab" data-freq="monthly">æ¯æœˆ</button>
                </div>
            </div>
            <div class="form-group hidden" id="weeklyDays">
                <label>æ›œæ—¥</label>
                <div>
                    <label><input type="checkbox" value="0">æ—¥</label>
                    <label><input type="checkbox" value="1">æœˆ</label>
                    <label><input type="checkbox" value="2">ç«</label>
                    <label><input type="checkbox" value="3">æ°´</label>
                    <label><input type="checkbox" value="4">æœ¨</label>
                    <label><input type="checkbox" value="5">é‡‘</label>
                    <label><input type="checkbox" value="6">åœŸ</label>
                </div>
            </div>
            <div class="form-group hidden" id="monthlyDate">
                <label>æ—¥ä»˜</label>
                <input type="number" id="monthlyDateInput" min="1" max="31">
            </div>
            <button type="submit">ä¿å­˜</button>
            <button type="button" class="secondary" id="cancelAddRoutine">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </form>
    </div>
</div>
<div id="syncStatus" class="sync-status"></div>
<script>
// --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
function $(id) { 
    const element = document.getElementById(id);
    if (!element) {
        console.error("è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", id);
    }
    return element;
}
function show(view) {
    console.log("ç”»é¢åˆ‡ã‚Šæ›¿ãˆ:", view);
    ["authView","registerView","mainView","addRoutineView"].forEach(v=>{
        const element = $(v);
        if (element) element.classList.add("hidden");
    });
    const targetElement = $(view);
    if (targetElement) targetElement.classList.remove("hidden");
}
function getUserList() {
    try {
        const users = JSON.parse(localStorage.getItem("users")||"[]");
        console.log("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆå–å¾—:", users.length, "ä»¶");
        return users;
    } catch (error) {
        console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:", error);
        return [];
    }
}
function saveUserList(users) {
    try {
        localStorage.setItem("users",JSON.stringify(users));
        console.log("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆä¿å­˜å®Œäº†:", users.length, "ä»¶");
    } catch (error) {
        console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
    }
}
function getCurrentUser() {
    try {
        const user = JSON.parse(localStorage.getItem("currentUser")||"null");
        console.log("ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—:", user);
        return user;
    } catch (error) {
        console.error("ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
        return null;
    }
}
function setCurrentUser(user) {
    try {
        localStorage.setItem("currentUser",JSON.stringify(user));
        console.log("ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š:", user);
    } catch (error) {
        console.error("ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼:", error);
    }
}
function clearCurrentUser() {
    try {
        localStorage.removeItem("currentUser");
        console.log("ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤å®Œäº†");
    } catch (error) {
        console.error("ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
    }
}
function getRoutines(uid) {
    try {
        const routines = JSON.parse(localStorage.getItem("routines_"+uid)||"[]");
        console.log("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³å–å¾—:", uid, routines.length, "ä»¶");
        return routines;
    } catch (error) {
        console.error("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
        return [];
    }
}
function saveRoutines(uid, routines) {
    try {
        localStorage.setItem("routines_"+uid,JSON.stringify(routines));
        console.log("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ä¿å­˜å®Œäº†:", uid, routines.length, "ä»¶");
    } catch (error) {
        console.error("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
    }
}
function getCompletions(uid) {
    try {
        const completions = JSON.parse(localStorage.getItem("completions_"+uid)||"[]");
        console.log("å®Œäº†ãƒ‡ãƒ¼ã‚¿å–å¾—:", uid, completions.length, "ä»¶");
        return completions;
    } catch (error) {
        console.error("å®Œäº†ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
        return [];
    }
}
function saveCompletions(uid, completions) {
    try {
        localStorage.setItem("completions_"+uid,JSON.stringify(completions));
        console.log("å®Œäº†ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†:", uid, completions.length, "ä»¶");
    } catch (error) {
        console.error("å®Œäº†ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
    }
}
// --- èªè¨¼ ---
function tryLogin(email, password) {
    console.log("ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ:", email);
    const users = getUserList();
    console.log("ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:", users.length);
    const user = users.find(u=>u.email===email&&u.password===password);
    console.log("ãƒ­ã‚°ã‚¤ãƒ³çµæœ:", user ? "æˆåŠŸ" : "å¤±æ•—");
    return user || null;
}
function tryRegister(email, password) {
    console.log("ç™»éŒ²è©¦è¡Œ:", email);
    let users = getUserList();
    if(users.find(u=>u.email===email)) {
        console.log("æ—¢ã«ç™»éŒ²æ¸ˆã¿");
        return false;
    }
    const user = {id:Date.now().toString(),email,password};
    users.push(user); 
    saveUserList(users); 
    console.log("ç™»éŒ²æˆåŠŸ:", user);
    return user;
}
// --- ç”»é¢é·ç§» ---
$("showRegister").onclick = ()=>{ show("registerView"); };
$("backToLogin").onclick = ()=>{ show("authView"); };
$("demoLogin").onclick = ()=>{
    console.log("ãƒ‡ãƒ¢ãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œ");
    setCurrentUser({id:"demo",email:"demo@example.com"});
    showMain();
};
$("logoutBtn").onclick = ()=>{ 
    console.log("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Ÿè¡Œ");
    clearCurrentUser(); 
    show("authView"); 
};
$("showAddRoutine").onclick = ()=>{ 
    console.log("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¿½åŠ ç”»é¢è¡¨ç¤º");
    clearAddRoutineForm();
    show("addRoutineView"); 
};
$("cancelAddRoutine").onclick = ()=>{ 
    console.log("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¿½åŠ ã‚­ãƒ£ãƒ³ã‚»ãƒ«");
    clearAddRoutineForm();
    show("mainView"); 
};
// --- ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ç™»éŒ² ---
$("loginForm").onsubmit = e=>{
    e.preventDefault();
    console.log("ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡");
    const email = $("loginEmail").value, pw = $("loginPassword").value;
    console.log("å…¥åŠ›å€¤:", {email, password: pw ? "å…¥åŠ›æ¸ˆã¿" : "æœªå…¥åŠ›"});
    
    if (!email || !pw) {
        alert("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
    }
    
    const user = tryLogin(email,pw);
    if(user) { 
        console.log("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸã€ãƒ¡ã‚¤ãƒ³ç”»é¢è¡¨ç¤º");
        setCurrentUser(user); 
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ç”¨
        currentStorage = 'local';
        localStorage.setItem('storageType', 'local');
        
        // æ—¢å­˜ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã®ç§»è¡Œã‚’å®Ÿè¡Œ
        runMigrationIfNeeded();
        
        showMain(); 
    }
    else {
        console.log("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—");
        alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");
    }
};
$("registerForm").onsubmit = e=>{
    e.preventDefault();
    console.log("ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡");
    const email = $("registerEmail").value, pw = $("registerPassword").value;
    console.log("å…¥åŠ›å€¤:", {email, password: pw ? "å…¥åŠ›æ¸ˆã¿" : "æœªå…¥åŠ›"});
    
    if (!email || !pw) {
        alert("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
    }
    
    const user = tryRegister(email,pw);
    if(user) { 
        console.log("ç™»éŒ²æˆåŠŸã€ãƒ¡ã‚¤ãƒ³ç”»é¢è¡¨ç¤º");
        setCurrentUser(user); 
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ç”¨
        currentStorage = 'local';
        localStorage.setItem('storageType', 'local');
        
        // æ—¢å­˜ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã®ç§»è¡Œã‚’å®Ÿè¡Œ
        runMigrationIfNeeded();
        
        showMain(); 
    }
    else {
        console.log("ç™»éŒ²å¤±æ•—");
        alert("æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™");
    }
};
// --- ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¿½åŠ  ---
let addFreq = "daily";

// ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢é–¢æ•°
function clearAddRoutineForm() {
    console.log("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢");
    try {
        // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
        $("routineName").value = "";
        $("routineDesc").value = "";
        $("monthlyDateInput").value = "";
        
        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
        [...$("weeklyDays").querySelectorAll("input[type=checkbox]")].forEach(cb => {
            cb.checked = false;
        });
        
        // é »åº¦ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
        addFreq = "daily";
        [...document.querySelectorAll("#addRoutineForm .tab")].forEach(b => b.classList.remove("active"));
        document.querySelector("#addRoutineForm .tab[data-freq='daily']").classList.add("active");
        
        // ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®ã‚’éè¡¨ç¤º
        $("weeklyDays").classList.add("hidden");
        $("monthlyDate").classList.add("hidden");
        
        console.log("ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢å®Œäº†");
    } catch (error) {
        console.error("ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:", error);
    }
}

[...document.querySelectorAll("#addRoutineForm .tab")].forEach(btn=>{
    btn.onclick = function(){
        [...document.querySelectorAll("#addRoutineForm .tab")].forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        addFreq = btn.dataset.freq;
        $("weeklyDays").classList.toggle("hidden",addFreq!=="weekly");
        $("monthlyDate").classList.toggle("hidden",addFreq!=="monthly");
    };
});
$("addRoutineForm").onsubmit = e=>{
    e.preventDefault();
    console.log("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡");
    const user = getCurrentUser();
    if(!user) {
        console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“");
        return;
    }
    
    const name = $("routineName").value.trim();
    if(!name) {
        alert("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³åå¿…é ˆ");
        return;
    }
    
    const desc = $("routineDesc").value.trim();
    let weeklyDays = [], monthlyDate = null;
    
    if(addFreq==="weekly") {
        weeklyDays = [...$("weeklyDays").querySelectorAll("input:checked")].map(i=>parseInt(i.value));
    }
    if(addFreq==="monthly") {
        monthlyDate = parseInt($("monthlyDateInput").value)||null;
    }
    
    if(addFreq==="weekly" && weeklyDays.length===0) {
        alert("æ›œæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„");
        return;
    }
    if(addFreq==="monthly" && (!monthlyDate||monthlyDate<1||monthlyDate>31)) {
        alert("æ—¥ä»˜1-31");
        return;
    }
    
    const routines = getRoutines(user.id);
    
    // ãƒ¦ãƒ‹ãƒ¼ã‚¯IDã‚’ç”Ÿæˆï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— + ãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—åˆ—ï¼‰
    const timestamp = Date.now();
    const randomStr = Math.random().toString(36).substring(2, 8);
    const uniqueId = `${timestamp}_${randomStr}`;
    
    const newRoutine = {
        id: uniqueId, // ãƒ¦ãƒ‹ãƒ¼ã‚¯ID
        displayId: Date.now().toString(), // è¡¨ç¤ºç”¨IDï¼ˆå¾“æ¥ã®IDï¼‰
        name,
        desc,
        frequency: addFreq,
        weeklyDays,
        monthlyDate,
        userId: user.id,
        createdAt: new Date().toISOString(),
        lastModified: new Date().toISOString()
    };
    
    routines.push(newRoutine);
    saveRoutines(user.id, routines);
    console.log("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¿½åŠ å®Œäº†:", {
        uniqueId: newRoutine.id,
        displayId: newRoutine.displayId,
        name: newRoutine.name,
        frequency: newRoutine.frequency
    });
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒ¡ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
    clearAddRoutineForm();
    show("mainView");
    renderMain();
};
// --- ã‚¿ãƒ–åˆ‡æ›¿ ---
[...document.querySelectorAll("#mainView .tab")].forEach(btn=>{
    btn.onclick = function(){
        [...document.querySelectorAll("#mainView .tab")].forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        renderMain();
    };
});
// --- ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³å®Œäº† ---
function toggleComplete(rid){
    console.log("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³å®Œäº†åˆ‡ã‚Šæ›¿ãˆ:", rid);
    const user = getCurrentUser();
    if(!user) return;
    
    let completions = getCompletions(user.id);
    const today = new Date().toISOString().split("T")[0];
    
    // ãƒ¦ãƒ‹ãƒ¼ã‚¯IDã¾ãŸã¯è¡¨ç¤ºIDã§ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’æ¤œç´¢
    const routines = getRoutines(user.id);
    const routine = routines.find(r => r.id === rid || r.displayId === rid);
    
    if (!routine) {
        console.error("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", rid);
        return;
    }
    
    console.log("å¯¾è±¡ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³:", {
        uniqueId: routine.id,
        displayId: routine.displayId,
        name: routine.name
    });
    
    // ãƒ¦ãƒ‹ãƒ¼ã‚¯IDã§å®Œäº†ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†
    const idx = completions.findIndex(c=>c.rid===routine.id&&c.date===today);
    if(idx!==-1) {
        completions.splice(idx,1);
        console.log("å®Œäº†ã‚’è§£é™¤:", routine.name);
    } else {
        completions.push({
            rid: routine.id, // ãƒ¦ãƒ‹ãƒ¼ã‚¯IDã‚’ä½¿ç”¨
            displayRid: routine.displayId, // è¡¨ç¤ºIDã‚‚ä¿å­˜
            date: today,
            completedAt: new Date().toISOString()
        });
        console.log("å®Œäº†ã‚’è¨­å®š:", routine.name);
    }
    
    saveCompletions(user.id,completions);
    renderMain();
}
// --- ãƒ¡ã‚¤ãƒ³ç”»é¢æç”» ---
function showMain(){ 
    console.log("ãƒ¡ã‚¤ãƒ³ç”»é¢è¡¨ç¤ºé–‹å§‹");
    show("mainView"); 
    addSyncButton(); // åŒæœŸãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    addTestButton(); // ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    addManagementButtons(); // ç®¡ç†ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    renderMain(); 
}
function renderMain(){
    console.log("ãƒ¡ã‚¤ãƒ³ç”»é¢æç”»é–‹å§‹");
    const user = getCurrentUser();
    if(!user) {
        console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“");
        show("authView");
        return;
    }
    
    try {
        $("todayList").innerHTML = "";
        $("allList").innerHTML = "";
        const routines = getRoutines(user.id);
        const completions = getCompletions(user.id);
        const today = new Date();
        console.log("æç”»ãƒ‡ãƒ¼ã‚¿:", {routines: routines.length, completions: completions.length});
        
        // ä»Šæ—¥ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³
        const todayR = routines.filter(r=>{
            const todayDay = today.getDay(); // 0=æ—¥æ›œæ—¥, 1=æœˆæ›œæ—¥, ..., 6=åœŸæ›œæ—¥
            const todayDate = today.getDate(); // 1-31
            
            console.log('ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°:', {
                name: r.name,
                frequency: r.frequency,
                weeklyDays: r.weeklyDays,
                monthlyDate: r.monthlyDate,
                today: todayDay,
                todayDate: todayDate,
                todayString: today.toLocaleDateString('ja-JP', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                })
            });
            
            if(r.frequency==="daily") {
                console.log('æ¯æ—¥ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³:', r.name);
                return true;
            }
            if(r.frequency==="weekly") {
                const isToday = r.weeklyDays && r.weeklyDays.includes(todayDay);
                console.log('é€±æ¬¡ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³:', r.name, 'ä»Šæ—¥ã‹ã©ã†ã‹:', isToday, 'è¨­å®šæ›œæ—¥:', r.weeklyDays, 'ä»Šæ—¥ã®æ›œæ—¥:', todayDay);
                return isToday;
            }
            if(r.frequency==="monthly") {
                const isToday = r.monthlyDate === todayDate;
                console.log('æœˆæ¬¡ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³:', r.name, 'ä»Šæ—¥ã‹ã©ã†ã‹:', isToday, 'è¨­å®šæ—¥:', r.monthlyDate, 'ä»Šæ—¥ã®æ—¥:', todayDate);
                return isToday;
            }
            console.log('ä¸æ˜ãªé »åº¦:', r.name, r.frequency);
            return false;
        });
        console.log("ä»Šæ—¥ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³:", todayR.length, "ä»¶");
        
        for(const r of todayR){
            const done = completions.some(c=>c.rid===r.id&&c.date===today.toISOString().split("T")[0]);
            const li = document.createElement("li");
            li.className = "routine-item"+(done?" completed":"");
            li.innerHTML = `
                <div>
                    <h3>${r.name}</h3>
                    ${r.desc?`<div>${r.desc}</div>`:""}
                    <span class="frequency">${getFreqText(r.frequency)}</span>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <button onclick="toggleComplete('${r.id}')" data-routine-id="${r.id}" data-display-id="${r.displayId}">${done?"âœ“":"â—‹"}</button>
                    <button onclick="deleteRoutineFromUI('${r.id}')" class="delete-btn" style="background:#dc3545;padding:6px 10px;font-size:12px;">å‰Šé™¤</button>
                </div>
            `;
            $("todayList").appendChild(li);
        }
        
        // å…¨ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³
        const freq = document.querySelector("#mainView .tab.active").dataset.freq;
        const allR = freq==="all"?routines:routines.filter(r=>r.frequency===freq);
        console.log("è¡¨ç¤ºãƒ«ãƒ¼ãƒ†ã‚£ãƒ³:", freq, allR.length, "ä»¶");
        
        for(const r of allR){
            const done = completions.some(c=>c.rid===r.id&&c.date===today.toISOString().split("T")[0]);
            const li = document.createElement("li");
            li.className = "routine-item"+(done?" completed":"");
            li.innerHTML = `
                <div>
                    <h3>${r.name}</h3>
                    ${r.desc?`<div>${r.desc}</div>`:""}
                    <span class="frequency">${getFreqText(r.frequency)}</span>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <button onclick="toggleComplete('${r.id}')" data-routine-id="${r.id}" data-display-id="${r.displayId}">${done?"âœ“":"â—‹"}</button>
                    <button onclick="deleteRoutineFromUI('${r.id}')" class="delete-btn" style="background:#dc3545;padding:6px 10px;font-size:12px;">å‰Šé™¤</button>
                </div>
            `;
            $("allList").appendChild(li);
        }
        
        console.log("ãƒ¡ã‚¤ãƒ³ç”»é¢æç”»å®Œäº†");
    } catch (error) {
        console.error("ãƒ¡ã‚¤ãƒ³ç”»é¢æç”»ã‚¨ãƒ©ãƒ¼:", error);
        alert("ç”»é¢æç”»ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
    }
}
function getFreqText(f){ return f==="daily"?"æ¯æ—¥":f==="weekly"?"æ¯é€±":f==="monthly"?"æ¯æœˆ":f; }
// --- åˆæœŸè¡¨ç¤º ---
window.onload = async function(){
    console.log("ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†");
    try {
        // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ã‚’ç¢ºèª
        const storageType = localStorage.getItem('storageType') || 'local';
        currentStorage = storageType;
        console.log("ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—:", currentStorage);
        
        const user = getCurrentUser();
        console.log("ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼:", user);
        
        if(user) {
            console.log("ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã€ãƒ¡ã‚¤ãƒ³ç”»é¢è¡¨ç¤º");
            
            // æ—¢å­˜ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã®ç§»è¡Œã‚’å®Ÿè¡Œ
            runMigrationIfNeeded();
            
            // FirebaseåŒæœŸãŒæœ‰åŠ¹ãªå ´åˆã€åˆæœŸåŒæœŸã‚’å®Ÿè¡Œ
            if (currentStorage === 'firebase' && typeof firebase !== 'undefined') {
                console.log("FirebaseåˆæœŸåŒæœŸé–‹å§‹");
                try {
                    await syncFromFirebase();
                    console.log("FirebaseåˆæœŸåŒæœŸå®Œäº†");
                } catch (error) {
                    console.error("FirebaseåˆæœŸåŒæœŸã‚¨ãƒ©ãƒ¼:", error);
                }
            } else {
                console.log("FirebaseåŒæœŸãŒç„¡åŠ¹ã¾ãŸã¯Firebase SDKãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“");
                console.log("ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—:", currentStorage);
                console.log("Firebase SDK:", typeof firebase !== 'undefined' ? 'èª­ã¿è¾¼ã¿æ¸ˆã¿' : 'æœªèª­ã¿è¾¼ã¿');
            }
            
            showMain();
        }
        else {
            console.log("æœªãƒ­ã‚°ã‚¤ãƒ³ã€èªè¨¼ç”»é¢è¡¨ç¤º");
            show("authView");
        }
    } catch (error) {
        console.error("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
        alert("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
        show("authView");
    }
};

// --- åŒæœŸæ©Ÿèƒ½ ---
let currentStorage = 'local'; // 'local' ã¾ãŸã¯ 'firebase'
let syncStatus = 'idle'; // 'idle', 'syncing', 'success', 'error'

// åŒæœŸçŠ¶æ…‹è¡¨ç¤º
function updateSyncStatus(status, message = '') {
    const statusElement = $('syncStatus');
    if (!statusElement) return;
    
    syncStatus = status;
    statusElement.className = `sync-status ${status}`;
    
    switch (status) {
        case 'syncing':
            statusElement.textContent = 'ğŸ”„ åŒæœŸä¸­...';
            statusElement.style.animation = 'pulse 1s infinite';
            break;
        case 'success':
            statusElement.textContent = 'âœ… åŒæœŸå®Œäº†';
            statusElement.style.animation = '';
            setTimeout(() => {
                statusElement.textContent = '';
                statusElement.style.animation = '';
            }, 3000);
            break;
        case 'error':
            statusElement.textContent = `âŒ åŒæœŸã‚¨ãƒ©ãƒ¼: ${message}`;
            statusElement.style.animation = '';
            setTimeout(() => {
                statusElement.textContent = '';
                statusElement.style.animation = '';
            }, 5000);
            break;
        default:
            statusElement.textContent = '';
            statusElement.style.animation = '';
    }
    
    console.log('åŒæœŸçŠ¶æ…‹æ›´æ–°:', status, message);
}

// FirebaseåŒæœŸæ©Ÿèƒ½ï¼ˆæ”¹å–„ç‰ˆï¼‰
async function syncToFirebase() {
    if (typeof firebase === 'undefined') {
        console.error('Firebase SDKãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
        return false;
    }
    
    const user = getCurrentUser();
    if (!user) {
        console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“');
        return false;
    }
    
    try {
        updateSyncStatus('syncing');
        console.log('FirebaseåŒæœŸé–‹å§‹ - ãƒ¦ãƒ¼ã‚¶ãƒ¼:', user.email);
        
        const db = firebase.firestore();
        const routines = getRoutines(user.id);
        const completions = getCompletions(user.id);
        
        console.log('åŒæœŸã™ã‚‹ãƒ‡ãƒ¼ã‚¿:', {
            routines: routines.length,
            completions: completions.length,
            routinesData: routines.map(r => ({
                id: r.id,
                displayId: r.displayId,
                name: r.name,
                frequency: r.frequency
            }))
        });
        
        // ãƒãƒƒãƒå‡¦ç†ã§ä¸€æ‹¬ä¿å­˜
        const batch = db.batch();
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ›´æ–°
        const userRef = db.collection('users').doc(user.id);
        batch.set(userRef, {
            email: user.email,
            lastSync: new Date().toISOString(),
            lastSyncDirection: 'upload'
        });
        
        // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        const routinesRef = db.collection('users').doc(user.id).collection('routines').doc('data');
        batch.set(routinesRef, {
            routines: routines,
            lastUpdated: new Date().toISOString(),
            count: routines.length
        });
        
        // å®Œäº†ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        const completionsRef = db.collection('users').doc(user.id).collection('completions').doc('data');
        batch.set(completionsRef, {
            completions: completions,
            lastUpdated: new Date().toISOString(),
            count: completions.length
        });
        
        // ãƒãƒƒãƒå‡¦ç†ã‚’å®Ÿè¡Œ
        await batch.commit();
        
        console.log('FirebaseåŒæœŸå®Œäº† - ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿:', {
            routines: routines.length,
            completions: completions.length
        });
        updateSyncStatus('success');
        return true;
        
    } catch (error) {
        console.error('FirebaseåŒæœŸã‚¨ãƒ©ãƒ¼:', error);
        updateSyncStatus('error', error.message);
        
        // ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
        if (error.code === 'unavailable' || error.code === 'deadline-exceeded') {
            console.log('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®ãŸã‚ã€3ç§’å¾Œã«ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™');
            setTimeout(async () => {
                console.log('ãƒªãƒˆãƒ©ã‚¤é–‹å§‹');
                await syncToFirebase();
            }, 3000);
        }
        
        return false;
    }
}

async function syncFromFirebase() {
    if (typeof firebase === 'undefined') {
        console.error('Firebase SDKãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
        return false;
    }
    
    const user = getCurrentUser();
    if (!user) {
        console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“');
        return false;
    }
    
    try {
        updateSyncStatus('syncing');
        console.log('Firebaseã‹ã‚‰åŒæœŸé–‹å§‹ - ãƒ¦ãƒ¼ã‚¶ãƒ¼:', user.email);
        
        const db = firebase.firestore();
        
        // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const routinesDoc = await db.collection('users').doc(user.id).collection('routines').doc('data').get();
        console.log('Firebaseã‹ã‚‰å–å¾—ã—ãŸãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:', routinesDoc.exists);
        
        if (routinesDoc.exists) {
            const data = routinesDoc.data();
            console.log('Firebaseã‹ã‚‰å–å¾—ã—ãŸãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãƒ‡ãƒ¼ã‚¿:', {
                count: data.routines ? data.routines.length : 0,
                lastUpdated: data.lastUpdated
            });
            
            if (data.routines && Array.isArray(data.routines)) {
                console.log('Firebaseã‹ã‚‰ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’åŒæœŸ:', data.routines.length, 'ä»¶');
                
                // æ—¢å­˜ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã¨ãƒãƒ¼ã‚¸
                const existingRoutines = getRoutines(user.id);
                console.log('æ—¢å­˜ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³:', existingRoutines.length, 'ä»¶');
                
                // æ–°ã—ã„ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã®ã¿ã‚’è¿½åŠ ï¼ˆé‡è¤‡ã‚’é¿ã‘ã‚‹ï¼‰
                const newRoutines = data.routines.filter(fbRoutine => 
                    !existingRoutines.some(localRoutine => localRoutine.id === fbRoutine.id)
                );
                
                if (newRoutines.length > 0) {
                    const mergedRoutines = [...existingRoutines, ...newRoutines];
                    saveRoutines(user.id, mergedRoutines);
                    console.log('ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãƒãƒ¼ã‚¸å®Œäº†:', mergedRoutines.length, 'ä»¶');
                } else {
                    console.log('æ–°ã—ã„ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãªã—ã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ç¶­æŒ');
                }
            }
        } else {
            console.log('Firebaseã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
        }
        
        // å®Œäº†ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const completionsDoc = await db.collection('users').doc(user.id).collection('completions').doc('data').get();
        console.log('Firebaseã‹ã‚‰å–å¾—ã—ãŸå®Œäº†ãƒ‡ãƒ¼ã‚¿ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:', completionsDoc.exists);
        
        if (completionsDoc.exists) {
            const data = completionsDoc.data();
            console.log('Firebaseã‹ã‚‰å–å¾—ã—ãŸå®Œäº†ãƒ‡ãƒ¼ã‚¿:', {
                count: data.completions ? data.completions.length : 0,
                lastUpdated: data.lastUpdated
            });
            
            if (data.completions && Array.isArray(data.completions)) {
                console.log('Firebaseã‹ã‚‰å®Œäº†ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸ:', data.completions.length, 'ä»¶');
                
                // æ—¢å­˜ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã¨ãƒãƒ¼ã‚¸
                const existingCompletions = getCompletions(user.id);
                console.log('æ—¢å­˜ã®ãƒ­ãƒ¼ã‚«ãƒ«å®Œäº†ãƒ‡ãƒ¼ã‚¿:', existingCompletions.length, 'ä»¶');
                
                // æ–°ã—ã„å®Œäº†ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’è¿½åŠ ï¼ˆé‡è¤‡ã‚’é¿ã‘ã‚‹ï¼‰
                const newCompletions = data.completions.filter(fbCompletion => 
                    !existingCompletions.some(localCompletion => 
                        localCompletion.rid === fbCompletion.rid && localCompletion.date === fbCompletion.date
                    )
                );
                
                if (newCompletions.length > 0) {
                    const mergedCompletions = [...existingCompletions, ...newCompletions];
                    saveCompletions(user.id, mergedCompletions);
                    console.log('å®Œäº†ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸å®Œäº†:', mergedCompletions.length, 'ä»¶');
                } else {
                    console.log('æ–°ã—ã„å®Œäº†ãƒ‡ãƒ¼ã‚¿ãªã—ã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ç¶­æŒ');
                }
            }
        } else {
            console.log('Firebaseã«å®Œäº†ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
        }
        
        console.log('Firebaseã‹ã‚‰åŒæœŸå®Œäº†');
        updateSyncStatus('success');
        return true;
        
    } catch (error) {
        console.error('Firebaseã‹ã‚‰åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
        updateSyncStatus('error', error.message);
        
        // ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
        if (error.code === 'unavailable' || error.code === 'deadline-exceeded') {
            console.log('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®ãŸã‚ã€3ç§’å¾Œã«ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™');
            setTimeout(async () => {
                console.log('ãƒªãƒˆãƒ©ã‚¤é–‹å§‹');
                await syncFromFirebase();
            }, 3000);
        }
        
        return false;
    }
}

// åŒæœŸçŠ¶æ…‹ã®è©³ç´°ç¢ºèª
function checkSyncStatus() {
    const user = getCurrentUser();
    if (!user) {
        console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“");
        return;
    }
    
    console.log("=== åŒæœŸçŠ¶æ…‹ç¢ºèª ===");
    console.log("ãƒ¦ãƒ¼ã‚¶ãƒ¼:", user.email);
    console.log("ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:", user.id);
    console.log("ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—:", currentStorage);
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ç¢ºèª
    const localRoutines = getRoutines(user.id);
    const localCompletions = getCompletions(user.id);
    
    console.log("ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿:", {
        routines: localRoutines.length,
        completions: localCompletions.length,
        routinesData: localRoutines.map(r => ({
            id: r.id,
            displayId: r.displayId,
            name: r.name,
            frequency: r.frequency
        }))
    });
    
    // Firebaseãƒ‡ãƒ¼ã‚¿ç¢ºèª
    if (typeof firebase !== 'undefined') {
        checkFirebaseData(user.id);
    } else {
        console.log("Firebase SDKãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“");
    }
}

// Firebaseãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
async function checkFirebaseData(userId) {
    try {
        console.log("Firebaseãƒ‡ãƒ¼ã‚¿ç¢ºèªé–‹å§‹");
        const db = firebase.firestore();
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç¢ºèª
        const userDoc = await db.collection('users').doc(userId).get();
        console.log("Firebaseãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:", userDoc.exists);
        
        if (userDoc.exists) {
            console.log("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±:", userDoc.data());
        }
        
        // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãƒ‡ãƒ¼ã‚¿ç¢ºèª
        const routinesDoc = await db.collection('users').doc(userId).collection('routines').doc('data').get();
        console.log("Firebaseãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:", routinesDoc.exists);
        
        if (routinesDoc.exists) {
            const data = routinesDoc.data();
            console.log("Firebaseãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãƒ‡ãƒ¼ã‚¿:", {
                count: data.routines ? data.routines.length : 0,
                lastUpdated: data.lastUpdated,
                routines: data.routines ? data.routines.map(r => ({
                    id: r.id,
                    displayId: r.displayId,
                    name: r.name,
                    frequency: r.frequency
                })) : []
            });
        }
        
        // å®Œäº†ãƒ‡ãƒ¼ã‚¿ç¢ºèª
        const completionsDoc = await db.collection('users').doc(userId).collection('completions').doc('data').get();
        console.log("Firebaseå®Œäº†ãƒ‡ãƒ¼ã‚¿ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:", completionsDoc.exists);
        
        if (completionsDoc.exists) {
            const data = completionsDoc.data();
            console.log("Firebaseå®Œäº†ãƒ‡ãƒ¼ã‚¿:", {
                count: data.completions ? data.completions.length : 0,
                lastUpdated: data.lastUpdated
            });
        }
        
    } catch (error) {
        console.error("Firebaseãƒ‡ãƒ¼ã‚¿ç¢ºèªã‚¨ãƒ©ãƒ¼:", error);
    }
}

// å¼·åˆ¶åŒæœŸæ©Ÿèƒ½
async function forceSync() {
    console.log("=== å¼·åˆ¶åŒæœŸé–‹å§‹ ===");
    
    const user = getCurrentUser();
    if (!user) {
        console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“");
        return;
    }
    
    try {
        // 1. ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’Firebaseã«å¼·åˆ¶ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        console.log("1. ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’Firebaseã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰");
        await syncToFirebase();
        
        // 2. Firebaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¼·åˆ¶ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        console.log("2. Firebaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰");
        await syncFromFirebase();
        
        // 3. ç”»é¢ã‚’å†æç”»
        console.log("3. ç”»é¢ã‚’å†æç”»");
        renderMain();
        
        console.log("=== å¼·åˆ¶åŒæœŸå®Œäº† ===");
        
    } catch (error) {
        console.error("å¼·åˆ¶åŒæœŸã‚¨ãƒ©ãƒ¼:", error);
    }
}

// åŒæœŸãƒœã‚¿ãƒ³ã«å¼·åˆ¶åŒæœŸæ©Ÿèƒ½ã‚’è¿½åŠ 
function addSyncButton() {
    const mainView = $('mainView');
    if (!mainView) return;
    
    // æ—¢å­˜ã®åŒæœŸãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
    const existingSyncBtn = document.querySelector('#syncButton');
    if (existingSyncBtn) {
        existingSyncBtn.remove();
    }
    
    const syncButton = document.createElement('button');
    syncButton.id = 'syncButton';
    syncButton.textContent = 'åŒæœŸ';
    syncButton.className = 'secondary';
    syncButton.style.marginLeft = '8px';
    syncButton.onclick = async () => {
        console.log('æ‰‹å‹•åŒæœŸé–‹å§‹');
        
        // åŒæœŸãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        syncButton.disabled = true;
        syncButton.textContent = 'åŒæœŸä¸­...';
        
        try {
            // ã¾ãšFirebaseã‹ã‚‰åŒæœŸ
            await syncFromFirebase();
            
            // æ¬¡ã«Firebaseã«åŒæœŸ
            await syncToFirebase();
            
            // ç”»é¢ã‚’å†æç”»
            renderMain();
            
            console.log('æ‰‹å‹•åŒæœŸå®Œäº†');
        } catch (error) {
            console.error('æ‰‹å‹•åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
        } finally {
            // åŒæœŸãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
            syncButton.disabled = false;
            syncButton.textContent = 'åŒæœŸ';
        }
    };
    
    // å¼·åˆ¶åŒæœŸãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    const forceSyncButton = document.createElement('button');
    forceSyncButton.id = 'forceSyncButton';
    forceSyncButton.textContent = 'å¼·åˆ¶åŒæœŸ';
    forceSyncButton.className = 'secondary';
    forceSyncButton.style.marginLeft = '8px';
    forceSyncButton.onclick = async () => {
        console.log('å¼·åˆ¶åŒæœŸé–‹å§‹');
        
        // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        forceSyncButton.disabled = true;
        forceSyncButton.textContent = 'å¼·åˆ¶åŒæœŸä¸­...';
        
        try {
            await forceSync();
        } catch (error) {
            console.error('å¼·åˆ¶åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
        } finally {
            // ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
            forceSyncButton.disabled = false;
            forceSyncButton.textContent = 'å¼·åˆ¶åŒæœŸ';
        }
    };
    
    // ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    const debugButton = document.createElement('button');
    debugButton.id = 'debugButton';
    debugButton.textContent = 'ãƒ‡ãƒãƒƒã‚°';
    debugButton.className = 'secondary';
    debugButton.style.marginLeft = '8px';
    debugButton.onclick = () => {
        checkSyncStatus();
    };
    
    // ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    const testButton = document.createElement('button');
    testButton.id = 'testButton';
    testButton.textContent = 'ãƒ†ã‚¹ãƒˆè¿½åŠ ';
    testButton.className = 'secondary';
    testButton.style.marginLeft = '8px';
    testButton.onclick = () => {
        addTodayTestRoutine();
    };
    
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã®æ¨ªã«ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    const logoutBtn = $('logoutBtn');
    if (logoutBtn && logoutBtn.parentNode) {
        logoutBtn.parentNode.appendChild(syncButton);
        logoutBtn.parentNode.appendChild(forceSyncButton);
        logoutBtn.parentNode.appendChild(debugButton);
        logoutBtn.parentNode.appendChild(testButton);
    }
}

// è‡ªå‹•åŒæœŸï¼ˆãƒ‡ãƒ¼ã‚¿å¤‰æ›´æ™‚ï¼‰
function autoSync() {
    if (currentStorage === 'firebase') {
        syncToFirebase();
    }
}

// ä¿å­˜é–¢æ•°ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¦è‡ªå‹•åŒæœŸã‚’è¿½åŠ 
const originalSaveRoutines = saveRoutines;
const originalSaveCompletions = saveCompletions;

function saveRoutines(uid, routines) {
    try {
        localStorage.setItem("routines_"+uid,JSON.stringify(routines));
        console.log("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ä¿å­˜å®Œäº†:", uid, routines.length, "ä»¶");
        autoSync(); // è‡ªå‹•åŒæœŸ
    } catch (error) {
        console.error("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
    }
}

function saveCompletions(uid, completions) {
    try {
        localStorage.setItem("completions_"+uid,JSON.stringify(completions));
        console.log("å®Œäº†ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†:", uid, completions.length, "ä»¶");
        autoSync(); // è‡ªå‹•åŒæœŸ
    } catch (error) {
        console.error("å®Œäº†ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
    }
}

// --- ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ç®¡ç†æ©Ÿèƒ½ ---
function findRoutineById(uniqueId) {
    const user = getCurrentUser();
    if (!user) return null;
    
    const routines = getRoutines(user.id);
    return routines.find(r => r.id === uniqueId);
}

function findRoutineByDisplayId(displayId) {
    const user = getCurrentUser();
    if (!user) return null;
    
    const routines = getRoutines(user.id);
    return routines.find(r => r.displayId === displayId);
}

function updateRoutine(uniqueId, updates) {
    const user = getCurrentUser();
    if (!user) return false;
    
    const routines = getRoutines(user.id);
    const index = routines.findIndex(r => r.id === uniqueId);
    
    if (index === -1) {
        console.error("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", uniqueId);
        return false;
    }
    
    // æ›´æ–°æƒ…å ±ã‚’ãƒãƒ¼ã‚¸
    routines[index] = {
        ...routines[index],
        ...updates,
        lastModified: new Date().toISOString()
    };
    
    saveRoutines(user.id, routines);
    console.log("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³æ›´æ–°å®Œäº†:", {
        uniqueId: routines[index].id,
        name: routines[index].name,
        updates: updates
    });
    
    return true;
}

function deleteRoutine(uniqueId) {
    const user = getCurrentUser();
    if (!user) return false;
    
    const routines = getRoutines(user.id);
    const index = routines.findIndex(r => r.id === uniqueId);
    
    if (index === -1) {
        console.error("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", uniqueId);
        return false;
    }
    
    const deletedRoutine = routines[index];
    routines.splice(index, 1);
    
    // é–¢é€£ã™ã‚‹å®Œäº†ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤
    let completions = getCompletions(user.id);
    completions = completions.filter(c => c.rid !== uniqueId);
    
    saveRoutines(user.id, routines);
    saveCompletions(user.id, completions);
    
    console.log("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³å‰Šé™¤å®Œäº†:", {
        uniqueId: deletedRoutine.id,
        name: deletedRoutine.name
    });
    
    return true;
}

// ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³æƒ…å ±è¡¨ç¤ºæ©Ÿèƒ½ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
function showRoutineInfo(uniqueId) {
    const routine = findRoutineById(uniqueId);
    if (!routine) {
        console.error("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", uniqueId);
        return;
    }
    
    console.log("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³æƒ…å ±:", {
        uniqueId: routine.id,
        displayId: routine.displayId,
        name: routine.name,
        desc: routine.desc,
        frequency: routine.frequency,
        weeklyDays: routine.weeklyDays,
        monthlyDate: routine.monthlyDate,
        userId: routine.userId,
        createdAt: routine.createdAt,
        lastModified: routine.lastModified
    });
    
    // å®Œäº†ãƒ‡ãƒ¼ã‚¿ã‚‚è¡¨ç¤º
    const user = getCurrentUser();
    if (user) {
        const completions = getCompletions(user.id);
        const routineCompletions = completions.filter(c => c.rid === uniqueId);
        console.log("å®Œäº†ãƒ‡ãƒ¼ã‚¿:", routineCompletions);
    }
}

// å…¨ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã®ä¸€è¦§è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
function listAllRoutines() {
    const user = getCurrentUser();
    if (!user) {
        console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“");
        return;
    }
    
    const routines = getRoutines(user.id);
    console.log("å…¨ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ä¸€è¦§:", routines.map(r => ({
        uniqueId: r.id,
        displayId: r.displayId,
        name: r.name,
        frequency: r.frequency,
        createdAt: r.createdAt
    })));
}

// æ—¢å­˜ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã®ç§»è¡Œæ©Ÿèƒ½
function migrateExistingRoutines() {
    const user = getCurrentUser();
    if (!user) {
        console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“");
        return;
    }
    
    const routines = getRoutines(user.id);
    let hasChanges = false;
    
    console.log("æ—¢å­˜ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã®ç§»è¡Œé–‹å§‹:", routines.length, "ä»¶");
    
    for (let i = 0; i < routines.length; i++) {
        const routine = routines[i];
        
        // ãƒ¦ãƒ‹ãƒ¼ã‚¯IDãŒãªã„å ´åˆã€è¿½åŠ 
        if (!routine.id || routine.id === routine.displayId) {
            const timestamp = Date.now() + i; // é †åºã‚’ä¿ã¤ãŸã‚å°‘ã—ãšã¤ãšã‚‰ã™
            const randomStr = Math.random().toString(36).substring(2, 8);
            const uniqueId = `${timestamp}_${randomStr}`;
            
            routines[i] = {
                ...routine,
                id: uniqueId,
                displayId: routine.id || routine.displayId || Date.now().toString(),
                createdAt: routine.createdAt || new Date().toISOString(),
                lastModified: new Date().toISOString()
            };
            
            hasChanges = true;
            console.log("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ç§»è¡Œå®Œäº†:", {
                name: routine.name,
                oldId: routine.id,
                newUniqueId: uniqueId,
                displayId: routines[i].displayId
            });
        }
    }
    
    if (hasChanges) {
        saveRoutines(user.id, routines);
        console.log("ç§»è¡Œå®Œäº† - ä¿å­˜ã•ã‚ŒãŸãƒ«ãƒ¼ãƒ†ã‚£ãƒ³:", routines.length, "ä»¶");
        
        // å®Œäº†ãƒ‡ãƒ¼ã‚¿ã‚‚ç§»è¡Œ
        migrateExistingCompletions();
    } else {
        console.log("ç§»è¡Œä¸è¦ - ã™ã¹ã¦ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯IDãŒè¨­å®šæ¸ˆã¿");
    }
}

// æ—¢å­˜å®Œäº†ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œæ©Ÿèƒ½
function migrateExistingCompletions() {
    const user = getCurrentUser();
    if (!user) return;
    
    const completions = getCompletions(user.id);
    const routines = getRoutines(user.id);
    let hasChanges = false;
    
    console.log("æ—¢å­˜å®Œäº†ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œé–‹å§‹:", completions.length, "ä»¶");
    
    for (let i = 0; i < completions.length; i++) {
        const completion = completions[i];
        
        // ãƒ¦ãƒ‹ãƒ¼ã‚¯IDãŒãªã„å ´åˆã€å¯¾å¿œã™ã‚‹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’æ¤œç´¢ã—ã¦è¨­å®š
        if (!completion.rid || completion.rid === completion.displayRid) {
            const routine = routines.find(r => 
                r.displayId === completion.rid || 
                r.id === completion.rid ||
                r.displayId === completion.displayRid
            );
            
            if (routine) {
                completions[i] = {
                    ...completion,
                    rid: routine.id,
                    displayRid: routine.displayId,
                    completedAt: completion.completedAt || new Date().toISOString()
                };
                
                hasChanges = true;
                console.log("å®Œäº†ãƒ‡ãƒ¼ã‚¿ç§»è¡Œå®Œäº†:", {
                    date: completion.date,
                    routineName: routine.name,
                    newRid: routine.id
                });
            }
        }
    }
    
    if (hasChanges) {
        saveCompletions(user.id, completions);
        console.log("å®Œäº†ãƒ‡ãƒ¼ã‚¿ç§»è¡Œå®Œäº† - ä¿å­˜ã•ã‚ŒãŸå®Œäº†ãƒ‡ãƒ¼ã‚¿:", completions.length, "ä»¶");
    } else {
        console.log("å®Œäº†ãƒ‡ãƒ¼ã‚¿ç§»è¡Œä¸è¦ - ã™ã¹ã¦ã®å®Œäº†ãƒ‡ãƒ¼ã‚¿ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯IDãŒè¨­å®šæ¸ˆã¿");
    }
}

// åˆæœŸåŒ–æ™‚ã«ç§»è¡Œã‚’å®Ÿè¡Œ
function runMigrationIfNeeded() {
    const user = getCurrentUser();
    if (!user) return;
    
    const routines = getRoutines(user.id);
    const needsMigration = routines.some(r => !r.id || r.id === r.displayId);
    
    if (needsMigration) {
        console.log("ç§»è¡ŒãŒå¿…è¦ãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’æ¤œå‡º");
        migrateExistingRoutines();
    } else {
        console.log("ç§»è¡Œä¸è¦ - ã™ã¹ã¦ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãŒæœ€æ–°å½¢å¼");
    }
}

// ä»Šæ—¥ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®æ©Ÿèƒ½
function addTodayTestRoutine() {
    const user = getCurrentUser();
    if (!user) {
        console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“");
        return;
    }
    
    const today = new Date();
    const todayDay = today.getDay();
    const todayDate = today.getDate();
    
    console.log("ä»Šæ—¥ã®ãƒ†ã‚¹ãƒˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’è¿½åŠ :", {
        today: todayDay,
        todayDate: todayDate,
        todayString: today.toLocaleDateString('ja-JP', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        })
    });
    
    const routines = getRoutines(user.id);
    
    // ä»Šæ—¥ã®æ›œæ—¥ã«åˆã‚ã›ãŸé€±æ¬¡ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’è¿½åŠ 
    const weeklyRoutine = {
        id: `${Date.now()}_weekly_test`,
        displayId: Date.now().toString(),
        name: `ä»Šæ—¥ã®é€±æ¬¡ãƒ†ã‚¹ãƒˆ (${todayDay}æ›œæ—¥)`,
        desc: "ä»Šæ—¥ã®æ›œæ—¥ã«è¨­å®šã•ã‚ŒãŸãƒ†ã‚¹ãƒˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³",
        frequency: "weekly",
        weeklyDays: [todayDay],
        monthlyDate: null,
        userId: user.id,
        createdAt: new Date().toISOString(),
        lastModified: new Date().toISOString()
    };
    
    // ä»Šæ—¥ã®æ—¥ä»˜ã«åˆã‚ã›ãŸæœˆæ¬¡ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’è¿½åŠ 
    const monthlyRoutine = {
        id: `${Date.now()}_monthly_test`,
        displayId: (Date.now() + 1).toString(),
        name: `ä»Šæ—¥ã®æœˆæ¬¡ãƒ†ã‚¹ãƒˆ (${todayDate}æ—¥)`,
        desc: "ä»Šæ—¥ã®æ—¥ä»˜ã«è¨­å®šã•ã‚ŒãŸãƒ†ã‚¹ãƒˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³",
        frequency: "monthly",
        weeklyDays: [],
        monthlyDate: todayDate,
        userId: user.id,
        createdAt: new Date().toISOString(),
        lastModified: new Date().toISOString()
    };
    
    // æ¯æ—¥ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’è¿½åŠ 
    const dailyRoutine = {
        id: `${Date.now()}_daily_test`,
        displayId: (Date.now() + 2).toString(),
        name: "ä»Šæ—¥ã®æ¯æ—¥ãƒ†ã‚¹ãƒˆ",
        desc: "æ¯æ—¥å®Ÿè¡Œã•ã‚Œã‚‹ãƒ†ã‚¹ãƒˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³",
        frequency: "daily",
        weeklyDays: [],
        monthlyDate: null,
        userId: user.id,
        createdAt: new Date().toISOString(),
        lastModified: new Date().toISOString()
    };
    
    routines.push(weeklyRoutine, monthlyRoutine, dailyRoutine);
    saveRoutines(user.id, routines);
    
    console.log("ãƒ†ã‚¹ãƒˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¿½åŠ å®Œäº†:", {
        weekly: weeklyRoutine.name,
        monthly: monthlyRoutine.name,
        daily: dailyRoutine.name
    });
    
    // ç”»é¢ã‚’å†æç”»
    renderMain();
}

// ãƒ†ã‚¹ãƒˆç”¨ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
function addTestButton() {
    const mainView = $('mainView');
    if (!mainView) return;
    
    // æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
    const existingTestBtn = document.querySelector('#testButton');
    if (existingTestBtn) {
        existingTestBtn.remove();
    }
    
    const testButton = document.createElement('button');
    testButton.id = 'testButton';
    testButton.textContent = 'ãƒ†ã‚¹ãƒˆè¿½åŠ ';
    testButton.className = 'secondary';
    testButton.style.marginLeft = '8px';
    testButton.onclick = () => {
        addTodayTestRoutine();
    };
    
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã®æ¨ªã«ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    const logoutBtn = $('logoutBtn');
    if (logoutBtn && logoutBtn.parentNode) {
        logoutBtn.parentNode.appendChild(testButton);
    }
}

// ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³å‰Šé™¤ã®UIå‡¦ç†
function deleteRoutineFromUI(uniqueId) {
    const routine = findRoutineById(uniqueId);
    if (!routine) {
        console.error("å‰Šé™¤å¯¾è±¡ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", uniqueId);
        alert("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        return;
    }
    
    console.log("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³å‰Šé™¤ç¢ºèª:", {
        uniqueId: routine.id,
        name: routine.name,
        frequency: routine.frequency
    });
    
    // å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    const confirmMessage = `ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã€Œ${routine.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`;
    if (!confirm(confirmMessage)) {
        console.log("å‰Šé™¤ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ");
        return;
    }
    
    // å‰Šé™¤å®Ÿè¡Œ
    const success = deleteRoutine(uniqueId);
    if (success) {
        console.log("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³å‰Šé™¤å®Œäº†:", routine.name);
        alert(`ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã€Œ${routine.name}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        
        // ç”»é¢ã‚’å†æç”»
        renderMain();
        
        // è‡ªå‹•åŒæœŸ
        if (currentStorage === 'firebase') {
            syncToFirebase();
        }
    } else {
        console.error("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
        alert("ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
}

// è¤‡æ•°ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã®ä¸€æ‹¬å‰Šé™¤æ©Ÿèƒ½
function deleteMultipleRoutines(routineIds) {
    if (!Array.isArray(routineIds) || routineIds.length === 0) {
        console.error("å‰Šé™¤å¯¾è±¡ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
        return;
    }
    
    console.log("è¤‡æ•°ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³å‰Šé™¤é–‹å§‹:", routineIds.length, "ä»¶");
    
    const routines = routineIds.map(id => findRoutineById(id)).filter(r => r !== null);
    if (routines.length === 0) {
        alert("å‰Šé™¤å¯¾è±¡ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        return;
    }
    
    // å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    const routineNames = routines.map(r => r.name).join("\nâ€¢ ");
    const confirmMessage = `ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâ€¢ ${routineNames}\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`;
    if (!confirm(confirmMessage)) {
        console.log("ä¸€æ‹¬å‰Šé™¤ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ");
        return;
    }
    
    // å‰Šé™¤å®Ÿè¡Œ
    let successCount = 0;
    for (const routine of routines) {
        const success = deleteRoutine(routine.id);
        if (success) {
            successCount++;
        }
    }
    
    console.log("ä¸€æ‹¬å‰Šé™¤å®Œäº†:", successCount, "/", routines.length, "ä»¶");
    alert(`${successCount}ä»¶ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
    
    // ç”»é¢ã‚’å†æç”»
    renderMain();
    
    // è‡ªå‹•åŒæœŸ
    if (currentStorage === 'firebase') {
        syncToFirebase();
    }
}

// å®Œäº†ãƒ‡ãƒ¼ã‚¿ã®ä¸€æ‹¬å‰Šé™¤æ©Ÿèƒ½
function deleteAllCompletions() {
    const user = getCurrentUser();
    if (!user) {
        console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“");
        return;
    }
    
    const completions = getCompletions(user.id);
    if (completions.length === 0) {
        alert("å‰Šé™¤ã™ã‚‹å®Œäº†ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
        return;
    }
    
    const confirmMessage = `ã™ã¹ã¦ã®å®Œäº†ãƒ‡ãƒ¼ã‚¿ï¼ˆ${completions.length}ä»¶ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`;
    if (!confirm(confirmMessage)) {
        console.log("å®Œäº†ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ");
        return;
    }
    
    // å®Œäº†ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
    saveCompletions(user.id, []);
    console.log("å®Œäº†ãƒ‡ãƒ¼ã‚¿å‰Šé™¤å®Œäº†:", completions.length, "ä»¶");
    alert(`${completions.length}ä»¶ã®å®Œäº†ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
    
    // ç”»é¢ã‚’å†æç”»
    renderMain();
    
    // è‡ªå‹•åŒæœŸ
    if (currentStorage === 'firebase') {
        syncToFirebase();
    }
}

// ç®¡ç†æ©Ÿèƒ½ç”¨ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
function addManagementButtons() {
    const mainView = $('mainView');
    if (!mainView) return;
    
    // æ—¢å­˜ã®ç®¡ç†ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
    const existingManageBtn = document.querySelector('#manageButton');
    if (existingManageBtn) {
        existingManageBtn.remove();
    }
    
    const manageButton = document.createElement('button');
    manageButton.id = 'manageButton';
    manageButton.textContent = 'ç®¡ç†';
    manageButton.className = 'secondary';
    manageButton.style.marginLeft = '8px';
    manageButton.onclick = () => {
        showManagementMenu();
    };
    
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã®æ¨ªã«ç®¡ç†ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    const logoutBtn = $('logoutBtn');
    if (logoutBtn && logoutBtn.parentNode) {
        logoutBtn.parentNode.appendChild(manageButton);
    }
}

// ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤º
function showManagementMenu() {
    const user = getCurrentUser();
    if (!user) return;
    
    const routines = getRoutines(user.id);
    const completions = getCompletions(user.id);
    
    const menuItems = [
        `ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ç®¡ç† (${routines.length}ä»¶)`,
        `å®Œäº†ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ (${completions.length}ä»¶)`,
        'ãƒ†ã‚¹ãƒˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³å‰Šé™¤',
        'å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ',
        'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
    ];
    
    const selected = prompt(
        'ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼\n\n' + 
        menuItems.map((item, index) => `${index + 1}. ${item}`).join('\n') +
        '\n\nç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:'
    );
    
    if (!selected) return;
    
    const choice = parseInt(selected);
    switch (choice) {
        case 1:
            showRoutineManagement();
            break;
        case 2:
            deleteAllCompletions();
            break;
        case 3:
            deleteTestRoutines();
            break;
        case 4:
            resetAllData();
            break;
        case 5:
            console.log('ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
            break;
        default:
            alert('ç„¡åŠ¹ãªé¸æŠã§ã™');
    }
}

// ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ç®¡ç†ç”»é¢
function showRoutineManagement() {
    const user = getCurrentUser();
    if (!user) return;
    
    const routines = getRoutines(user.id);
    if (routines.length === 0) {
        alert('ç®¡ç†ã™ã‚‹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
    }
    
    const routineList = routines.map((r, index) => 
        `${index + 1}. ${r.name} (${getFreqText(r.frequency)})`
    ).join('\n');
    
    const selected = prompt(
        'ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ç®¡ç†\n\n' + 
        routineList +
        '\n\nå‰Šé™¤ã™ã‚‹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã®ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆè¤‡æ•°ã®å ´åˆã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰:\n' +
        'ä¾‹: 1,3,5'
    );
    
    if (!selected) return;
    
    const indices = selected.split(',').map(s => parseInt(s.trim()) - 1).filter(i => !isNaN(i) && i >= 0 && i < routines.length);
    
    if (indices.length === 0) {
        alert('æœ‰åŠ¹ãªç•ªå·ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
    }
    
    const selectedRoutines = indices.map(i => routines[i]);
    const routineIds = selectedRoutines.map(r => r.id);
    
    deleteMultipleRoutines(routineIds);
}

// ãƒ†ã‚¹ãƒˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã®å‰Šé™¤
function deleteTestRoutines() {
    const user = getCurrentUser();
    if (!user) return;
    
    const routines = getRoutines(user.id);
    const testRoutines = routines.filter(r => 
        r.name.includes('ãƒ†ã‚¹ãƒˆ') || 
        r.name.includes('test') ||
        r.id.includes('_test')
    );
    
    if (testRoutines.length === 0) {
        alert('å‰Šé™¤ã™ã‚‹ãƒ†ã‚¹ãƒˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
    }
    
    const routineIds = testRoutines.map(r => r.id);
    deleteMultipleRoutines(routineIds);
}

// å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
function resetAllData() {
    const user = getCurrentUser();
    if (!user) return;
    
    const confirmMessage = `ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\n\nâ€¢ ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³: ${getRoutines(user.id).length}ä»¶\nâ€¢ å®Œäº†ãƒ‡ãƒ¼ã‚¿: ${getCompletions(user.id).length}ä»¶`;
    if (!confirm(confirmMessage)) {
        console.log('ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
        return;
    }
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
    saveRoutines(user.id, []);
    saveCompletions(user.id, []);
    
    console.log('å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆå®Œäº†');
    alert('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
    
    // ç”»é¢ã‚’å†æç”»
    renderMain();
    
    // è‡ªå‹•åŒæœŸ
    if (currentStorage === 'firebase') {
        syncToFirebase();
    }
}
</script>
</body>
</html>
